# Архитектура веб-приложения «Союзлифт Аудит»

## 1. Контекст и цели

Веб-приложение заменяет бумажные чек-листы, используемые аудиторами лифтовой компании «Союзлифт» (г. Томск). Решение должно
работать на обычном хостинге без Docker и облачных сервисов, быть готовым к локальному запуску и поддерживать офлайн-режим
для аудиторов, работающих вне сети. Система обслуживает две роли:

* **Аудиторы** — проводят проверки, заполняют чек-листы, фиксируют баллы, комментарии и фотографии.
* **Администраторы** — управляют справочниками и пользователями, назначают аудиты, просматривают результаты и отчёты.

Первая версия сосредоточена на корректном заполнении чек-листа, надёжном хранении данных и удобстве работы без аналитики и
сложной автоматизации.

## 2. Технологический стек и ограничения

| Компонент | Выбор | Назначение |
|-----------|-------|------------|
| Backend | **Python 3.11 + Django 5.x** | ORM, встроенная админка, серверные шаблоны, лёгкий REST API для офлайн-синхронизации. |
| Frontend | **Django Templates + Tailwind CSS + Alpine.js/HTMX точечно** | Формы, таблицы, динамические элементы без SPA и сложных сборок. |
| Хранение данных | **SQLite** | Файл базы в пределах проекта, не требует отдельного сервера, подходит для обычного хостинга. |
| Медиа-файлы | **Локальная файловая система** | Фото и вложения сохраняются на том же хостинге, структура папок по аудитам. |
| Статика | **Django staticfiles + WhiteNoise** | Подача CSS/JS из приложения без внешнего CDN. |
| Аутентификация | Django auth (логин/пароль) | Разграничение прав между администраторами и аудиторами. |
| Тестирование | `pytest`/`manage.py test`, `pytest-django` | Локальные проверки без Docker и CI. |

**Запрещено**: Docker/Compose, Kubernetes, Celery, Redis, S3/MinIO и другие облачные сервисы. Приложение разворачивается как
обычная Django-сайт службой `gunicorn`/`uWSGI` под управлением `systemd` (или аналогичного механизма) совместно с Nginx/Apache.

## 3. Окружения и локальный запуск

Локальный запуск нужен администраторам и аудиторам для тестирования и демонстрации.

1. Установить зависимости: `python -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt`.
2. Применить миграции: `python manage.py migrate` (SQLite-файл создаётся автоматически).
3. Загрузить справочник вопросов: `python manage.py import_checklist data.csv` или через административный интерфейс.
4. Создать суперпользователя: `python manage.py createsuperuser`.
5. Запустить сервер: `python manage.py runserver`.

Тесты выполняются командами `pytest` или `python manage.py test`. Tailwind подключается заранее собранным CSS-файлом, поэтому
фоновый watcher не требуется.

## 4. Архитектурные компоненты

### 4.1. Пользовательский слой

* **Портал аудитора** — список назначенных аудитов, форма информационной карты объекта, заполнение чек-листа, просмотр истории.
* **Портал администратора** — управление справочниками, пользователями, адресами лифтов и аудитов, просмотр итогов.
* **Tailwind-компоненты** обеспечивают единый UI, а Alpine.js/HTMX добавляет небольшие интерактивные элементы (аккордеоны,
  предпросмотр загружаемых фото, индикаторы синхронизации).

### 4.2. Серверный слой (Django)

* **Приложение `accounts`** — расширение модели пользователя (роль, профиль, отметка смены пароля), управление выдачей и
  сбросом паролей.
* **Приложение `catalog`** — справочник объектов, лифтов, категорий, уровней, параметров и критериев.
* **Приложение `audits`** — создание и ведение аудитов, ответы на вопросы, хранение комментариев, вложений и статусов.
* **Модуль офлайн-синхронизации** — REST-эндпоинт `/api/offline-sync/`, принимающий пакеты данных и вложений.

### 4.3. Интеграционный слой

* **Импорт из CSV** (`data.csv`) для заполнения справочника вопросов и шкал оценивания.
* **Экспорт отчётов** — HTML-страница для печати и формирование PDF (через `weasyprint` или аналог).

### 4.4. Инфраструктурный слой

* Приложение обслуживается `gunicorn`/`uWSGI` за Nginx/Apache на виртуальном хостинге.
* Логирование через стандартный Django logging с ротацией файлов (`RotatingFileHandler`).
* Регулярное резервное копирование SQLite-файла и каталога медиа (скрипты cron).
* Мониторинг состояния приложений и места на диске простыми системными инструментами (например, `logwatch`, `monit`).

## 5. Модель данных

### 5.1. Пользователи и права

* `User` (стандартная модель Django) + профиль с полями: `full_name`, `role` (`AUDITOR`, `ADMIN`), `phone`, `employee_id`,
  `password_changed_at`, `is_active`.
* Администратор управляет учётными записями аудиторов: создаёт, активирует/блокирует, сбрасывает пароли.
* Аудитор может менять только собственный пароль; при первом входе система требует задать новый пароль.

### 5.2. Справочник объектов и лифтов

* `Building`: `address` (улица, дом), `entrance`, `notes`.
* `Elevator`: `building` (FK), `identifier` (номер/серийный), `description`, `status`.
* Адреса и конкретные лифты создаются администратором заранее, чтобы аудитор выбирал объект из списка.

### 5.3. Справочник чек-листа

* `ChecklistCategory`: `code`, `name`, `order`.
* `ChecklistSection`: `category` (FK), `title`, `order`, `description` (уровни/параметры).
* `ChecklistQuestion`: `section` (FK), `text`, `max_score`, `order`, `guideline` (критерии).
* `ScoreOption`: `question` (FK), `score`, `description` — фиксированные варианты ответов.

### 5.4. Проведение аудита

* `Audit`: `elevator` (FK), `object_info` (JSON/текст формы), `planned_date`, `started_at`, `finished_at`, `status`, `assigned_to`
  (FK), `created_by`, `total_score`, `comment_count`, `photo_count`.
* `AuditResponse`: `audit` (FK), `question` (FK), `score`, `comment`, `is_flagged`, `is_offline_cached`.
* `AuditAttachment`: `response` (FK), `file` (ImageField), `caption`, `offline_uuid`; ограничение на уровне модели — не более
  10 вложений на вопрос.
* `AuditSignature` (опционально): `audit` (FK), `signed_by`, `signature_image`, `signed_at`.

### 5.5. История и синхронизация

* `QuestionVersion`: `question`, `version_number`, `text`, `max_score`, `effective_from`, `effective_to`, `created_by`.
* `AuditLogEntry`: `user`, `action`, `entity_type`, `entity_id`, `payload`, `created_at`.
* `OfflineSyncBatch`: `user` (FK), `device_id`, `created_at`, `payload` (JSON), `status` (`pending`, `applied`, `error`),
  `error_details`.

## 6. Офлайн-режим и синхронизация

1. **Кэширование интерфейса.** Сервис-воркер (PWA-lite) кэширует ключевые страницы и статику, что позволяет открыть форму
   аудита без сети.
2. **Локальное хранение данных.** Ответы, комментарии и до 10 фотографий на вопрос сохраняются в IndexedDB (`offline_responses`
   и `offline_attachments`). Фото и метаданные связываются через временные UUID.
3. **Синхронизация.** При восстановлении соединения клиент отправляет пакет на `/api/offline-sync/`. Сервер транзакционно
   создаёт/обновляет `Audit`, `AuditResponse`, `AuditAttachment`, фиксирует результаты в `OfflineSyncBatch` и возвращает
   подтверждение с фактическими ID записей.
4. **Обработка ошибок.** Если данные изменить не удалось (например, конфликт версий), `OfflineSyncBatch` помечается как
   `error`, клиент показывает список проблемных вопросов и предлагает пользователю синхронизировать вручную.
5. **Повторная отправка.** Пользователь может инициировать синхронизацию кнопкой «Отправить данные», если автоматическая
   фоновая попытка не удалась.

## 7. Основные пользовательские сценарии

### 7.1. Аутентификация и управление пользователями

* Используется стандартный `LoginView` Django с сессиями; внешние провайдеры не подключаются.
* Администратор создаёт учётную запись аудитора с временным паролем и передаёт его безопасным способом.
* При первом входе аудитор обязан сменить пароль; при необходимости администратор принудительно сбрасывает пароль и
  деактивирует пользователя.

### 7.2. Работа аудитора

1. Входит в систему и видит раздел «Мои аудиты» со статусами и фильтрами.
2. Начинает аудит, заполняет информационную форму об объекте (данные дополняют сведения из справочника).
3. Система автоматически фиксирует дату и время начала/завершения проверки.
4. Аудитор выбирает балл по каждому вопросу и может добавить комментарий и до 10 фотографий независимо от балла; при снижении
   балла комментарий становится обязательным.
5. Процесс сохраняется в черновик даже без сети благодаря локальному хранилищу.
6. После завершения аудитор отправляет данные; при отсутствии интернета ответ ставится в очередь синхронизации.
7. После успешной отправки отображается сводка по баллам, комментариям и вложениям.

### 7.3. Работа администратора

1. Управляет справочниками: категории, уровни, параметры, критерии, максимальные баллы.
2. Заносит адреса зданий и лифтов (улица, дом, подъезд, конкретный лифт), назначает аудиты аудиторам.
3. Создаёт и поддерживает учётные записи аудиторов, сбрасывает пароли.
4. Просматривает завершённые аудиты: дата, адрес объекта, суммарный балл, количество комментариев и фото.
5. При необходимости возвращает аудит на доработку или утверждает результат.

## 8. Административный интерфейс и отчёты

* Основа — расширенная Django Admin с кастомными страницами и формами.
* Мастер импорта `data.csv` показывает предпросмотр изменений и историю версий.
* Карточка аудита отображает информацию об объекте, чек-лист с комментариями, количество и миниатюры фото.
* Отчёт доступен в HTML (режим печати) и PDF, без дополнительной аналитики; экспорт CSV можно добавить в последующих версиях.
* Администраторы видят сводный список аудитов с быстрыми фильтрами, аудиторы — только собственные результаты.

## 9. Бизнес-логика и правила

* **Статусы аудита:** `planned`, `in_progress`, `submitted`, `needs_revision`, `approved`.
* **Расчёт итогов:** суммарный балл = сумма выбранных `score`; обновляется при каждом сохранении. Количество комментариев и фото
  считается автоматически.
* **Валидация:** выбранный балл должен существовать в `ScoreOption`; комментарий обязателен при неполном балле; вложений на
  вопрос не более 10.
* **Уведомления:** простые email-уведомления через `django.core.mail` (синхронно или через cron-скрипт `manage.py
  send_mail_queue`), без Celery/Redis.
* **Журналирование:** ключевые операции записываются в `AuditLogEntry`.

## 10. Импорт данных из CSV

1. Администратор загружает `data.csv` через UI или запускает команду `manage.py import_checklist`.
2. Парсер читает поля «Категория», «Уровень», «Параметры», «Критерии», «Максимальный балл», шкалу «Результат».
3. Система создаёт или обновляет `ChecklistCategory`, `ChecklistSection`, `ChecklistQuestion`, `ScoreOption`.
4. Предоставляется режим предварительного просмотра изменений и протокол импорта.
5. Результат логируется и (опционально) дублируется письмом администратору.

## 11. Безопасность и права доступа

* Разграничение доступа: декораторы/миксин `@auditor_required`, `@admin_required` и фильтрация queryset по пользователю.
* Доступ к медиа-файлам ограничен: выдача через авторизованный контроллер, файлы хранятся в недоступной из веба директории и
  выдаются по защищённым URL.
* Хранение паролей — стандартный Django hash, обязательное использование HTTPS на продакшене.
* Регулярный аудит журналов изменений и резервное копирование базы и медиа (`manage.py dumpdata` + `rsync` или аналог).

## 12. Развёртывание и обслуживание

* **Dev**: локальная машина, SQLite, запуск `runserver`, ручная сборка Tailwind (`npm run build:css`) при изменении дизайна.
* **Prod**: виртуальный хостинг с Nginx + gunicorn, SQLite на SSD-диске, каталоги `media/` и `static/` на том же сервере,
  резервное копирование через cron. Обновление выполняется `git pull` + `pip install -r requirements.txt` + `python manage.py
  migrate` + перезапуск службы.
* Поддерживающие скрипты: `manage.py clearsessions`, проверка целостности вложений, мониторинг свободного места.

## 13. План развития (после первой итерации)

* Расширенный PWA-клиент с улучшенной офлайн-работой и push-уведомлениями.
* Статистические отчёты и дешборды по объектам и категориям.
* Интеграция с внешними системами диспетчеризации лифтов и экспортом в сторонние форматы.
* Автоматизированные тесты UI и мобильное приложение при необходимости.
