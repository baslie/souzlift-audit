# Архитектура веб-приложения «Союзлифт Аудит»

## 1. Контекст и цели

Веб-приложение предназначено для замены бумажных чек-листов, используемых
аудиторами лифтовой компании «Союзлифт» (г. Томск). Система должна поддерживать
две роли пользователей:

* **Аудиторы** — проходят по объектам, заполняют чек-листы, выставляют баллы,
  фиксируют нарушения с комментариями и фотографиями.
* **Администраторы** — управляют справочником вопросов, контролируют работу
  аудиторов, просматривают и утверждают отчёты.

Первая итерация нацелена на фиксирование результатов аудита и хранение
электронных отчётов без аналитики и агрегированных метрик.

## 2. Технологический стек

| Компонент | Выбор | Назначение |
|-----------|-------|------------|
| Backend | **Python 3.11 + Django 5.x** | ORM, аутентификация, админка, REST + серверные шаблоны.
| Frontend | **Django Templates + HTMX (опционально) + Tailwind CSS** | Лёгкий UI без SPA, использование Tailwind CLI/JIT для стилизации.
| Хранение данных | **PostgreSQL** | Надёжное хранение структурированных данных и JSON.
| Файловое хранилище | **S3-совместимое** (MinIO/Яндекс) или локально (для пилота) | Фото и вложения.
| Хранение статических файлов | **Whitenoise** (dev) / CDN (prod) | Поставка статики и Tailwind CSS.
| Аутентификация | Django auth + role-based permissions | Управление доступом (аудитор/администратор).
| CI/CD | GitHub Actions (линтинг, тесты) | Проверка качества.

## 3. Архитектурные компоненты

### 3.1. Пользовательский слой

* **UI порталы**
  * Аудиторский портал: список назначенных объектов, форма чек-листа, просмотр истории.
  * Администраторский портал: управление справочниками (категории, вопросы, варианты ответов), просмотр и экспорт отчётов.
* **Tailwind дизайн-система** — набор готовых компонентов (карточки, таблицы, формы), обеспечивающих единообразие интерфейса.

### 3.2. Серверный слой (Django)

* **Приложение `accounts`**: расширение модели пользователя (профиль, роль, принадлежность к подразделению), управление доступами.
* **Приложение `catalog`**: управление справочником объектов и вопросов (категории, сами вопросы, шкалы оценивания, вложенные критерии).
* **Приложение `audits`**: создание аудитов, хранение заполненных чек-листов, файлов, статусов.
* **Приложение `attachments`** (опционально отдельное) или модуль в `audits` — загрузка фотографий и файлов.

### 3.3. Интеграционный слой

* **CSV-импорт вопросов** — загрузка файла `data.csv` для инициализации базы вопросов и шкал оценивания.
* **Экспорт отчётов** — генерация PDF/Excel (после первой итерации можно ограничиться HTML-печатью).

### 3.4. Инфраструктурный слой

* Docker-контейнеры: `web`, `db`, `minio` (для медиа), `tailwind` (watcher).
* Настройка `tailwind.config.js` с кастомной палитрой и плагинами для форм.
* Система логирования (Django logging + Sentry для ошибок).

## 4. Модель данных

### 4.1. Пользователи и доступы

* `User` (стандартная модель) + `UserProfile`
  * Поля: `full_name`, `role` (enum: `AUDITOR`, `ADMIN`), `phone`, `employee_id`, `is_active`.
  * Связи: `assigned_regions` (многие-ко-многим к `Region`).
* `Region` — территориальные зоны/районы обслуживания.

### 4.2. Справочник объектов и лифтов

* `Building`
  * Поля: `address`, `year_built`, `management_company`, `notes`.
* `Elevator`
  * Поля: `building` (FK), `serial_number`, `manufacturer`, `installation_date`, `last_service_date`, `status`.
  * Используется для назначения аудита на конкретный лифт.

### 4.3. Справочник вопросов (из `data.csv`)

* `ChecklistCategory`
  * Поля: `code` (буквенные категории из CSV), `name`, `order`.
* `ChecklistSection`
  * Поля: `category` (FK), `title`, `order`, `description`.
  * Соответствует столбцам «Уровень»/«Параметры».
* `ChecklistQuestion`
  * Поля: `section` (FK), `text`, `max_score`, `order`, `guideline` (текст из «Критерии»).
* `ScoreOption`
  * Поля: `question` (FK), `score`, `description`.
  * Содержит интерпретацию значений (например 0, 1, 2 балла) из CSV.

### 4.4. Проведение аудита

* `Audit`
  * Поля: `elevator` (FK), `scheduled_date`, `actual_date`, `status` (planned/in_progress/completed/approved), `assigned_to` (FK на `User`), `created_by`, `notes`.
* `AuditResponse`
  * Поля: `audit` (FK), `question` (FK), `score`, `comment`, `is_flagged`.
  * Бизнес-правило: `score` ≤ `question.max_score`.
* `AuditAttachment`
  * Поля: `response` (FK), `file` (ImageField/FileField), `caption`.
* `AuditSignature`
  * Поля: `audit` (FK), `signed_by`, `signature_image`, `signed_at` (опционально).

### 4.5. История и конфигурация

* `QuestionVersion`
  * Поля: `question`, `version_number`, `text`, `max_score`, `effective_from`, `effective_to`, `created_by`.
  * Позволяет отслеживать изменения вопросов администраторами.
* `AuditLogEntry`
  * Поля: `user`, `action`, `entity_type`, `entity_id`, `payload`, `created_at`.

## 5. Основные пользовательские сценарии

### 5.1. Аутентификация

* Django `LoginView` + сессии. Tailwind формы. Опционально поддержка SSO в будущем.

### 5.2. Работа аудитора

1. Заходит в систему, видит дашборд «Мои аудиты».
2. Выбирает аудит → открывается форма чек-листа.
3. Для каждого вопроса выбирает балл (радиокнопки/селект) и при необходимости добавляет комментарий или фото.
4. Указывает общие замечания и завершает аудит (статус `completed`).
5. Система вычисляет суммарный балл, определяет нарушения (если балл < max).

### 5.3. Работа администратора

1. Управляет справочником вопросов: создаёт/редактирует категории, секции, вопросы и шкалы баллов.
2. Назначает аудиты аудиторам, выбирая лифт и дату.
3. Просматривает завершённые аудиты: видит баллы по категориям, прикреплённые фото, комментарии.
4. Может вернуть аудит на доработку (статус `in_review` → `needs_revision`).
5. Утверждает отчёты, после чего они становятся доступными для выгрузки.

## 6. Пользовательские интерфейсы

### 6.1. Навигация

* Верхнее меню с логотипом, переключением ролей (если у пользователя несколько).
* Сайдбар с разделами: «Мои аудиты», «План», «Справочники», «Настройки».

### 6.2. Страницы аудитора

* **Список аудитов** — таблица с фильтрами по статусу/дате/адресу, теги статусов.
* **Форма аудита**
  * Хлебные крошки: Объект → Лифт → Чек-лист.
  * Группировка вопросов по категориям (аккордеоны).
  * Для каждого вопроса: текст, критерии (всплывающая подсказка), варианты баллов (radio), поле комментария, кнопка загрузки фото.
  * Кнопки «Сохранить черновик» и «Отправить на проверку».
* **Просмотр отчёта** — список ответов, фото, итоговые баллы.

### 6.3. Страницы администратора

* **Дашборд** — список последних аудитов, статусы, фильтры.
* **Редактор чек-листа**
  * Дерево категорий и вопросов, inline-редактирование текста, критериев, максимальных баллов.
  * Импорт из CSV (форма загрузки) с визуализацией изменений.
* **Назначение аудита** — форма выбора лифта, даты, аудитора.
* **Просмотр отчёта** — табличный вид, возможность выгрузки PDF/Excel.

## 7. Бизнес-логика и правила

* **Валидация баллов**: при сохранении ответа проверять, что выбранный балл присутствует в `ScoreOption`. При сниженных баллах (менее максимума) поле комментария становится обязательным.
* **Статусы аудита**:
  * `planned` — создан администратором.
  * `in_progress` — аудитор начал заполнять.
  * `submitted` — аудитор завершил, отправил на проверку.
  * `needs_revision` — администратор вернул на доработку (указывается причина).
  * `approved` — администратор утвердил.
* **Распределение задач**: аудитору отображаются только назначенные аудиты в статусах `planned`/`needs_revision`.
* **Расчёт итогов**: суммарный балл по аудиту = сумма выбранных баллов; дополнительно вычисляются проценты по категориям.
* **Уведомления**: email/Telegram (через Celery) при назначении аудита, отправке отчёта, необходимости доработки.
* **Версионирование вопросов**: при изменении вопроса создаётся новая версия, старая помечается `effective_to`, активные аудиты продолжают использовать версию, актуальную на момент создания.

## 8. Импорт данных из CSV

1. Администратор загружает `data.csv` через UI или команду управления (`manage.py import_checklist`).
2. Парсер читает колонки: `Категория`, `Уровень`, `Параметры`, `Критерии`, `Максимальный балл`, шкалы из `Результат`.
3. Система создаёт/обновляет `ChecklistCategory`, `ChecklistSection`, `ChecklistQuestion` и `ScoreOption`.
4. Поддержка dry-run режима: предварительный просмотр диффа.
5. Логирование результатов импорта, отправка уведомления администратору.

## 9. Безопасность и права доступа

* Авторизация через `django.contrib.auth` + кастомные декораторы (`@auditor_required`, `@admin_required`).
* Ограничение доступа к медиа-файлам: приватные URL, выдача через авторизованный контроллер.
* Фильтрация данных по пользователю (ORM-level фильтры).
* Журналирование действий в `AuditLogEntry`.
* Поддержка резервного копирования БД и медиа.

## 10. Развёртывание и окружения

* **Dev**: Docker Compose, SQLite/PostgreSQL, локальный Tailwind watcher.
* **Staging/Prod**: Kubernetes или Docker Swarm, PostgreSQL с резервированием, MinIO/S3, Celery worker + Redis для фоновых задач (уведомления, генерация отчётов).
* CI/CD: lint (ruff), тесты (pytest), сборка Tailwind, прогон миграций.

## 11. План развития (после первой итерации)

* Аналитические отчёты и дешборды (метрики по объектам/категориям).
* Мобильное PWA с офлайн-режимом.
* Интеграция с системами диспетчеризации лифтов.
* Расширенная система уведомлений и SLA.

