# Запуск окружения разработки на Windows

Документ описывает последовательность действий для запуска сайта «Союзлифт Аудит» в режиме разработки на Windows 10/11. Инструкция рассчитана на разработчиков и тестировщиков, которым требуется локально воспроизвести проект, выполнить автоматические проверки и исследовать возможные ошибки.

## 1. Предварительные требования

| Компонент | Версия/примечания |
|-----------|-------------------|
| Windows   | 10 или 11 (64-bit) |
| Python    | 3.11.x с установленным флажком *Add python.exe to PATH* |
| Git       | Актуальная версия из [git-scm.com](https://git-scm.com/download/win) |
| PowerShell| 5.1+ (по умолчанию в системе) |
| Node.js   | (опционально) 18 LTS для пересборки Tailwind |

> **Совет:** если установлены WSL2 или Windows Terminal, ими можно заменить встроенный PowerShell. Команды останутся теми же.

## 2. Клонирование проекта

Откройте PowerShell и выполните команды:

```powershell
Set-Location C:\Work\Projects           # выберите удобный каталог
git clone <URL_вашего_репозитория>
Set-Location souzlift-audit
```

При необходимости используйте SSH-URL репозитория.

## 3. Разрешение запуска локальных скриптов

Один раз разрешите выполнение локальных скриптов PowerShell (требуется для активации виртуального окружения):

```powershell
Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned
```

## 4. Создание и активация виртуального окружения

```powershell
py -3.11 -m venv .venv
.\.venv\Scripts\Activate.ps1
python -m pip install --upgrade pip
pip install -r requirements.txt
```

Если установка `Pillow` завершается ошибкой компиляции, установите [Microsoft C++ Build Tools](https://visualstudio.microsoft.com/visual-cpp-build-tools/) и повторите команду `pip install`.

## 5. Настройка переменных окружения

Для разработки достаточно указать минимальный набор переменных в текущей сессии PowerShell:

```powershell
$env:DJANGO_ENV = "dev"
$env:DJANGO_SECRET_KEY = "dev-secret-key"
$env:DJANGO_ALLOWED_HOSTS = "localhost,127.0.0.1"
```

Дополнительно, при тестировании интеграций можно задать параметры почты (`DJANGO_EMAIL_*`) или файлы логов (`DJANGO_LOG_*`). Чтобы сохранить настройки между сессиями, используйте `setx` или файл `.env` (при добавлении поддержки через `python-dotenv`).

## 6. Инициализация базы данных и суперпользователя

Команды Django выполняйте из каталога `backend`:

```powershell
Set-Location backend
python manage.py migrate
python manage.py createsuperuser  # при необходимости доступа в админку
```

База данных SQLite создастся автоматически в `backend/db/`.

> **Важно:** профиль создаваемого пользователя получает роль «Аудитор». Чтобы
> увидеть административные разделы пользовательского интерфейса, зайдите в
> панель администратора по адресу <http://127.0.0.1:8000/admin/>, откройте свой
> профиль (`Accounts → User profiles`) и смените значение поля «Роль» на
> «Администратор». После сохранения учетной записи страницы каталога и
> модерации станут доступны.

## 7. Запуск сервера разработки

```powershell
python manage.py runserver
```

Сайт будет доступен по адресу <http://127.0.0.1:8000/>. Если порт занят, укажите другой порт: `python manage.py runserver 127.0.0.1:8001`.

Во время отладки держите окно PowerShell открытым, чтобы видеть вывод логов. Для параллельного запуска тестов откройте вторую вкладку/окно и повторно активируйте виртуальное окружение (`.\.venv\Scripts\Activate.ps1`).

## 8. Автоматические проверки

Для запуска проверок откройте новое окно PowerShell, перейдите в корень репозитория и активируйте виртуальное окружение:

```powershell
Set-Location C:\Work\Projects\souzlift-audit   # замените на фактический путь к проекту
.\.venv\Scripts\Activate.ps1
```

Затем выполните базовые проверки качества:

```powershell
python backend/manage.py check  # встроенные проверки Django
pytest                          # модульные и интеграционные тесты
ruff check backend/             # линтер Python-кода
```

При необходимости можно ограничить набор тестов: `pytest -m "not slow"` или `pytest backend/tests/test_accounts.py`.

## 9. Работа со статикой и Tailwind (опционально)

Для пересборки CSS установите Tailwind CLI:

```powershell
npm install --global tailwindcss
tailwindcss -i backend/static/css/tailwind.src.css -o backend/static/css/tailwind.min.css --minify
```

При отсутствии Node.js скачайте standalone-бинарь Tailwind и замените команду на запуск соответствующего `.exe`.

## 10. Распространённые проблемы

| Симптом | Решение |
|---------|---------|
| **Ошибка `django.core.exceptions.ImproperlyConfigured`** | Проверьте, что переменная `DJANGO_ENV` установлена в `dev` и файл `config/settings/dev.py` доступен. |
| **`python manage.py` сообщает об отсутствующих модулях** | Убедитесь, что виртуальное окружение активировано и зависимости установлены без ошибок. |
| **Сервер не стартует из-за занятого порта** | Запустите `python manage.py runserver 127.0.0.1:8001` или освободите порт 8000. |
| **`pytest` завершился с ошибками миграций** | Перед тестами выполните `python manage.py migrate`. При необходимости удалите файл `backend/db/db.sqlite3` и запустите миграции заново. |
| **Tailwind-классы не применяются** | Убедитесь, что используете файл `backend/static/css/tailwind.min.css`. При добавлении новых классов пересоберите CSS командой из раздела 9. |

## 11. Завершение работы

- Остановите сервер сочетанием `Ctrl + C` в окне PowerShell.
- Деактивируйте виртуальное окружение командой `deactivate`.
- При повторном входе в проект активируйте окружение (`.\.venv\Scripts\Activate.ps1`) и переходите к нужной директории.

Следуя инструкциям выше, вы сможете быстро поднять локальное окружение, воспроизвести ошибки и подготовить отчёты по найденным проблемам.
