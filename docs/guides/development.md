# Руководство разработчика

Документ описывает базовые процессы разработки проекта «Союзлифт Аудит». Информация дополняет архитектурное описание из [docs/architecture/v1.md](../architecture/v1.md) и план задач в [AGENTS.md](../../AGENTS.md).

## Окружение и инструменты

- **Язык и фреймворк:** Python 3.11, Django 5.x.
- **База данных:** SQLite (файл в каталоге `backend/`).
- **Фронтенд:** Django Templates, Tailwind CSS (предсобранный CSS-файл), точечное использование Alpine.js и HTMX.
- **Тестирование и качество кода:** `pytest`, `pytest-django`, `ruff`.
- **Управление зависимостями:** стандартный `pip` и `requirements.txt`.

### Настройка рабочего места

1. Склонируйте репозиторий и перейдите в директорию проекта.
2. Создайте виртуальное окружение: `python -m venv .venv`.
3. Активируйте окружение и обновите `pip` до актуальной версии.
4. Установите зависимости после появления `requirements.txt`: `pip install -r requirements.txt`.
5. Выполните миграции Django: `python manage.py migrate`.
6. Создайте суперпользователя: `python manage.py createsuperuser`.
   По умолчанию для новой записи профиль пользователя получает роль «Аудитор».
   После создания учётной записи авторизуйтесь в административной панели
   (`http://127.0.0.1:8000/admin/`), откройте раздел «Профили пользователей» и
   переключите поле «Роль» на значение «Администратор», иначе в пользовательском
   интерфейсе будут доступны только функции аудитора.
7. Запустите локальный сервер: `python manage.py runserver`.

### Конфигурация окружения

- Конфигурация разделена на профили `dev` и `prod`. По умолчанию используется профиль разработки. Для переключения установите переменную окружения `DJANGO_ENV` в одно из значений: `dev`, `test`, `prod`.
- Секретный ключ задаётся переменной `DJANGO_SECRET_KEY`. В режиме разработки допускается значение по умолчанию, но для тестовых/боевых стендов необходимо указать собственный ключ.
- Список доменов и адресов, с которых разрешены запросы, задаётся через `DJANGO_ALLOWED_HOSTS` (перечисление через запятую). Для HTTPS-окружений дополнительно укажите `DJANGO_CSRF_TRUSTED_ORIGINS`.
- Почтовые параметры управляются переменными `DJANGO_EMAIL_HOST`, `DJANGO_EMAIL_PORT`, `DJANGO_EMAIL_HOST_USER`, `DJANGO_EMAIL_HOST_PASSWORD`, `DJANGO_EMAIL_USE_TLS`, `DJANGO_EMAIL_USE_SSL`, `DJANGO_DEFAULT_FROM_EMAIL`. В профиле `dev` используется консольный backend, поэтому сообщения выводятся в терминал.
- Для настройки логирования доступны переменные:
  - `DJANGO_LOG_LEVEL` — уровень сообщений для консоли и файловых логов;
  - `DJANGO_LOG_DIR` — базовая директория для файлов журналов (по умолчанию `backend/logs`);
  - `DJANGO_LOG_FILE`, `DJANGO_LOG_MAX_BYTES`, `DJANGO_LOG_BACKUP_COUNT` — путь и параметры ротации основного файла логов приложения;
  - `DJANGO_SYNC_LOG_FILE`, `DJANGO_SYNC_LOG_MAX_BYTES`, `DJANGO_SYNC_LOG_BACKUP_COUNT` — файл и ротация отдельного журнала ошибок офлайн-синхронизации.

Дополнительные инструкции по развёртыванию и обслуживанию будут добавляться в каталоге `docs/` по мере реализации этапов T9–T12.

### Tailwind CSS и фронтенд-статика

- Предсобранный файл Tailwind лежит в `backend/static/css/tailwind.min.css`. Источник для сборки — `backend/static/css/tailwind.src.css` и конфигурация `tailwind.config.js` в корне репозитория.
- При изменении шаблонов или добавлении новых классов запустите компиляцию:
  - при наличии Node.js — `NODE_ENV=production npx tailwindcss -i backend/static/css/tailwind.src.css -o backend/static/css/tailwind.min.css --minify`;
  - без Node.js — скачайте [standalone-бинарь Tailwind](https://github.com/tailwindlabs/tailwindcss/releases) и выполните аналогичную команду, указав путь к бинарю.
- Локальные копии `Alpine.js` и `HTMX` находятся в `backend/static/js/` и подключаются в шаблоне `base.html` только при передаче флагов `load_alpine` и `load_htmx` в контекст.

## Стандарты разработки

### Ветвление

- Основная стабильная ветка — `main`.
- Для новых задач создавайте ветки вида `<stage>/<short-task-slug>` (например, `t1/setup-django`, `t3/catalog-models`).
- При работе над несколькими задачами параллельно допускается дополнительный префикс, отражающий направление, например `infra/t9-backups`.
- Перед созданием Pull Request выполняйте `git fetch --all` и `git rebase origin/main`.

### Коммиты и Pull Request

- Используйте стиль **Conventional Commits**.
- Включайте идентификатор задачи из `AGENTS.md` в начало описания коммита или в тело Pull Request (например, `feat: T1.1 bootstrap Django project`).
- Коммиты должны быть атомарными: один коммит — одна логически завершённая правка.
- Описание Pull Request содержит:
  - краткое резюме изменений;
  - ссылки на соответствующие разделы архитектуры, если архитектурные решения корректируются;
  - перечень запусков тестов и их результат.

### Код-ревью

- Минимум один апрув от технического руководителя или архитектора.
- Запрещено вливать код без прохождения автоматизированных проверок.
- Обсуждайте спорные архитектурные решения в Issues/документации прежде, чем вносить изменения.

## Тестирование

- Основные команды:
  - `pytest` — запуск всех тестов.
  - `ruff check backend/` — статический анализ Python-кода.
  - `python manage.py check` — встроенные проверки Django.
- Перед публикацией релиза обязательно выполняйте полный комплект тестов.
- При невозможности запуска тестов фиксируйте причину и указывайте её в отчёте и Pull Request.

### Локальное тестирование на Windows

1. Установите [Python 3.11](https://www.python.org/downloads/windows/) и добавьте его в `PATH` (галочка *Add python.exe to PATH* при установке).
2. Откройте PowerShell от имени пользователя и разрешите выполнение локальных скриптов (однократно):
   ```powershell
   Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned
   ```
3. Перейдите в каталог проекта и создайте виртуальное окружение:
   ```powershell
   py -3.11 -m venv .venv
   .\.venv\Scripts\Activate.ps1
   python -m pip install --upgrade pip
   pip install -r requirements.txt
   ```
4. Установите переменные окружения для разработки (актуальны до закрытия сессии PowerShell):
   ```powershell
   $env:DJANGO_ENV = "dev"
   $env:DJANGO_SECRET_KEY = "dev-secret-key"
   $env:DJANGO_ALLOWED_HOSTS = "localhost,127.0.0.1"
   ```
   Для постоянной конфигурации используйте `setx` или файл `.env`, прочитанный через `python-dotenv` (после его добавления в зависимости).
5. Выполните миграции и создайте суперпользователя:
   ```powershell
   python manage.py migrate
   python manage.py createsuperuser
   ```
6. Запустите сервер разработки и убедитесь, что сайт доступен по адресу <http://127.0.0.1:8000/>:
   ```powershell
   python manage.py runserver
   ```
   Если порт занят, укажите другой: `python manage.py runserver 127.0.0.1:8001`.
7. Прогоните автоматические проверки:
   ```powershell
   python manage.py check
   pytest
   ruff check backend/
   ```
   При необходимости добавьте ключ `-m` к `pytest` для запуска отдельных меток (`pytest -m "not slow"`).
8. Для проверки фронтенд-стилей установите Node.js и выполните сборку Tailwind (по желанию):
   ```powershell
   npm install --global tailwindcss
   tailwindcss -i backend/static/css/tailwind.src.css -o backend/static/css/tailwind.min.css --minify
   ```
9. Снимите дамп логов при ошибках (`Get-Content backend\logs\app.log -Wait`) и приложите его к отчёту.

> **Совет:** используйте [Windows Terminal](https://aka.ms/terminal) или [WSL2](https://learn.microsoft.com/windows/wsl/) для более комфортной работы с командной строкой. При запуске сервера во встроенном брандмауэре появится запрос на разрешение доступа — подтвердите для профиля «Частная сеть».

## Работа с данными и медиа

- Файлы БД и медиа размещаются в каталоге `backend/` (подкаталоги `db/`, `media/` будут добавлены на соответствующих этапах).
- Доступ к медиа-файлам ограничивается через авторизованные контроллеры; на разработке медиа могут обслуживаться напрямую.
- Резервное копирование SQLite и каталога медиа реализуется скриптами из `scripts/` (этапы T9.x, T12.x).

## Документация

- Любые архитектурные или процессные изменения отражайте в `docs/architecture/v1.md` и `AGENTS.md`.
- Для пользовательских инструкций (аудиторы, администраторы) будет создан раздел в `docs/` на этапе T11.3.
- Дополнительные руководства (например, по офлайн-синхронизации) оформляйте в отдельных файлах внутри `docs/` с понятными именами.
- Релизные и эксплуатационные процедуры описаны в [operations.md](operations.md); поддерживайте документ в актуальном состоянии.

## Контакты

Вопросы по архитектуре и процессам направляйте техническому руководителю проекта. Каналы коммуникации будут зафиксированы отдельно после утверждения организационной структуры.
