# Обзор логики и требований проекта «Союзлифт Аудит»

## 1. Контекст и целевое видение

Платформа «Союзлифт Аудит» перешла на архитектуру 3.0, которая упрощает исторически перегруженное решение: офлайн-режим, лишние статусы и избыточная матрица ролей удалены, чтобы сократить операционные расходы и сделать продукт прозрачным для пользователей и сопровождения.【F:docs/architecture/v3.md†L1-L27】 Основная цель новой версии — поддерживать непрерывный цикл аудита лифтовых объектов в онлайне, сохраняя ключевые бизнес-функции без дополнительных подсистем. Репозиторий содержит Django-бэкенд, интерфейс на шаблонах и эксплуатационные материалы, уже согласованные под эту целевую архитектуру.【F:README.md†L1-L38】

## 2. Роли, ответственность и заинтересованные стороны

### 2.1 Основные роли

- **Администратор** — ведёт справочники зданий и лифтов, публикует чек-листы, назначает аудиты и анализирует результаты. Также отвечает за модерацию данных и возврат аудитов на доработку.【F:docs/architecture/v3.md†L21-L36】
- **Аудитор** — принимает и исполняет аудиты, заполняет чек-листы, прикладывает доказательства и отправляет отчёт на проверку администратора.【F:docs/architecture/v3.md†L21-L43】

### 2.2 Поддерживающие участники

- **Суперпользователь Django** — создаёт аккаунты и выполняет аварийные операции, но не участвует в бизнес-процессах архитектуры 3.0.【F:docs/architecture/v3.md†L23-L27】
- **Команда сопровождения** — контролирует эксплуатацию (логирование, мониторинг, резервное копирование, Sentry) и реагирует на инциденты.【F:docs/architecture/v3.md†L95-L121】【F:backend/config/settings/base.py†L55-L225】

### 2.3 Ролевая модель в коде

Пользовательские профили расширяют стандартную модель Django и фиксируют принадлежность сотрудника к ролям администратора или аудитора. Эти флаги используются в проверках доступа, построении меню и фильтрации данных.【F:backend/accounts/models.py†L9-L79】【F:backend/accounts/permissions.py†L17-L142】

## 3. Компонентная карта

Архитектура 3.0 делит систему на четыре ключевых приложения, каждое из которых обслуживает отдельную часть жизненного цикла аудита：【F:docs/architecture/v3.md†L59-L66】

1. **accounts** — аутентификация, профиль пользователя, ограничения доступа и общие страницы кабинета.【F:backend/accounts/models.py†L9-L79】【F:backend/accounts/views.py†L1-L43】
2. **catalog** — справочники зданий и лифтов с модерацией и журналами импорта, обеспечивающими контроль качества данных.【F:backend/catalog/models.py†L11-L314】
3. **checklists** — управление шаблонами чек-листов и пунктами проверки, включая публикацию и клонирование версий.【F:backend/checklists/models.py†L15-L342】
4. **audits** — назначение, заполнение и приёмка аудитов, расчёт итогового балла и работа с вложениями.【F:backend/audits/models.py†L16-L388】【F:backend/audits/views.py†L21-L240】

## 4. Доменная модель и взаимосвязи

| Сущность | Назначение | Связи и особенности |
| --- | --- | --- |
| `Building` | Карточка здания с адресом и примечаниями. Проходит модерацию перед тем, как стать доступной аудиторам. | Связь 1:M с `Elevator` и `Audit`; хранит статус проверки, автора и верификатора, чтобы отслеживать ответственность.【F:backend/catalog/models.py†L89-L160】 |
| `Elevator` | Конкретный лифт в здании, описанный идентификатором, статусом эксплуатации и комментариями. | Связан с `Building`; повторяет модерационный цикл и обеспечивает уникальность утверждённых идентификаторов внутри здания.【F:backend/catalog/models.py†L163-L246】 |
| `ChecklistTemplate` | Версия чек-листа, доступная для назначения аудитов после публикации. | Связана 1:M с `ChecklistItem`; поддерживает клонирование для версионирования структуры вопросов.【F:backend/checklists/models.py†L39-L121】 |
| `ChecklistItem` | Отдельный пункт проверки с числовой шкалой или вариантами ответов, весом и обязательностью комментария. | Содержит валидации диапазонов, списка опций и уникальность порядка внутри шаблона, чтобы данные были сопоставимы при расчёте баллов.【F:backend/checklists/models.py†L123-L342】 |
| `Audit` | Экземпляр проверки, объединяющий объект, чек-лист и исполнителя. Имеет статусы `draft` и `submitted`, финальный балл и комментарий администратора. | Ограничивает количество черновиков на лифт, хранит метаданные (дедлайн, отправка) и управляет переходами состояний через методы `mark_submitted` и `request_changes`.【F:backend/audits/models.py†L16-L155】 |
| `AuditResponse` | Ответ на пункт чек-листа: числовое значение или выбранная опция, комментарий аудитора. | Валидации гарантируют корректность диапазона, шага, обязательность комментария и конвертацию опций в числовые значения для итогового балла.【F:backend/audits/models.py†L157-L276】 |
| `AuditAttachment` | Вложение к аудиту или конкретному ответу с подписью загрузившего пользователя. | Соблюдает лимиты размера и количества, проверяет связь с нужным аудиторским ответом и хранит метаданные загрузки.【F:backend/audits/models.py†L279-L383】【F:backend/config/settings/base.py†L275-L305】 |
| `CatalogImportLog` | Журнал импорта справочников с количеством успешных и ошибочных строк. | Позволяет отслеживать каждую загрузку файлов и связывает её с инициатором, обеспечивая прозрачность массовых обновлений данных.【F:backend/catalog/models.py†L249-L314】 |

## 5. Пользовательские сценарии и рабочие процессы

### 5.1 Администратор

1. **Подготовка справочников.** Загружает или создаёт здания и лифты. Каждая запись проходит модерацию: пока статус `pending`, она видна только автору и администраторам; после утверждения становится доступной аудиторам.【F:docs/architecture/v3.md†L32-L36】【F:backend/catalog/models.py†L11-L160】
2. **Настройка чек-листов.** Публикует шаблоны с набором вопросов, весами и обязательными комментариями. При необходимости клонирует старую версию, чтобы внести изменения без влияния на завершённые аудиты.【F:docs/architecture/v3.md†L32-L37】【F:backend/checklists/models.py†L39-L342】
3. **Назначение аудитов.** Создаёт аудит в статусе черновика, выбирает объект, чек-лист, исполнителя и дедлайн. Допускается оставлять аудит без назначенного пользователя, чтобы любой аудитор мог его взять из пула.【F:docs/architecture/v3.md†L32-L36】【F:backend/audits/models.py†L16-L155】
4. **Контроль исполнения.** Следит за списком аудитов, доступным с фильтрами и агрегированными ответами. Может открывать карточку и возвращать `submitted` аудит в `draft`, оставив комментарий с требованиями доработки.【F:docs/architecture/v3.md†L34-L36】【F:backend/audits/views.py†L51-L223】
5. **Экспорт и отчётность.** Использует встроенные выгрузки и журналы импорта. Расширенная аналитика оставлена на этап развития, чтобы не усложнять ядро 3.0.【F:docs/architecture/v3.md†L35-L37】【F:docs/architecture/v3.md†L99-L128】

### 5.2 Аудитор

1. **Получение заданий.** Просматривает назначенные аудиты или свободные черновики без исполнителя; видит только утверждённые справочники благодаря фильтрации по ролям.【F:docs/architecture/v3.md†L38-L43】【F:backend/accounts/permissions.py†L93-L142】【F:backend/catalog/models.py†L17-L44】
2. **Заполнение чек-листа.** Работает с формой, где вопросы отсортированы по порядку, а валидация повторяет правила чек-листа: диапазоны, шаги, обязательные комментарии, соответствие вариантов. Черновик можно сохранять частично заполненным.【F:backend/audits/views.py†L91-L204】【F:backend/audits/forms.py†L10-L129】【F:backend/audits/models.py†L205-L276】
3. **Отправка отчёта.** Перед отправкой система проверяет наличие ответов по всем пунктам. Переход в `submitted` фиксирует время сдачи, пересчитывает итоговый балл и делает форму доступной только для чтения для аудитора.【F:backend/audits/views.py†L166-L204】【F:backend/audits/models.py†L99-L155】
4. **Обработка возвратов.** Если администратор запросил доработку, аудит снова становится черновиком, а комментарий хранится в поле `admin_comment`. Аудитор видит требования и повторно отправляет форму после исправлений.【F:backend/audits/models.py†L115-L123】【F:backend/audits/views.py†L205-L223】
5. **Работа с вложениями.** Прикладывает файлы в пределах лимитов по размеру и количеству, чтобы подтвердить результаты проверки. Система следит, чтобы вложения относились к правильным ответам и не нарушали ограничения хранения.【F:backend/audits/models.py†L279-L383】【F:backend/config/settings/base.py†L275-L305】

## 6. Логика данных и контроль качества

- **Модерация справочников.** Статусы `pending/approved/rejected` на зданиях и лифтах гарантируют, что аудиторы работают только с проверенной информацией. Утверждение фиксирует ответственного администратора и время верификации, что важно для аудиторских следов.【F:backend/catalog/models.py†L11-L160】【F:backend/catalog/models.py†L163-L314】
- **Валидации чек-листов.** При сохранении пунктов контролируются диапазоны баллов, уникальность порядка и корректность вариантов. Это предотвращает неконсистентные шкалы и обеспечивает сопоставимость итоговых баллов между аудитами.【F:backend/checklists/models.py†L123-L342】
- **Валидации ответов.** `AuditResponse` проверяет соответствие типов данных, шагов и обязательности комментариев, а также пересчитывает итоговый балл после каждого сохранения или удаления ответа, чтобы метрика на аудитах всегда была актуальной.【F:backend/audits/models.py†L205-L276】【F:backend/audits/models.py†L125-L147】
- **Лимиты вложений.** Настройки задают допустимый размер файла и количество вложений на аудит и на отдельный ответ, что помогает соблюдать корпоративные политики хранения и избегать перегрузки файловой системы.【F:backend/audits/models.py†L279-L383】【F:backend/config/settings/base.py†L275-L305】
- **Журналы импорта.** Каждый массовый импорт фиксируется с числом успешных и ошибочных строк, а также с исходным файлом, что позволяет восстанавливать контекст и проводить разбор инцидентов качества данных.【F:backend/catalog/models.py†L249-L314】

## 7. Нефункциональные требования

1. **Онлайн-доступ.** Решение рассчитано на работу только в онлайне; офлайн-режимы, мобильные приложения и синхронизация исключены, чтобы не усложнять поддержку.【F:docs/architecture/v3.md†L9-L17】
2. **Простота ролей и статусов.** Допускается только две бизнес-роли и два статуса аудита, что снижает нагрузку на обучение и поддержку пользователей.【F:docs/architecture/v3.md†L11-L17】
3. **Производительность и масштабируемость.** Использование серверного рендеринга, отказ от тяжёлых фронтенд-фреймворков и фоновых очередей минимизирует инфраструктурные требования. Bootstrap и стандартные Django формы обеспечивают предсказуемое поведение интерфейса.【F:docs/architecture/v3.md†L68-L92】
4. **Надёжность хранения.** Приложение работает с файловой системой для медиа и SQLite по умолчанию, при этом допускается подключение внешнего хранилища через `DEFAULT_FILE_STORAGE`. Логи пишутся в ротационные файлы и при необходимости отправляются в Sentry.【F:backend/config/settings/base.py†L105-L305】
5. **Безопасность.** Стандартные валидаторы паролей, CSRF-защита и ограничение доступов по ролям реализованы «из коробки». Все защищённые страницы требуют аутентификации, а проверка ролей встроена в mixin’ы и декораторы.【F:backend/config/settings/base.py†L59-L119】【F:backend/accounts/permissions.py†L24-L104】

## 8. Интеграции и обмен данными

- **Импорт/экспорт справочников.** Обрабатываются файлы CSV/XLS(X), предоставляя предпросмотр, отчёты по ошибкам и массовое обновление записей. Логика реализована в сервисах каталога и сопровождается журналами импортов для аудита изменений.【F:docs/architecture/v3.md†L32-L36】【F:backend/catalog/models.py†L249-L314】
- **Экспорт аудитов.** Интерфейс предоставляет выгрузку отдельных аудитов и списков для отчётности без сложных BI-панелей; акцент сделан на простых табличных форматах (CSV/XLS/XLSX).【F:docs/architecture/v3.md†L35-L37】
- **Публичные API.** В текущей версии внешние API выключены; допускается только прицельный read-only эндпоинт для выгрузки аудитов при подтверждённой потребности, чтобы сохранить простоту ядра.【F:docs/architecture/v3.md†L99-L103】

## 9. Эксплуатация и сопровождение

- **Настройки окружений.** Поддерживаются профили `dev` и `prod`, переключаемые переменной `DJANGO_ENV`. Ключевые параметры (секреты, лимиты вложений, email) задаются через переменные окружения, что упрощает перенос между средами.【F:backend/config/settings/base.py†L55-L305】
- **Мониторинг и инциденты.** Базовые метрики и сбор ошибок через Sentry формируют минимальный, но достаточный контур наблюдаемости. Дополнительные журналы офлайна сознательно исключены для снижения стоимости поддержки.【F:docs/architecture/v3.md†L95-L121】【F:backend/config/settings/base.py†L191-L258】
- **Резервное копирование.** Регламентируется стандартным бэкапом базы и медиа; дополнительных архивов журналов не требуется в новой архитектуре.【F:docs/architecture/v3.md†L115-L121】
- **Контроль качества релизов.** Перед релизами выполняются автоматические тесты (unit, smoke) и ручные чек-листы, охватывающие жизненный цикл аудита и ключевые CRUD-операции. Это закреплено в архитектурной документации и README.【F:docs/architecture/v3.md†L115-L121】【F:README.md†L54-L64】

## 10. Дорожная карта развития

После стабилизации архитектуры 3.0 команда может развивать продукт эволюционно: добавить расширенные отчёты, облегчённый офлайн-режим через Excel и новые роли при росте нагрузки. Также рассматривается постепенное раскрытие API для внешних систем, начиная с read-only доступов.【F:docs/architecture/v3.md†L99-L128】 Эти инициативы планируется запускать только после оценки влияния на упрощённую модель.

---

Документ предназначен для продуктовой и аналитической команд: он описывает действующую логику, ограничения и ожидаемое поведение системы, чтобы облегчить планирование новых релизов, поддержку пользователей и взаимодействие с заказчиком в рамках архитектуры 3.0.
