# Процессы релизов и поддержки

Документ описывает рутинные процедуры сопровождения веб-приложения «Союзлифт Аудит». Информация дополняет архитектурные разделы [§4.4](../architecture.md#44-%D0%B8%D0%BD%D1%84%D1%80%D0%B0%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%BD%D1%8B%D0%B9-%D1%81%D0%BB%D0%BE%D0%B9) и [§12](../architecture.md#12-%D1%80%D0%B0%D0%B7%D0%B2%D1%91%D1%80%D1%82%D1%8B%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B8-%D0%BE%D0%B1%D1%81%D0%BB%D1%83%D0%B6%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5) архитектуры и предназначена для инженеров эксплуатации.

## 1. Релизный цикл

### 1.1. Планирование

- Релизы проходят по мере готовности функциональных блоков, но не реже одного раза в квартал.
- Каждому релизу присваивается семантическая версия `MAJOR.MINOR.PATCH`; номер фиксируется в `CHANGELOG.md` (будет добавлен на этапе подготовки первой версии).
- Перед началом работ назначается ответственный инженер, который ведёт чек-лист релиза и собирает подтверждения от разработки и тестирования.

### 1.2. Подготовка к релизу

1. Убедиться, что все задачи релиза отмечены как завершённые в [AGENTS.md](../AGENTS.md) и соответствуют архитектуре.
2. Выполнить полный набор автоматизированных проверок:
   - `pytest`
   - `ruff check backend/`
   - `python manage.py check`
3. Обновить документацию (README, пользовательские инструкции) при наличии изменений в UX.
4. Сформировать релизную ветку `release/vX.Y.Z` от `main`, если требуется длительная стабилизация. В противном случае релиз оформляется напрямую из `main`.
5. Согласовать окно обслуживания с заказчиком и уведомить пользователей не менее чем за 3 рабочих дня.

### 1.3. Развёртывание на продакшене

1. Зайти на сервер под учётной записью администратора приложения.
2. Перейти в каталог проекта и остановить службу приложения:
   ```bash
   sudo systemctl stop gunicorn
   ```
3. Зафиксировать резервные копии (см. раздел 2).
4. Обновить код и зависимости:
   ```bash
   git fetch --all
   git checkout main
   git pull --ff-only
   source .venv/bin/activate
   pip install -r requirements.txt
   python manage.py migrate
   python manage.py collectstatic --noinput
   ```
5. Прогнать smoke-проверки:
   ```bash
   python manage.py check
   python manage.py test --tag smoke
   ```
   > Набор smoke-тестов будет определён после внедрения автоматических тестов (этап T10.x). До того момента выполняйте выборочный запуск критичных тест-кейсов вручную.
6. Запустить службу приложения и убедиться, что процессы поднялись без ошибок:
   ```bash
   sudo systemctl start gunicorn
   sudo systemctl restart nginx
   sudo systemctl status gunicorn
   ```
7. Выполнить контрольный заход в админку и портал аудитора, убедиться в доступности статических файлов и медиа.
8. Закрыть релиз в трекере задач, приложив список изменений и результаты проверок.

### 1.4. Пост-релизный мониторинг

- В течение 24 часов после релиза ответственный инженер отслеживает логи приложений (см. раздел 3) и собирает обратную связь от пользователей.
- При обнаружении критических дефектов выполняется hotfix с версией `X.Y.(Z+1)` и упрощённой процедурой развёртывания (те же шаги, но без долгосрочной подготовки).

## 2. Резервное копирование

### 2.1. Политика

- Храните не менее 7 ежедневных и 4 недельных копий базы данных и медиафайлов.
- Резервные копии выполняются перед каждым релизом и ежедневно в 02:00 по серверному времени.
- Бэкапы хранятся на отдельном диске/сетевом ресурсе с доступом только для администраторов.

### 2.2. Скрипт резервного копирования

Создайте скрипт `scripts/backup.sh` (будет реализован на этапе T9.2) со следующей логикой:

```bash
#!/bin/bash
set -euo pipefail
TIMESTAMP="$(date +%Y%m%d-%H%M%S)"
BACKUP_ROOT="/var/backups/souzlift"
PROJECT_ROOT="/opt/souzlift"
DB_PATH="$PROJECT_ROOT/backend/db.sqlite3"
MEDIA_PATH="$PROJECT_ROOT/backend/media"
TARGET_DIR="$BACKUP_ROOT/$TIMESTAMP"

mkdir -p "$TARGET_DIR"
cp "$DB_PATH" "$TARGET_DIR/db.sqlite3"
rsync -a "$MEDIA_PATH/" "$TARGET_DIR/media/"
find "$BACKUP_ROOT" -maxdepth 1 -type d -mtime +30 -exec rm -rf {} \;
```

Инструкции по установке:

1. Разместить скрипт в каталоге `scripts/` и выдать права на исполнение: `chmod +x scripts/backup.sh`.
2. Настроить cron-задачу от пользователя, владеющего приложением:
   ```bash
   0 2 * * * /opt/souzlift/scripts/backup.sh >> /var/log/souzlift/backup.log 2>&1
   ```
3. Периодически проверять целостность бэкапов: раз в месяц разворачивать тестовую копию базы в изолированной среде и открывать несколько аудитов.

### 2.3. Восстановление из резервной копии

1. Остановить приложение (`sudo systemctl stop gunicorn`).
2. Скопировать файл базы и каталог медиа из нужного архива в рабочую директорию.
3. Проверить права на файлы (`chown -R appuser:appuser backend/db.sqlite3 backend/media`).
4. Запустить приложение и убедиться, что данные доступны.

## 3. Мониторинг и эксплуатационные проверки

### 3.1. Логи и алерты

- Django и gunicorn пишут логи в `/var/log/souzlift/`. Настройте ротацию через `logrotate` со сроком хранения 14 дней.
- Настройте ежедневную отправку сводки через `logwatch` на почту ответственного инженера.
- При ошибках синхронизации офлайн-пакетов создавайте тикеты в системе поддержки с прикреплением фрагментов логов.

### 3.2. Контроль доступности

- Используйте системную утилиту `monit` или аналог для проверки процессов `gunicorn` и `nginx`. Конфигурация включает перезапуск служб при падении и алерт по e-mail.
- Добавьте HTTP-проверку URL `/healthz/` (будет реализован на этапе T5.x) с ожиданием кода 200.

### 3.3. Контроль ресурсов

- Раз в час выполняйте проверку свободного дискового пространства:
  ```bash
  */60 * * * * df -h /opt/souzlift >> /var/log/souzlift/disk_usage.log
  ```
- Еженедельно запускайте `python manage.py clearsessions` и отчёт о размере медиа (`du -sh backend/media`). Эти операции будут автоматизированы скриптами на этапе T9.3.

### 3.4. Поддержка пользователей

- Канал обратной связи: корпоративная почта `support@souzlift.local` и телефон горячей линии (будет предоставлен заказчиком).
- Время реакции на инциденты:
  - **Критические (простой системы, потеря данных):** 2 часа, круглосуточно.
  - **Высокий приоритет (недоступен отдельный модуль):** 4 часа в рабочее время.
  - **Средний/низкий приоритет:** ответ в течение 1 рабочего дня.
- Все обращения регистрируются в сервис-деске заказчика. Инженер поддержки отслеживает статус до полного закрытия.

## 4. Матрица ответственности

| Процесс | Ответственный | Резервный |
|---------|---------------|-----------|
| Планирование релиза | Технический руководитель | Ведущий разработчик |
| Развёртывание | Инженер эксплуатации | Технический руководитель |
| Резервное копирование | Инженер эксплуатации | Системный администратор заказчика |
| Мониторинг и алерты | Инженер эксплуатации | DevOps-консультант (по договорённости) |
| Поддержка пользователей | Служба поддержки заказчика | Инженер эксплуатации |

Документ обновляется при изменении процессов или состава команды. Следите за синхронизацией с архитектурными разделами и планом задач.
