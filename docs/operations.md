# Процессы релизов и поддержки

Документ описывает рутинные процедуры сопровождения веб-приложения «Союзлифт Аудит». Информация дополняет архитектурные разделы [§4.4](../architecture.md#44-%D0%B8%D0%BD%D1%84%D1%80%D0%B0%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%BD%D1%8B%D0%B9-%D1%81%D0%BB%D0%BE%D0%B9) и [§12](../architecture.md#12-%D1%80%D0%B0%D0%B7%D0%B2%D1%91%D1%80%D1%82%D1%8B%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B8-%D0%BE%D0%B1%D1%81%D0%BB%D1%83%D0%B6%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5) архитектуры и предназначена для инженеров эксплуатации.

## 1. Релизный цикл

### 1.1. Планирование

- Релизы проходят по мере готовности функциональных блоков, но не реже одного раза в квартал.
- Каждому релизу присваивается семантическая версия `MAJOR.MINOR.PATCH`; номер фиксируется в `CHANGELOG.md` (будет добавлен на этапе подготовки первой версии).
- Перед началом работ назначается ответственный инженер, который ведёт чек-лист релиза и собирает подтверждения от разработки и тестирования.

### 1.2. Подготовка к релизу

1. Убедиться, что все задачи релиза отмечены как завершённые в [AGENTS.md](../AGENTS.md) и соответствуют архитектуре.
2. Выполнить полный набор автоматизированных проверок:
   - `pytest`
   - `ruff check backend/`
   - `python manage.py check`
3. Обновить документацию (README, пользовательские инструкции) при наличии изменений в UX.
4. Сформировать релизную ветку `release/vX.Y.Z` от `main`, если требуется длительная стабилизация. В противном случае релиз оформляется напрямую из `main`.
5. Согласовать окно обслуживания с заказчиком и уведомить пользователей не менее чем за 3 рабочих дня.

#### 1.2.1. Конфигурация окружения

- На боевых серверах явно устанавливайте `DJANGO_ENV=prod` перед запуском служб `gunicorn` и фоновых задач.
- Укажите переменные `DJANGO_SECRET_KEY`, `DJANGO_ALLOWED_HOSTS` (список доменов через запятую) и, при необходимости, `DJANGO_CSRF_TRUSTED_ORIGINS` с префиксом `https://`.
- Настройте почтовый шлюз через `DJANGO_EMAIL_HOST`, `DJANGO_EMAIL_PORT`, `DJANGO_EMAIL_HOST_USER`, `DJANGO_EMAIL_HOST_PASSWORD`, `DJANGO_EMAIL_USE_TLS`/`DJANGO_EMAIL_USE_SSL`, `DJANGO_DEFAULT_FROM_EMAIL`.
- Для логирования задайте базовый каталог `DJANGO_LOG_DIR` (например, `/var/log/souzlift`), основной файл `DJANGO_LOG_FILE` с параметрами ротации `DJANGO_LOG_MAX_BYTES` и `DJANGO_LOG_BACKUP_COUNT`, а также отдельный журнал ошибок офлайн-синхронизации через `DJANGO_SYNC_LOG_FILE`, `DJANGO_SYNC_LOG_MAX_BYTES`, `DJANGO_SYNC_LOG_BACKUP_COUNT`.
- Параметры HTTPS (HSTS, редиректы) можно скорректировать переменными `DJANGO_SECURE_SSL_REDIRECT`, `DJANGO_SECURE_HSTS_SECONDS`, `DJANGO_SECURE_HSTS_INCLUDE_SUBDOMAINS`, `DJANGO_SECURE_HSTS_PRELOAD`, `DJANGO_SECURE_REFERRER_POLICY` в зависимости от инфраструктуры заказчика.

### 1.3. Развёртывание на продакшене

1. Зайти на сервер под учётной записью администратора приложения.
2. Перейти в каталог проекта и остановить службу приложения:
   ```bash
   sudo systemctl stop gunicorn
   ```
3. Зафиксировать резервные копии (см. раздел 2).
4. Обновить код и зависимости:
   ```bash
   git fetch --all
   git checkout main
   git pull --ff-only
   source .venv/bin/activate
   pip install -r requirements.txt
   python manage.py migrate
   python manage.py collectstatic --noinput
   ```
5. Прогнать smoke-проверки:
   ```bash
   python manage.py check
   python manage.py test --tag smoke
   ```
   > Набор smoke-тестов будет определён после внедрения автоматических тестов (этап T10.x). До того момента выполняйте выборочный запуск критичных тест-кейсов вручную.
6. Запустить службу приложения и убедиться, что процессы поднялись без ошибок:
   ```bash
   sudo systemctl start gunicorn
   sudo systemctl restart nginx
   sudo systemctl status gunicorn
   ```
7. Выполнить контрольный заход в админку и портал аудитора, убедиться в доступности статических файлов и медиа.
8. Закрыть релиз в трекере задач, приложив список изменений и результаты проверок.

### 1.4. Пост-релизный мониторинг

- В течение 24 часов после релиза ответственный инженер отслеживает логи приложений (см. раздел 3) и собирает обратную связь от пользователей.
- При обнаружении критических дефектов выполняется hotfix с версией `X.Y.(Z+1)` и упрощённой процедурой развёртывания (те же шаги, но без долгосрочной подготовки).

## 2. Резервное копирование

### 2.1. Политика

- Храните не менее 7 ежедневных и 4 недельных копий базы данных и медиафайлов.
- Резервные копии выполняются перед каждым релизом и ежедневно в 02:00 по серверному времени.
- Бэкапы хранятся на отдельном диске/сетевом ресурсе с доступом только для администраторов.

### 2.2. Скрипт резервного копирования

В репозитории реализован скрипт `scripts/backup.sh`, автоматизирующий резервное копирование базы данных и каталога медиа. По умолчанию он:

- определяет каталог проекта относительно расположения скрипта;
- создаёт каталоги бэкапов вида `<BACKUP_ROOT>/<YYYYMMDD-HHMMSS>/` и символическую ссылку `latest` на свежий архив;
- выполняет согласованное копирование SQLite-файла (через `sqlite3 .backup`, а при его отсутствии — через стандартную библиотеку Python или `cp`);
- синхронизирует каталог медиа (`rsync -a --delete` с резервным вариантом на `tar`);
- записывает файл `manifest.json` с параметрами создания и размерами копий;
- удаляет каталоги старше `RETENTION_DAYS` (по умолчанию 30 суток).

Переменные окружения позволяют адаптировать сценарий под инфраструктуру заказчика:

| Переменная | Назначение | Значение по умолчанию |
|------------|------------|-----------------------|
| `PROJECT_ROOT` | Корневой каталог проекта | `<script_dir>/..` |
| `BACKUP_ROOT` | Папка хранения бэкапов | `$PROJECT_ROOT/backups` |
| `DB_PATH` | Путь к файлу SQLite | `$PROJECT_ROOT/backend/db/db.sqlite3` |
| `MEDIA_PATH` | Каталог с медиафайлами | `$PROJECT_ROOT/backend/media` |
| `RETENTION_DAYS` | Срок хранения копий в сутках | `30` |
| `SQLITE3_BIN` | Путь к бинарю `sqlite3` | `sqlite3` (из `$PATH`) |
| `PYTHON_BIN` | Интерпретатор Python для резервного варианта | `python3` |

Пример запуска на продакшене:

```bash
BACKUP_ROOT=/var/backups/souzlift \
PROJECT_ROOT=/opt/souzlift \
RETENTION_DAYS=60 \
/opt/souzlift/scripts/backup.sh
```

### 2.3. Настройка cron-задачи

Скрипт `scripts/install_backup_cron.sh` помогает установить ежедневный запуск резервного копирования. Он обновляет персональный `crontab`, устраняя дубликаты существующих записей и при необходимости создаёт каталог логов.

Доступные параметры:

| Переменная | Назначение | Значение по умолчанию |
|------------|------------|-----------------------|
| `BACKUP_SCRIPT` | Путь до исполняемого `backup.sh` | `<script_dir>/backup.sh` |
| `SCHEDULE` | Cron-расписание | `0 2 * * *` |
| `LOG_FILE` | Файл для логирования | `/var/log/souzlift/backup.log` |
| `CRONTAB_BIN` | Команда управления cron | `crontab` |
| `DRY_RUN` | Только вывести будущий crontab без применения | `false` |

Пример установки ежедневного бэкапа с логами:

```bash
PROJECT_ROOT=/opt/souzlift \
LOG_FILE=/var/log/souzlift/backup.log \
/opt/souzlift/scripts/install_backup_cron.sh
```

Для проверки получившегося расписания запустите `DRY_RUN=true ./scripts/install_backup_cron.sh`.

Не реже одного раза в месяц разворачивайте тестовую копию из свежего архива: остановите стенд, восстановите базу и медиа в изолированной среде и убедитесь, что аудиты и вложения доступны.

### 2.4. Восстановление из резервной копии

1. Остановить приложение (`sudo systemctl stop gunicorn`).
2. Скопировать файл базы и каталог медиа из нужного архива в рабочую директорию.
3. Проверить права на файлы (`chown -R appuser:appuser backend/db.sqlite3 backend/media`).
4. Запустить приложение и убедиться, что данные доступны.

## 3. Мониторинг и эксплуатационные проверки

### 3.1. Логи и алерты

- Django и gunicorn пишут логи в `/var/log/souzlift/`. Настройте ротацию через `logrotate` со сроком хранения 14 дней.
- Файл `/var/log/souzlift/offline-sync-errors.log` собирает ошибки офлайн-синхронизации. Проверяйте его после релизов и при обращениях аудиторов о проблемах с передачей данных.
- Настройте ежедневную отправку сводки через `logwatch` на почту ответственного инженера.
- При ошибках синхронизации офлайн-пакетов создавайте тикеты в системе поддержки с прикреплением фрагментов логов.

### 3.2. Контроль доступности

- Используйте системную утилиту `monit` или аналог для проверки процессов `gunicorn` и `nginx`. Конфигурация включает перезапуск служб при падении и алерт по e-mail.
- Добавьте HTTP-проверку URL `/healthz/` (будет реализован на этапе T5.x) с ожиданием кода 200.

### 3.3. Контроль ресурсов

- Для контроля свободного места используйте скрипт [`scripts/check_storage.sh`](../scripts/check_storage.sh). Он вычисляет процент заполнения диска для каталога проекта, сообщает суммарный объём медиа и возвращает код возврата `0/1/2` для состояний `OK/WARNING/CRITICAL`. Пример задания в `cron`:
  ```bash
  */60 * * * * PROJECT_ROOT=/opt/souzlift \
    /opt/souzlift/scripts/check_storage.sh >> /var/log/souzlift/disk_usage.log 2>&1
  ```
- Для еженедельного обслуживания добавьте задания:
  - `scripts/run_clearsessions.sh` — обёртка над `python manage.py clearsessions`, очищающая устаревшие записи сессий. Скрипт принимает переменные `PROJECT_ROOT`, `VENV_PATH`, `PYTHON_BIN` и наследует остальные аргументы Django-команды.
  - `scripts/check_attachments.sh` — запускает management-команду `check_attachments_integrity`. По умолчанию команда лишь отчётно проверяет наличие файлов; при необходимости можно добавить флаги `--fix-sizes` и `--delete-orphans` для синхронизации поля `stored_size` и удаления осиротевших файлов. Для машинной обработки доступен формат `--json`.
  Пример расписания:
  ```bash
  0 3 * * 1 PROJECT_ROOT=/opt/souzlift VENV_PATH=/opt/souzlift/.venv \
    /opt/souzlift/scripts/run_clearsessions.sh >> /var/log/souzlift/maintenance.log 2>&1
  30 3 * * 1 PROJECT_ROOT=/opt/souzlift VENV_PATH=/opt/souzlift/.venv \
    /opt/souzlift/scripts/check_attachments.sh --json >> /var/log/souzlift/attachments.log 2>&1
  ```

### 3.4. Поддержка пользователей

- Канал обратной связи: корпоративная почта `support@souzlift.local` и телефон горячей линии (будет предоставлен заказчиком).
- Время реакции на инциденты:
  - **Критические (простой системы, потеря данных):** 2 часа, круглосуточно.
  - **Высокий приоритет (недоступен отдельный модуль):** 4 часа в рабочее время.
  - **Средний/низкий приоритет:** ответ в течение 1 рабочего дня.
- Все обращения регистрируются в сервис-деске заказчика. Инженер поддержки отслеживает статус до полного закрытия.

## 4. Матрица ответственности

| Процесс | Ответственный | Резервный |
|---------|---------------|-----------|
| Планирование релиза | Технический руководитель | Ведущий разработчик |
| Развёртывание | Инженер эксплуатации | Технический руководитель |
| Резервное копирование | Инженер эксплуатации | Системный администратор заказчика |
| Мониторинг и алерты | Инженер эксплуатации | DevOps-консультант (по договорённости) |
| Поддержка пользователей | Служба поддержки заказчика | Инженер эксплуатации |

Документ обновляется при изменении процессов или состава команды. Следите за синхронизацией с архитектурными разделами и планом задач.
