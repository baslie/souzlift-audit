# План архивации устаревших журналов и офлайн-сущностей (T1.3)

_Дата подготовки: 26.09.2025 (assistant)_

## 1. Цель и рамки задачи

Задача T1.3 формирует согласованный план отказа от устаревших журналов (`AuditLogEntry`), офлайн-сущностей (`OfflineSyncBatch`, сервис-воркер, офлайн-формы) и дополнительных настроек (`AttachmentLimitConfiguration`, `ObjectInfoField`), сохраняя минимально необходимую информацию для аудита и аналитики. Архитектура 3.0 предписывает удаление офлайн-контуров и сложных журналов действий, оставляя только то, что требуется для двух ролей и простого жизненного цикла аудита.【F:docs/architecture/v3.md†L75-L118】 План служит входом для миграций этапа T2.1 и репетиции T5.2.

## 2. Актуальное состояние и зависимые данные

1. `AuditLogEntry` фиксирует подробный набор событий (создание, изменение статусов, операции с ответами, вложениями, подписями, офлайн-пакетами) с индексами по сущности, действию и времени, что приводит к значительному объёму данных.【F:backend/audits/models.py†L1085-L1157】 По итогам T1.2 статусы и обратная связь будут храниться в `Audit`, `AuditFeedback` и связанных метках времени, что снижает потребность в детальном журнале.【F:docs/reports/audit-status-conversion-plan-t1-2.md†L39-L120】
2. `OfflineSyncBatch` сохраняет каждый запрос синхронизации, payload, статусы применения и уведомлений, а также пишет структурированные ошибки в отдельный лог-файл `offline-sync-errors.log`.【F:backend/audits/models.py†L1160-L1399】【F:backend/config/settings/base.py†L164-L232】
3. `AttachmentLimitConfiguration` переопределяет лимиты вложений поверх дефолтных значений 8 МБ / 10 / 100, а код читает их на лету через кэшированный слой.【F:backend/audits/models.py†L22-L174】
4. `ObjectInfoField` описывает настраиваемые поля информационной карточки и участвует в выгрузке каталога для офлайна; значения копируются в JSON `Audit.object_info` при создании аудита.【F:backend/catalog/models.py†L550-L603】【F:docs/reports/data-inventory-2025-09-24.md†L22-L47】
5. Статические и серверные компоненты офлайна (сервис-воркер, offline views, JS-хранилище) напрямую зависят от этих данных и должны быть выключены синхронно, чтобы исключить новые записи при подготовке архива.【F:backend/static/js/service-worker.js†L1-L112】【F:backend/audits/views.py†L585-L644】

## 3. Требования к сохранности и регламенту

* Сохранить минимальный контур аудита событий: дата создания аудита, время последней отправки (`submitted_at`), возвратов (`returned_at`) и журнал обратной связи (`AuditFeedback`). Этого достаточно для регуляторных проверок согласно архитектуре 3.0 без полного журнала действий.【F:docs/architecture/v3.md†L11-L118】【F:docs/reports/audit-status-conversion-plan-t1-2.md†L39-L195】
* Сохранить историю критичных офлайн-ошибок для ретроспективного анализа в течение 12 месяцев после отключения офлайна. Достаточно экспортировать агрегаты (дата, устройство, пользователь, статус, детали ошибки) без хранения полных payload'ов.
* Зафиксировать текущие пользовательские настройки, которые исчезнут: значения лимитов вложений и конфигурацию пользовательских полей. Они нужны для отчётности и, при необходимости, для ручного восстановления в новой модели.
* Обеспечить возможность сверки миграций: итоговые числа записей по каждому типу и контрольные выборки должны быть сохранены в артефактах T5.2.【F:docs/reports/data-inventory-2025-09-24.md†L49-L58】

## 4. План архивации по компонентам

### 4.1. Журнал `AuditLogEntry`

1. **Остановка генерации новых записей.** До миграции T2.1 отключить вызовы `AuditLogEntry.objects.log_action()` в коде, где события будут заменены новой логикой (`AuditFeedback`, пересчёт баллов). Это предотвращает появление новых записей на время архивации.【F:backend/audits/models.py†L1085-L1332】
2. **Конвертация полезных событий.**
   * Записи `audit.status_changed` преобразовать в компактную таблицу `AuditStatusHistory` (`audit_id`, `from_status`, `to_status`, `changed_at`, `changed_by`). Таблица используется только для аналитических отчётов и хранит максимум 5 записей на аудит.
   * События `audit.changes_requested` и `audit.reviewed` уже мигрируют в `AuditFeedback` по плану T1.2; подтвердить, что все записи перенесены и добавлены в историю возвратов.【F:docs/reports/audit-status-conversion-plan-t1-2.md†L79-L168】
   * События `offline.batch_*` агрегируются вместе с архивом `OfflineSyncBatch` (см. §4.2) и в журнале больше не нужны.
   * Записи `response.*`, `attachment.*`, `signature.*` не переносятся: архитектура 3.0 не требует сохранения поминутной истории CRUD-операций.【F:docs/architecture/v3.md†L75-L118】
3. **Экспорт архива.** Перед удалением таблицы сформировать CSV/Parquet выгрузку с полями `action`, `entity_type`, `entity_id`, `payload`, `created_at`, сохранив её в каталоге `deploy/artifacts/legacy-logs/` с подписью даты выгрузки. Доступ — только команде сопровождения.
4. **Удаление и чистка.**
   * Создать миграцию, которая удалит модель `AuditLogEntry`, менеджер и связанные тесты после подтверждения успешной конвертации.
   * Удалить ротацию логов `offline_sync_file` из настроек `LOGGING`, чтобы не создавать пустые файлы после отключения офлайна.【F:backend/config/settings/base.py†L164-L233】

### 4.2. Таблица `OfflineSyncBatch` и связанные логи

1. **Выключение клиентских источников.**
   * Удалить регистрацию сервис-воркера, офлайн-формы и JS-хранилище в UI (T3.1) одновременно с закрытием API `api/offline-sync/`, чтобы новые пакеты не создавались.【F:backend/static/js/service-worker.js†L1-L112】【F:backend/audits/views.py†L585-L644】【F:backend/config/urls.py†L10-L18】
   * На время архивации перевести эндпоинт в режим read-only (возврат 410) и логировать обращения для контроля.
2. **Экспорт диагностических данных.**
   * Сформировать два набора выгрузок: `offline_batches_success.csv` (PK, пользователь, устройство, вид payload, размер, дата применения) и `offline_batches_errors.csv` (дополнительно статус HTTP, флаг отправки уведомления, детали ошибки).
   * Сохранить лог `offline-sync-errors.log` и приложить его в архив (zip). После проверки удалить файл и настройки логера.
3. **Очистка таблицы.** После подтверждения экспорта выполнить миграцию, которая:
   * удаляет модель `OfflineSyncBatch` и связанные фабрики/тесты;
   * снимает внешние ключи/индексы на журнал;
   * обнуляет поля `is_offline_cached` и `offline_uuid` в `AuditResponse`/`AuditAttachment`, поскольку офлайн-поток исчезает.【F:docs/reports/data-inventory-2025-09-24.md†L43-L47】【F:backend/audits/models.py†L629-L785】
4. **Новая отчётность по инцидентам.** Взамен офлайн-журнала добавить отчёт «ошибки возврата» на основе `AuditFeedback` и статуса `draft` для контроля качества без отдельной таблицы.

### 4.3. Дополнительные настройки и справочники

1. **AttachmentLimitConfiguration.**
   * Зафиксировать текущие значения (таблица маленькая, достаточно одной записи) в YAML/JSON файле `deploy/artifacts/attachment-limits.json` и приложить к документации эксплуатации.
   * После подтверждения, что архитектура 3.0 использует статические лимиты (8 МБ / 10 / 100), удалить модель, админку и вызовы `AttachmentLimitConfiguration.get_cached_overrides()`, сохранив дефолты в настройках.【F:backend/audits/models.py†L22-L174】【F:docs/reports/data-inventory-2025-09-24.md†L37-L47】
2. **ObjectInfoField.**
   * Экспортировать текущий набор полей в CSV (`code`, `label`, `field_type`, `is_required`, `order`, `choices`) и приложить к архиву.
   * Для действующих аудитов поле `Audit.object_info` остаётся источником данных; новые аудиторы будут вводить обязательные реквизиты напрямую в модели `Building`/`Elevator` или текстовые поля аудита. После миграции удалить модель, CRUD-представления и связанные шаблоны.【F:backend/catalog/models.py†L550-L603】【F:docs/architecture/v3.md†L37-L83】
3. **Конфигурация логирования.** Удалить переменные окружения и обработчики, связанные с офлайн-логами (`DJANGO_SYNC_LOG_FILE`, `DJANGO_SYNC_LOG_MAX_BYTES`, `audits.offline_sync` logger). Это исключит ложные предупреждения после удаления офлайна.【F:backend/config/settings/base.py†L164-L233】
4. **Прочие артефакты.** Очистить статические файлы, связанные с офлайн-режимом (`offline-storage.js`, `offline-checklist.js`, сервис-воркер), а также URL'ы и тесты, чтобы избежать неиспользуемых зависимостей.

## 5. Этапы реализации

1. **Подготовка (T1 → T2).**
   * Заморозить создание новых офлайн-пакетов и записей журнала через временные флаги в настройках/feature toggles.
   * Снять метрики объёма (количество записей в `AuditLogEntry`, `OfflineSyncBatch`, размер лог-файла) и приложить к артефактам этапа.
2. **Миграции данных (T2.1).**
   * Реализовать миграции `AuditStatusHistory`, `AuditFeedback`, очистить офлайн-поля в ответах/вложениях.
   * Выполнить экспорт архивов и сохранить их в `deploy/artifacts/` с контрольными суммами (SHA256).
3. **Удаление кода (T2.1/T3.1).**
   * Удалить модели, API, сервис-воркер и представления.
   * Обновить документацию пользователей и runbook'и, исключив инструкции по офлайну.
4. **Верификация (T5.2).**
   * На копии боевой базы повторить экспорт и миграции, сверить контрольные суммы, убедиться в отсутствии записей в старых таблицах после финального релиза.
   * Smoke-тесты подтверждают, что создание и отправка аудита работают без офлайн-функций.

## 6. Проверки и контроль качества

* Автоматические тесты (`pytest`, `ruff`, `manage.py check`) выполняются после внедрения миграций, чтобы гарантировать отсутствие неиспользуемых импортов и валидность моделей.
* SQL-проверки: сравнение количества записей до/после архивации и проверка отсутствия ссылочной целостности на удалённые таблицы.
* Ручная проверка архивов: выборочная расшифровка CSV/логов и сопоставление с живой системой перед окончательным удалением.

## 7. Риски и меры снижения

1. **Потеря аудиторского следа.** — До удаления `AuditLogEntry` убедиться, что `AuditStatusHistory` и `AuditFeedback` покрывают регуляторные требования; при необходимости сохранить дополнительно «журнал событий» в read-only схеме БД.
2. **Недостаточная диагностика ошибок после отключения офлайна.** — Добавить мониторинг возвратов аудитов и логирование ошибок загрузки вложений в основной лог приложения.
3. **Необратимая потеря настроек.** — Архивировать `AttachmentLimitConfiguration` и `ObjectInfoField` до удаления моделей; документировать значения в руководстве эксплуатации.
4. **Расхождение в расчёте баллов.** — После очистки офлайн-полей убедиться, что `AuditResponse` и `AuditAttachment` корректно пересчитывают итоговый балл по новой логике (`Audit.calculate_score()`).【F:docs/architecture/v3.md†L75-L83】

## 8. Выходные артефакты T1.3

* Настоящий план архивации.
* Скрипты/SQL для выгрузки `AuditLogEntry`, `OfflineSyncBatch`, `AttachmentLimitConfiguration`, `ObjectInfoField`.
* Шаблон отчёта о миграции с контрольными суммами архивов (используется в T5.2).
* Обновлённая запись в `AGENTS.md` со статусом задачи T1.3 и ссылкой на этот документ.
