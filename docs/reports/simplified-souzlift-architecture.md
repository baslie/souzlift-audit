# Концепция упрощённой версии «Союзлифт Аудит»

## 1. Контекст и цель
Текущая реализация проекта разрослась до многофункциональной платформы: сложная матрица статусов аудитов, офлайн-синхронизация с сервис-воркерами, расширенные журналы событий, почтовые уведомления, отдельный кабинет администратора с десятками экранов. Такой «комбайн» сложно поддерживать, дорабатывать и обучать новых пользователей. Целью данного документа является формирование целевого упрощённого дизайна («downgrade»), который закрывает базовые потребности: администратор управляет объектами и чек-листами, аудитор заполняет проверки.

## 2. Основные симптомы избыточности
- **Избыточные роли и сценарии**: текущая архитектура допускает одновременно несколько видов администраторов, технических операторов и офлайн-клиентов. Для базовой веб-системы нужны только две роли — администратор и аудитор.
- **Сложный жизненный цикл аудита**: переходы `draft → in_progress → submitted → reviewed → changes_requested → ...` увеличивают число состояний и специальных кнопок. Для минимальной версии достаточно двух состояний: «черновик» и «отправлен».
- **Интеграция офлайн-режима и приложений**: REST-эндпоинты, сервис-воркер, пакеты синхронизации и мониторинг ошибок создают большую инфраструктурную нагрузку и требуют поддержки клиентов.
- **Глубоко вложенный справочник чек-листа**: пять связанных моделей (категория → секция → вопрос → варианты баллов → настройки комментария) усложняют конструирование, хотя исходные данные `data.csv` показывают плоскую структуру «категория → пункт → шкала».
- **Тяжёлый интерфейс администратора**: множество экранов (модерация, отчёты, настройки лимитов, журналы) перегружают пользователя и требуют сложной навигации.
- **Жёсткие ограничения и уведомления**: лимиты вложений, подписанные ссылки, email-оповещения об ошибках — всё это несёт операционные риски и требует отдельного мониторинга.

## 3. Принципы упрощения
1. **Только базовые роли**: администратор (управление справочниками и чек-листами) и аудитор (ввод данных). Никаких технических операторов, офлайн-клиентов, суперадминов.
2. **Минимальный жизненный цикл**: аудит существует в двух состояниях — черновик (аудитор редактирует) и отправлен (заблокирован для аудитора, доступен администратору для просмотра). При необходимости правок администратор переводит запись обратно в черновик.
3. **Плоский чек-лист**: структура из трёх уровней — категория, вопрос, шкала баллов. Комментарий либо обязателен флагом, либо опционален; дополнительных сущностей не нужно.
4. **Фокус на онлайне**: система работает только в браузере, без офлайн-режима и фоновых синхронизаций.
5. **Простая отчётность**: без сложных журналов и экспортов; достаточно таблиц и простого CSV.
6. **Минимум кастомного фронтенда**: стандартные Django-шаблоны или любой лёгкий UI-фреймворк, чтобы администратор сразу видел знакомый интерфейс.

## 4. Предлагаемая упрощённая архитектура
### 4.1. Сущности данных
| Сущность | Назначение | Связи |
| --- | --- | --- |
| `Building` | Здание с адресом и ответственным лицом | 1:M к `Elevator`, 1:M к `Audit` |
| `Elevator` | Лифт, принадлежащий зданию | M:1 к `Building`, 1:M к `Audit` |
| `ChecklistTemplate` | Заголовок набора пунктов (например, «Стандартный аудит») | 1:M к `ChecklistItem` |
| `ChecklistItem` | Конкретный пункт проверки; поля: категория, текст вопроса, шкала (`min_score`, `max_score`, шаг) или список текстовых опций, флаг обязательного комментария | M:1 к `ChecklistTemplate` |
| `Audit` | Факт проверки лифта. Поля: здание, лифт, исполнитель, состояние (`draft/submitted`), дата проведения, итоговый балл, заметки администратора | M:1 к `Building`, `Elevator`, `User` |
| `AuditResponse` | Ответ на пункт чек-листа: ссылка на `ChecklistItem`, числовой балл или выбранная опция, комментарий | M:1 к `Audit`, `ChecklistItem` |

Такой набор покрывает требования из `data.csv` без дополнительных сущностей (`ScoreOption`, `ObjectInfoField`, лимиты вложений). При необходимости вложений их можно хранить одной моделью `AuditAttachment` без токенов и сложных проверок.

### 4.2. Роли и полномочия
- **Администратор**:
  - создаёт и редактирует здания/лифты;
  - импортирует или вручную формирует чек-листы (загрузка CSV → создание `ChecklistTemplate` и `ChecklistItem`);
  - назначает аудиторам объекты (создание аудита, выбор лифта и чек-листа);
  - просматривает результаты и добавляет комментарии;
  - возвращает аудит в состояние черновика при необходимости доработки.
- **Аудитор**:
  - видит список назначенных ему аудитов в статусе черновик;
  - открывает форму чек-листа, заполняет баллы и комментарии;
  - сохраняет черновик или отправляет аудит (после отправки запись только для чтения).

### 4.3. Пользовательские сценарии
1. **Администратор создаёт чек-лист**: загружает CSV → система парсит строки в категории/вопросы/шкалы → можно вручную добавить/отредактировать пункты.
2. **Администратор ведёт справочник объектов**: простые формы создания/редактирования зданий и лифтов без модерации.
3. **Назначение аудита**: выбирается лифт и чек-лист, назначается исполнитель и дедлайн. Создаётся запись `Audit` в статусе черновик.
4. **Аудитор заполняет аудит**: открывает форму, последовательно отвечает на вопросы, может сохранить черновик. По завершении нажимает «Отправить» → статус `submitted`.
5. **Администратор просматривает результаты**: таблица аудитов с фильтрами по статусу и исполнителю, карточка аудита с итоговым баллом и комментариями. Возможность вернуть в черновик с пояснением.
6. **Экспорт**: одна кнопка «Скачать CSV» по результатам выбранного аудита или списка.

### 4.4. Интерфейсные решения
- **Общая панель**: минимум разделов — «Здания», «Лифты», «Чек-листы», «Аудиты». Разделы «Чек-листы» и «Аудиты» видят обе роли, но с разным набором действий.
- **Формы Django**: использовать стандартные formset’ы для чек-листа и inline-formset для ответов.
- **Без сложных табов и модальных окон**: все действия на отдельных страницах. Мобильная адаптация — базовая.

## 5. Техническая реализация
- **Backend**: оставить Django, но сократить приложения. Достаточно `accounts`, `catalog` (здания/лифты), `checklists`, `audits`. Удалить сервисы офлайн-синхронизации, журналов, кастомные токены скачивания.
- **Frontend**: Tailwind можно заменить на стандартный Bootstrap (или оставить Tailwind, но использовать базовые компоненты). Исключить Alpine.js/HTMX, если нет динамики.
- **Файлы и вложения**: использовать стандартные поля FileField с прямой раздачей через Django без подписанных URL.
- **Отчётность**: генерация CSV через стандартный `csv.writer`, отказ от XLSX и сложных шаблонов.
- **Уведомления**: минимальные — по желанию оставить письмо «аудит отправлен».

## 6. План перехода от текущего к упрощённому решению
1. **Определить обязательные функции**: провести с заказчиком сессию, подтвердить, что достаточно ролей «администратор» и «аудитор», статусной модели `draft/submitted`, отсутствия офлайна.
2. **Подготовить миграцию данных**:
   - упростить таблицы (слияние категорий/секций/вопросов → `ChecklistItem`);
   - убрать поля модерации, лимитов, офлайн-идентификаторов;
   - конвертировать статусы аудитов (`in_progress`, `reviewed`, `changes_requested`) в `draft` или `submitted` по правилам.
3. **Переписать UI**: удалить кабинет администратора 2.0, оставить общий дашборд с четырьмя разделами.
4. **Обновить права доступа**: убрать миксины для ролей сверх двух базовых, пересмотреть middleware принудительной смены пароля (не критично для базовой версии).
5. **Удалить сервис-воркер и offline API**: убрать маршруты, модели `OfflineSyncBatch`, `AuditLogEntry`, связанные шаблоны.
6. **Сократить тестовый контур**: оставить unit-тесты для CRUD операций и жизненного цикла аудита; удалить Playwright/pytest E2E для кабинета администратора.
7. **Простая отчётность**: внедрить скачивание CSV непосредственно из списка аудитов.

## 7. Ожидаемый результат
- Простая архитектура, понятная небольшой команде поддержки.
- Быстрый onboarding пользователей: администратор видит только нужные ему справочники и чек-листы; аудитор — свои проверки.
- Сокращение времени разработки и тестирования за счёт уменьшения количества сущностей, статусов и интеграций.
- Возможность постепенно добавлять функциональность (офлайн, расширенные отчёты) только при подтверждённой необходимости.

## 8. Следующие шаги
1. Провести воркшоп с заинтересованными лицами для финализации минимального набора функций.
2. Подготовить roadmap миграции с оценкой трудозатрат и рисков.
3. Сформировать прототип интерфейса (Figma или простые мокапы) по четырём ключевым разделам.
4. Запустить пилот на одном регионе или отделении для проверки гипотез.
