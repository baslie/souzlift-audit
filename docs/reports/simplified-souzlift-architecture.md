# Концепция упрощённой версии «Союзлифт Аудит»

## 1. Контекст и цель
Текущая реализация проекта разрослась до многофункциональной платформы: сложная матрица статусов аудитов, офлайн-синхронизация с сервис-воркерами, расширенные журналы событий, почтовые уведомления, отдельный кабинет администратора с десятками экранов. Такой «комбайн» сложно поддерживать, дорабатывать и обучать новых пользователей. Целью данного документа является формирование целевого упрощённого дизайна («downgrade»), который закрывает базовые потребности: администратор управляет объектами и чек-листами, а аудитор заполняет проверки.

### 1.1. Рабочие гипотезы
- продукт используется преимущественно в онлайне с ноутбуков и планшетов; требования к офлайн-доступу и мобильным приложениям откладываются;
- чек-лист не содержит ветвлений: по данным `data.csv` достаточно фиксированных шкал баллов и текстовых критериев для каждой записи;
- роль администратора совмещает методолога (конструирует чек-лист) и оператора (назначает проверки и анализирует результаты);
- аудиторы не нуждаются в исторических версиях чек-листов — изменения применяются к будущим аудитам.

### 1.2. Не в фокусе
- интеграции с внешними системами и API;
- расширенные отчёты, агрегирующие данные по регионам и периодам;
- централизованная модерация и аудит действий пользователей.

## 2. Основные симптомы избыточности
- **Избыточные роли и сценарии**: текущая архитектура допускает одновременно несколько видов администраторов, технических операторов и офлайн-клиентов. Для базовой веб-системы нужны только две роли — администратор и аудитор.
- **Сложный жизненный цикл аудита**: переходы `draft → in_progress → submitted → reviewed → changes_requested → ...` увеличивают число состояний и специальных кнопок. Для минимальной версии достаточно двух состояний: «черновик» и «отправлен».
- **Интеграция офлайн-режима и приложений**: REST-эндпоинты, сервис-воркер, пакеты синхронизации и мониторинг ошибок создают большую инфраструктурную нагрузку и требуют поддержки клиентов.
- **Глубоко вложенный справочник чек-листа**: пять связанных моделей (категория → секция → вопрос → варианты баллов → настройки комментария) усложняют конструирование, тогда как фактический набор `data.csv` использует два уровня группировки — зону (например, «Холл», «МП») и категорию качества («Комфорт», «Безопасность», «Эстетика и сервис») — и дальше сразу вопросы с диапазонами баллов.
- **Тяжёлый интерфейс администратора**: множество экранов (модерация, отчёты, настройки лимитов, журналы) перегружают пользователя и требуют сложной навигации.
- **Жёсткие ограничения и уведомления**: лимиты вложений, подписанные ссылки, email-оповещения об ошибках — всё это несёт операционные риски и требует отдельного мониторинга.

## 3. Принципы упрощения
1. **Только базовые роли**: администратор (управление справочниками и чек-листами) и аудитор (ввод данных). Никаких технических операторов, офлайн-клиентов, суперадминов.
2. **Минимальный жизненный цикл**: аудит существует в двух состояниях — черновик (аудитор редактирует) и отправлен (заблокирован для аудитора, доступен администратору для просмотра). При необходимости правок администратор переводит запись обратно в черновик.
3. **Плоский чек-лист**: без вложенных таблиц — `ChecklistItem` хранит зону (`area`), категорию (`category`), текст вопроса, шкалу (`min_score`, `max_score`, шаг) или список текстовых опций, флаг обязательного комментария и вес. Если требуется вариативность (например, «да/нет/неприменимо»), она задаётся в поле `options` самой сущности без дочерних моделей.
4. **Фокус на онлайне**: система работает только в браузере, без офлайн-режима и фоновых синхронизаций.
5. **Простая отчётность**: без сложных журналов и экспортов; достаточно таблиц и прямых выгрузок в CSV/XLS/XLSX.
6. **Готовые UI-компоненты**: использовать Bootstrap или аналогичный набор компонентов с темизацией через SCSS/CSS-переменные, чтобы быстро менять визуальный стиль без тяжёлого кастомного фронтенда.
7. **Эволюционная сложность**: каждая новая функция добавляется только после явного запроса заказчика и оценки влияния на простую архитектуру.

## 4. Предлагаемая упрощённая архитектура

### 4.1. Сущности данных
| Сущность | Назначение | Связи |
| --- | --- | --- |
| `Building` | Здание с адресом и ответственным лицом | 1:M к `Elevator`, 1:M к `Audit` |
| `Elevator` | Лифт, принадлежащий зданию | M:1 к `Building`, 1:M к `Audit` |
| `ChecklistTemplate` | Заголовок набора пунктов (например, «Стандартный аудит») | 1:M к `ChecklistItem` |
| `ChecklistItem` | Конкретный пункт проверки; поля: зона (`area`), категория (`category`), текст вопроса, шкала (`min_score`, `max_score`, шаг) или список текстовых опций, флаг обязательного комментария, поле `weight` для расчёта итогового балла | M:1 к `ChecklistTemplate` |
| `Audit` | Факт проверки лифта. Поля: здание, лифт, исполнитель, состояние (`draft/submitted`), ссылка на версию чек-листа, дата проведения, итоговый балл, заметки администратора | M:1 к `Building`, `Elevator`, `User` |
| `AuditResponse` | Ответ на пункт чек-листа: ссылка на `ChecklistItem`, числовой балл или выбранная опция, комментарий, дата обновления | M:1 к `Audit`, `ChecklistItem` |

Такой набор покрывает требования из `data.csv` без дополнительных сущностей (`ScoreOption`, `ObjectInfoField`, лимиты вложений). При необходимости вложений их можно хранить одной моделью `AuditAttachment` без токенов и сложных проверок. Версионирование чек-листов достигается копированием `ChecklistTemplate` при значительных изменениях — старые аудиты продолжают ссылаться на предыдущую версию.

### 4.2. Роли и полномочия
- **Администратор**:
  - создаёт и редактирует здания/лифты, может загружать их из CSV/XLSX для первичного наполнения;
  - импортирует или вручную формирует чек-листы (загрузка CSV → создание `ChecklistTemplate` и `ChecklistItem`);
  - назначает аудиторам объекты (создание аудита, выбор лифта и чек-листа) и управляет бэклогом для самостоятельного взятия в работу;
  - просматривает результаты и добавляет комментарии;
  - возвращает аудит в состояние черновика при необходимости доработки.
- **Аудитор**:
  - видит список назначенных ему аудитов в статусе черновик и может взять свободный аудит из общего списка доступных объектов;
  - открывает форму чек-листа, заполняет баллы и комментарии;
  - сохраняет черновик или отправляет аудит (после отправки запись только для чтения).

### 4.3. Пользовательские сценарии
1. **Администратор создаёт чек-лист**: загружает CSV → система парсит строки в зоны/категории/вопросы/шкалы → можно вручную добавить/отредактировать пункты.
2. **Администратор ведёт справочник объектов**: простые формы создания/редактирования зданий и лифтов без модерации плюс массовый импорт из CSV/XLSX.
3. **Назначение аудита**: выбирается лифт и чек-лист, назначается исполнитель и дедлайн либо аудит помещается в общий пул. Создаётся запись `Audit` в статусе черновик. При назначении фиксируется версия чек-листа (копия метаданных) для избежания расхождений при будущих правках.
4. **Аудитор заполняет аудит**: открывает форму, последовательно отвечает на вопросы, может сохранить черновик или взять свободный аудит из пула. По завершении нажимает «Отправить» → статус `submitted`. Валидация проверяет обязательные комментарии и заполнение всех пунктов.
5. **Администратор просматривает результаты**: таблица аудитов с фильтрами по статусу и исполнителю, карточка аудита с итоговым баллом и комментариями. Возможность вернуть в черновик с пояснением.
6. **Экспорт**: кнопки «Скачать CSV/XLS/XLSX» по результатам выбранного аудита или списка.

### 4.4. Интерфейсные решения
- **Общая панель**: минимум разделов — «Здания», «Лифты», «Чек-листы», «Аудиты». Разделы «Чек-листы» и «Аудиты» видят обе роли, но с разным набором действий. Для наглядности применяется один и тот же layout, но доступные кнопки фильтруются по роли.
- **Формы Django**: использовать стандартные formset’ы для чек-листа и inline-formset для ответов, стилизуя их компонентами Bootstrap и переопределяемыми темами.
- **Без сложных табов и модальных окон**: все действия на отдельных страницах. Мобильная адаптация — базовая.

### 4.5. API и интеграции
- REST- или GraphQL-слой отсутствует на первом этапе. Если партнёры потребуют выгрузку, открывается один read-only эндпоинт `/api/audits/export` с токеном доступа.
- Вебхуки и синхронизации с мобильными устройствами считаются будущими расширениями; их дизайн документируется отдельно, чтобы не усложнять ядро.

## 5. Техническая реализация
- **Backend**: оставить Django, но сократить приложения. Достаточно `accounts`, `catalog` (здания/лифты), `checklists`, `audits`. Удалить сервисы офлайн-синхронизации, журналов, кастомные токены скачивания. Чек-лист хранится в одной схеме, а вычисление итогового балла инкапсулировано в методе `Audit.calculate_score()`.
- **Frontend**: перейти на Bootstrap или сопоставимый UI-kit с возможностью настройки темы через SCSS и CSS-переменные. Исключить Alpine.js/HTMX, если нет динамики. Для форм используется `django-crispy-forms` или стандартные formsets, обёрнутые в готовые компоненты Bootstrap.
- **Файлы и вложения**: использовать стандартные поля FileField с прямой раздачей через Django без подписанных URL. Дополнительная безопасность обеспечивается за счёт проверки прав доступа в представлениях.
- **Отчётность**: генерация CSV/XLS/XLSX через стандартные библиотеки (`csv`, `openpyxl`/`xlwt`) без сложных шаблонов. Для выборок свыше нескольких тысяч строк допускается background-задача на Celery, но внедряется только при необходимости.
- **Уведомления**: минимальные — по желанию оставить письмо «аудит отправлен». Шаблоны писем хранятся как обычные Django-шаблоны без отдельного конструктора.

## 6. План перехода от текущего к упрощённому решению
1. **Определить обязательные функции**: провести с заказчиком сессию, подтвердить, что достаточно ролей «администратор» и «аудитор», статусной модели `draft/submitted`, отсутствия офлайна. Зафиксировать решения в отдельном протоколе, чтобы избежать возврата к избыточной архитектуре.
2. **Подготовить миграцию данных**:
   - упростить таблицы (слияние категорий/секций/вопросов → `ChecklistItem`);
   - убрать поля модерации, лимитов, офлайн-идентификаторов;
   - конвертировать статусы аудитов (`in_progress`, `reviewed`, `changes_requested`) в `draft` или `submitted` по правилам;
   - пересчитать итоговые баллы на основе новых весов и шкал.
3. **Переписать UI**: удалить кабинет администратора 2.0, оставить общий дашборд с четырьмя разделами на Bootstrap-компонентах. Подготовить низкодетализированные макеты (wireframes), чтобы согласовать навигацию до начала разработки.
4. **Обновить права доступа**: убрать миксины для ролей сверх двух базовых, пересмотреть middleware принудительной смены пароля (не критично для базовой версии). Проверить политики загрузки файлов и удаления аудитов.
5. **Удалить сервис-воркер и offline API**: убрать маршруты, модели `OfflineSyncBatch`, `AuditLogEntry`, связанные шаблоны. Зафиксировать в release notes, что офлайн не поддерживается.
6. **Сократить тестовый контур**: оставить unit-тесты для CRUD операций и жизненного цикла аудита; удалить Playwright/pytest E2E для кабинета администратора. Взамен добавить smoke-тесты, проверяющие основные сценарии.
7. **Простая отчётность**: внедрить скачивание CSV/XLS/XLSX непосредственно из списка аудитов. При необходимости расширить отчёт о результатах простым pivot-экспортом в будущем.
8. **Импорт данных**: реализовать мастера загрузки CSV/XLSX для чек-листов и каталогов зданий/лифтов с предварительным предпросмотром и журналом ошибок.
9. **Обучение пользователей**: подготовить короткое видео или PDF с walkthrough нового интерфейса, чтобы закрыть ожидания по онбордингу.

## 7. Ожидаемый результат
- Простая архитектура, понятная небольшой команде поддержки.
- Быстрый onboarding пользователей: администратор видит только нужные ему справочники и чек-листы; аудитор — свои проверки.
- Сокращение времени разработки и тестирования за счёт уменьшения количества сущностей, статусов и интеграций.
- Возможность постепенно добавлять функциональность (офлайн, расширенные отчёты) только при подтверждённой необходимости.

## 8. Следующие шаги
1. Провести воркшоп с заинтересованными лицами для финализации минимального набора функций.
2. Подготовить roadmap миграции с оценкой трудозатрат и рисков.
3. Сформировать прототип интерфейса (Figma или простые мокапы) по четырём ключевым разделам.
4. Запустить пилот на одном регионе или отделении для проверки гипотез.

## 9. Риски и вопросы для согласования
- **Переходные данные**: требуется убедиться, что текущие аудиты можно однозначно переложить в модель `draft/submitted`, иначе придётся хранить архив в старой схеме.
- **Регуляторные требования**: если есть нормативы по хранению истории изменений чек-листа или аудитов, придётся добавить аудит-лог как отдельный сервис.
- **Нагрузка на администраторов**: совмещение ролей методолога и оператора может привести к перегрузке. При подтверждении риска стоит предусмотреть лёгкое деление прав (например, read-only администраторы).
- **Потребность в офлайн**: если хотя бы часть аудиторов работает без стабильного интернета, необходимо заранее описать альтернативный процесс (бумажные формы, Excel) до появления новой версии.
