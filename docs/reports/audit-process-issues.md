# Критический обзор бизнес-логики аудиторского процесса

## Общие наблюдения
Сценарии аудита формально поддерживают весь путь от черновика до отметки «просмотрено», но ключевые контрольные точки реализованы только частично. Несколько решений на уровне модели и пользовательского интерфейса снижают управляемость процесса и усложняют совместную работу администратора и аудитора. Ниже перечислены наиболее критичные несоответствия.

## Найденные проблемы

### 1. Запрос правок не оформлен как стадия жизненного цикла
* **Что происходит.** Метод `request_changes()` проверяет, что аудит уже отправлен, записывает сообщение в журнал и рассылает письмо, но не меняет статус и не фиксирует новую стадию обработки.【F:backend/audits/models.py†L240-L350】【F:backend/audits/models.py†L524-L560】 В результате запись остаётся в состоянии `submitted`.
* **Почему это проблема.** Администратор не отличит аудит с открытыми правками от свежей отправки; аудитор не видит, что задача перешла в доработку. Любые отчёты по статусам будут считать такие аудиты завершёнными.
* **Рекомендации.** Ввести отдельный статус «требует правок»/`changes_requested`, переводить аудит в него и указывать дату/инициатора запроса. После повторной отправки возвращать в очередь на проверку.

### 2. Факт проверки не сохраняется в данных аудита
* **Что происходит.** У модели нет полей `reviewed_by` и `reviewed_at`; метод `mark_reviewed()` лишь меняет статус и пишет событие в журнал, опираясь на `updated_at` как прокси-время.【F:backend/audits/models.py†L252-L311】【F:backend/audits/models.py†L500-L522】 Реестр проверок хранится только в логах, доступ к которым ограничен.
* **Почему это проблема.** Невозможно построить отчёт «кто и когда проверил», провести ретроспективу или подтвердить исполнителя при внешнем контроле. При массовых операциях журнал сложно использовать как источник истины.
* **Рекомендации.** Добавить явные поля `reviewed_by`, `reviewed_at`, обновлять их при подтверждении, выводить в списке аудитов и экспортных отчётах.

### 3. Данные аудита остаются редактируемыми после отправки и даже после просмотра
* **Что происходит.** `AuditResponse.save()` и связанные модели не проверяют статус аудита — ответы, комментарии и вложения можно менять в любой момент.【F:backend/audits/models.py†L660-L746】 Offline-синхронизация повторно сохраняет ответы без ограничений, даже если запись уже в состоянии `submitted` или `reviewed`.【F:backend/audits/api.py†L344-L416】 Статус при этом не возвращается в «в работе», уведомления не отправляются.
* **Почему это проблема.** Отчёты, выгруженные администратором, могут не совпасть с данными, которые позже скорректировал аудитор. Нарушается принцип неизменности отправленного акта и прослеживаемость изменений.
* **Рекомендации.** Блокировать изменение ответов и вложений после отправки; для доработки переводить аудит в новую стадию и заново запускать цикл проверки. При попытке синхронизации защищённого аудита — возвращать ошибку или требовать явного «перевода в работу» от администратора.

### 4. Аудитор не видит историю запросов правок в интерфейсе
* **Что происходит.** Форма администратора обещает, что сообщение попадёт «в письмо и в журнал», но пользовательский журнал (`AuditLogEntryListView`) доступен только роли администратора.【F:backend/audits/forms.py†L10-L24】【F:backend/audits/views.py†L859-L868】 Для аудитора остаётся лишь письмо.
* **Почему это проблема.** При потере письма или работе из офлайна аудитор не может восстановить требования к доработке, нет сквозной истории коммуникации в продукте.
* **Рекомендации.** Открыть журнал или отдельную ленту событий для автора аудита, отображать последние комментарии администратора прямо в списке/карточке аудита.

## Итог
Без доработок перечисленных блоков процесс аудита остаётся непрозрачным: статусы не отражают реальное состояние задач, факты проверки и доработки фиксируются только в технических логах, а данные могут изменяться постфактум. Рекомендуемые изменения сосредоточены на сохранении управляемости и юридической значимости аудита: расширить модель статусами и атрибутами проверки, ввести блокировки на правку после отправки и предоставить сторонам прозрачный канал коммуникации внутри системы.
