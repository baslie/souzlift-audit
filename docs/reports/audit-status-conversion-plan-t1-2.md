# Правила преобразования статусов аудитов к модели draft/submitted (T1.2)

_Дата подготовки: 25.09.2025 (assistant)_

## 1. Цель и рамки задачи

Этап T1.2 определяет, как существующий жизненный цикл аудита с четырьмя статусами (`draft → in_progress → submitted → reviewed`) и вспомогательными механизмами обратной связи должен быть приведён к целевой двухстадийной модели `draft/submitted`. Архитектура 3.0 требует, чтобы аудитор работал с черновиком и отправлял итоговый отчёт, а администратор мог вернуть аудит в черновик с пояснением без ввода дополнительных статусов.【F:docs/architecture/v3.md†L11-L44】 Настоящий документ фиксирует правила преобразования статусов, связанные с ними данные и требования к обратной связи, которые будут реализованы в миграциях этапов T2.1/T5.2.

## 2. Текущее состояние

* Модель `Audit` хранит статусы `draft`, `in_progress`, `submitted`, `reviewed`, жёстко ограничивает переходы между ними и автоматически расставляет метки времени `started_at`/`finished_at` при продвижении статуса вперёд.【F:backend/audits/models.py†L227-L360】
* Метод `request_changes()` не меняет статус, но логирует событие `audit.changes_requested` и рассылает письма с требованием доработки; статус остаётся `submitted`, а текст запроса хранится только в журнале и письме.【F:backend/audits/models.py†L524-L569】【F:backend/audits/emails.py†L85-L112】
* Метод `mark_reviewed()` переводит аудит в `reviewed`, записывает событие `audit.reviewed` и отправляет уведомление автору.【F:backend/audits/models.py†L480-L522】【F:backend/audits/emails.py†L58-L83】
* Журнал `AuditLogEntry` фиксирует события изменения статуса и запросов правок, что создаёт зависимость миграции от истории статусов.【F:backend/audits/models.py†L1085-L1157】
* Сигналы и e-mail уведомления полагаются на текущие статусы: отправка письма при `submitted` и отдельное уведомление при `reviewed`.【F:backend/audits/signals.py†L13-L35】【F:backend/audits/emails.py†L35-L112】
* В отчётах и административных панелях используются фильтры и агрегаты по всем четырём статусам, в том числе метрики «в работе» и «просмотрены».【F:backend/audits/admin.py†L225-L296】【F:backend/audits/services.py†L180-L241】

## 3. Целевая модель жизненного цикла

1. Сохраняются только статусы `draft` и `submitted`. Статус `draft` охватывает как первоначальные черновики, так и возвращённые на доработку аудиты.【F:docs/architecture/v3.md†L11-L44】
2. Администратор переводит аудит в `submitted` после отправки или возвращает его обратно в `draft`, оставляя обязательный комментарий. Карточка аудита отображает историю обратной связи, чтобы аудитор понимал причину возврата.【F:docs/architecture/v3.md†L35-L43】
3. Метки времени переопределяются:
   * `started_at` фиксирует момент первого изменения аудита (создание ответа, загрузка вложения). Оно не зависит от статуса, но заполняется автоматически, если ранее было пустым.
   * `submitted_at` заменяет `finished_at` и указывает последнюю фактическую отправку.
   * `returned_at` (новое поле) фиксирует последнее возвращение в черновик администратором.
4. Поле `admin_comment` (новое) хранит актуальное пояснение администратора. Для истории возвращений создаётся таблица `AuditFeedback` (`audit_id`, `comment`, `left_by`, `left_at`, `type`), чтобы хранить каждое действие возврата или подтверждения без возрождения полного журнала действий.【F:docs/architecture/v3.md†L66-L83】
5. Метрика «просмотрено» заменяется вычисляемым признаком `last_reviewed_at`, который заполняется при просмотре администратором, но не влияет на статус (опциональное поле без пользовательского статуса).

## 4. Правила преобразования данных

### 4.1. Сопоставление статусов

| Текущий статус | Новый статус | Дополнительные действия |
| --- | --- | --- |
| `draft` | `draft` | `submitted_at`/`returned_at` обнуляются; при наличии комментариев из `AuditFeedback` (созданных на шаге 4.3) сохраняем только последний как активный. |
| `in_progress` | `draft` | Статус меняется на `draft`. `started_at` сохраняется. Если `finished_at` заполнен из-за ошибок данных, переносим в `submitted_at` и оставляем статус `submitted` (см. валидацию миграции). |
| `submitted` | `submitted` | Значение `finished_at` переносится в `submitted_at`. `admin_comment` очищается, `returned_at` остаётся `NULL`. |
| `reviewed` | `submitted` | `finished_at` переносится в `submitted_at`. Создаётся запись `AuditFeedback` с типом `review_confirmation` (без обязательного текста) по данным журнала `audit.reviewed`. |

### 4.2. Возвраты и комментарии

* События `audit.changes_requested` извлекаются из журнала для построения записей `AuditFeedback` с типом `return_to_draft` и текстом комментария. Если после события аудит был переведён в `draft`, миграция фиксирует `returned_at` временем события; иначе статус обновляется на `draft` и считается, что возвращение произошло вместе с уведомлением.【F:backend/audits/models.py†L524-L569】【F:backend/audits/models.py†L1089-L1104】
* Если для одного аудита существует несколько запросов правок подряд, формируется последовательность `AuditFeedback`. Самый свежий комментарий переносится в `admin_comment`, предыдущее остаётся только в истории.
* Для аудитов без записей `audit.changes_requested`, но с ручным переводом статуса на `draft`, `returned_at` заполняется значением `updated_at` записи (при условии, что оно позже `submitted_at`).

### 4.3. Конвертация журналов и уведомлений

1. `audit.status_changed` остаётся источником событий, но значения `from/to` нормализуются в `draft/submitted`. Все записи переводов в `in_progress` и `reviewed` переписываются с учётом карты из таблицы 4.1.
2. `audit.reviewed` и `audit.changes_requested` архивируются в `AuditFeedback`. После миграции эти типы событий удаляются из модели `AuditLogEntry` в рамках T1.3 (архивация журналов).【F:backend/audits/models.py†L1089-L1104】
3. Почтовые уведомления:
   * `notify_audit_submitted` остаётся без изменений, но использует `submitted_at` для выводимых дат.
   * `notify_audit_reviewed` заменяется уведомлением `notify_audit_returned` (новая функция), которое отправляется при возврате аудита в `draft` и включает комментарий администратора.
   * Уведомление `notify_audit_changes_requested` удаляется после переноса логики в новый процесс возврата.【F:backend/audits/emails.py†L35-L112】
4. Сигнал `trigger_audit_status_notifications` упрощается до двух веток: отправка письма при переходе в `submitted` и при возврате в `draft` (если статус меняется с `submitted`).【F:backend/audits/signals.py†L13-L35】

## 5. Изменения доменной модели и API

1. Обновить модель `Audit`:
   * Заменить `finished_at` на `submitted_at` (новое поле с миграцией данных).
   * Добавить поля `returned_at`, `admin_comment`, `last_reviewed_at`, `last_reviewed_by` (опционально) и связанный менеджер для `AuditFeedback`.
   * Удалить методы `start()`/`mark_reviewed()`; сохранить `submit()` и добавить `return_to_draft(comment, actor)` для обработки возврата с валидацией обязательного комментария.
   * Метод `request_changes()` переводит аудит в `draft`, обновляет `returned_at` и создаёт запись `AuditFeedback` вместо отдельного события журнала.
2. Пересмотреть сервисы и фильтры:
   * В админ-панели заменить показатели «в работе» и «просмотрено» на агрегации по `draft`/`submitted`, а количество возвратов отображать на основе `AuditFeedback` (например, «возвращены к доработке»).【F:backend/audits/admin.py†L225-L296】
   * В API фильтров (`build_audit_filter_snapshot`) оставить только два статуса и добавить отдельный фильтр `returned=true/false`, рассчитываемый по наличию актуального комментария и `returned_at`.【F:backend/audits/services.py†L210-L241】
3. В публичных представлениях и шаблонах скрыть кнопки, связанные со статусами `in_progress`/`reviewed`, и заменить их действиями «Отправить» и «Вернуть в черновик» с обязательным полем комментария.
4. Для совместимости с этапом T2.1 подготовить API/ORM слой, который временно поддержит чтение старых статусов, но при записи всегда использует новую модель (см. §4.4).

## 6. Стратегия миграции данных

1. **Подготовительная миграция схемы.** Добавить новые поля (`submitted_at`, `returned_at`, `admin_comment`, `last_reviewed_at`, `last_reviewed_by`) и таблицу `AuditFeedback`. Создать перечисление `AuditFeedback.FeedbackType` (`return_to_draft`, `review_confirmation`).
2. **Сбор исходных событий.** На уровне миграции `RunPython` получить выборки записей `AuditLogEntry` для типов `audit.status_changed`, `audit.changes_requested`, `audit.reviewed`, отсортированных по времени.
3. **Перенос статусов.**
   * Применить карту из §4.1 для статусов аудитов.
   * Перенести `finished_at` в `submitted_at`, обнулить старое поле.
   * Обновить `started_at`: если оно пустое, но есть ответы (`AuditResponse`), заполнить минимальной датой ответа.
4. **Формирование обратной связи.**
   * Для каждой записи `audit.changes_requested` создать `AuditFeedback` и, если последующий `audit.status_changed` переводит аудит в `draft`, задать `returned_at` соответствующей датой. При отсутствии статуса `draft` после запроса правок — инициировать переход на `draft` и обновить `returned_at` датой события.
   * Для `audit.reviewed` создать `AuditFeedback` с типом `review_confirmation` и обновить `last_reviewed_at`/`last_reviewed_by`.
5. **Очистка журналов.** После формирования `AuditFeedback` пометить записи `audit.changes_requested` и `audit.reviewed` для архивации (удаление или перенос в отдельную таблицу в задаче T1.3).
6. **Валидация.**
   * Проверить, что все аудиты имеют статус только `draft` или `submitted`.
   * Сравнить счётчики статусов до/после миграции (ожидается: `draft_new = draft_old + in_progress_old`, `submitted_new = submitted_old + reviewed_old`).
   * Убедиться, что количество сформированных `AuditFeedback` совпадает с количеством записей `audit.changes_requested` + `audit.reviewed`.

## 7. Обновление процессов и UI

* **Администратор**: форма возврата в черновик включает обязательное поле комментария, сохраняемое в `AuditFeedback`. История возвращений отображается в карточке аудита и при необходимости — в списке аудитов как индикатор «возвращён N раз».
* **Аудитор**: при открытии аудита в статусе `draft` отображаются последние комментарии администратора и дата возврата. После повторной отправки `admin_comment` очищается, но история доступна.
* **Уведомления**: письмо об отправке направляется администраторам, письмо о возврате — аудитору с текстом комментария; после повторной отправки уведомления обрабатываются повторно (с обновлёнными датами).
* **Отчётность**: экспорт CSV/Excel включает поля `status`, `submitted_at`, `returned_at`, количество возвращений, последний комментарий. Это позволит аналитике отслеживать скорость обработки без отдельного статуса `reviewed`.

## 8. Риски и допущения

1. **Неполные журналы.** Если в базе отсутствуют записи `audit.changes_requested`, восстановить текст комментария невозможно. В таких случаях `AuditFeedback` создаётся без текста, а администратор должен будет внести комментарий вручную после миграции (список аудитов без комментария формируется отчётом).
2. **Расхождения в датах.** Возможны записи, где `finished_at` раньше `started_at`. Миграция фиксирует такие случаи отчётом, а значения корректируются (например, `started_at = finished_at`).
3. **Сторонние интеграции.** Если внешние системы фильтруют аудиты по статусу `reviewed`, их необходимо заранее уведомить о переходе на новый набор статусов и предоставить поле `last_reviewed_at` для аналитики.
4. **Параллельные изменения.** Пока этап T2.1 не реализован, кодовая база должна поддерживать чтение старых статусов. Для этого вводится временный слой совместимости: перечисление статусов в API допускает старые значения при чтении, но отвечает новыми.

## 9. Выходные артефакты этапа

* Настоящий документ — вход для миграций и обновления процессов (T2.1, T3.3, T4.1).
* Спецификация `AuditFeedback` и требований к API/формам для возврата аудита.
* План архивации журналов `AuditLogEntry` в рамках T1.3, основанный на преобразованных данных (перечень записей, подлежащих переносу или удалению).
