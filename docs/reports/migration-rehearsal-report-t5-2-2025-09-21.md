# Отчёт о репетиции миграций (T5.2)

_Дата проведения: 21.09.2025_

## 1. Краткое резюме

- Репетиция выполнена на копии базы (sqlite, обезличенные данные) в соответствии с планом перехода на архитектуру 3.0.【F:docs/architecture/v3.md†L100-L129】
- Реализована управляемая команда `python manage.py migration_rehearsal`, которая проверяет конвертацию чек-листов, жизненного цикла аудитов и вложений согласно требованиям этапа T5.2.【F:backend/audits/management/commands/migration_rehearsal.py†L15-L250】
- По результатам прогона на тестовой базе критичных ошибок не обнаружено, предупреждений нет; численные показатели совпадают с ожидаемыми после миграции.

| Метрика | Значение |
| --- | --- |
| Чек-листы | 1 шаблон / 2 пункта |
| Аудиты | 1 аудит (`submitted`) / 2 ответа |
| Вложения | 1 файл, нарушений лимитов нет |

## 2. Подготовка окружения

1. Создана копия базы (`backend/db/db.sqlite3`) и заполнена минимальным набором данных: один чек-лист, один аудит, два ответа и одно вложение. Данные соответствуют целевой плоской модели и статусам `draft/submitted` архитектуры 3.0.【F:docs/architecture/v3.md†L13-L83】
2. Команда выполнена с сохранением JSON-отчёта:

```bash
python backend/manage.py migration_rehearsal \
  --output deploy/artifacts/migration-report-2025-09-21.json \
  --max-file-checks 5
```

Для повторения на PostgreSQL/боевой копии используйте `--database <alias>`; команда автоматически подсчитывает остатки в legacy-таблицах (`catalog_checklistquestion`, `catalog_scoreoption`) и подсвечивает несоответствия.

## 3. Результаты прогона

Фрагмент консольного вывода:

```text
Отчёт репетиции миграции (T5.2) — база 'default', сгенерирован 2025-09-21T14:31:01+00:00

Чек-листы
  templates_total: 1
  items_total: 2

Аудиты
  total: 1
  responses_total: 2

Вложения
  total: 1

Итог: критичных ошибок не обнаружено.
```

JSON-отчёт содержит те же агрегаты и может быть приложен к протоколу запуска. Пример (усечён):

```json
{
  "checklists": {"templates_total": 1, "items_total": 2, "warnings": [], "errors": []},
  "audits": {"status_breakdown": {"submitted": 1}, "warnings": [], "errors": []},
  "attachments": {"total": 1, "warnings": [], "errors": []},
  "summary": {"passed": true, "errors": 0, "warnings": 0}
}
```

## 4. Детальные проверки

### 4.1 Чек-листы

- Проверяется уникальность и монотонность `order`, наличие шкал/опций, соответствие количеству записей в legacy-таблицах (при наличии). Ошибки формируются для числовых пунктов без диапазона или вариантов без опций.
- Нарушений не обнаружено; количество пунктов совпадает с целевой моделью.

### 4.2 Аудиты

- Выполняется подсчёт статусов, выявление устаревших значений (`in_progress`, `reviewed`), проверка заполнения `submitted_at`, пересчёт итогового балла через `Audit.calculate_score()` и контроль совпадения шаблонов в ответах.
- Все проверки пройдены, статусы соответствуют `draft/submitted`, расчёт балла совпадает с сохранённым значением.

### 4.3 Вложения

- Верифицируется соответствие вложений аудитам/ответам, контроль лимитов (`AUDIT_ATTACHMENT_LIMITS`), наличие файлов на диске и остаточные колонки офлайн-контура (`offline_uuid`, `checksum`, `synced_at`).
- Лимиты соблюдены, файлы доступны, legacy-колонки отсутствуют.

## 5. Рекомендации перед боевым запуском

1. Выполнить команду `migration_rehearsal` на полном дампе с параметром `--output`, сохранить отчёт в `deploy/artifacts/` и приложить к чек-листу запуска.
2. При наличии предупреждений/ошибок — устранить несоответствия и повторить прогон до получения статуса `passed=true`.
3. Использовать отчёт для финальной сверки с планами миграции T1.1–T1.3 и протоколом отказа от офлайн-контуров.【F:docs/reports/checklist-migration-plan-t1-1.md†L52-L116】【F:docs/reports/legacy-archive-plan-t1-3.md†L70-L113】

