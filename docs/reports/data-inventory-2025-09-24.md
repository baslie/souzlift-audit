# Инвентаризация данных перед переходом на архитектуру 3.0

_Дата подготовки: 24.09.2025 (assistant)_

## 1. Цель и контекст

Задача этапа T0.2 — собрать факты о текущей схеме и объёмах данных, чтобы подготовить миграции к целевой архитектуре 3.0. Целевая модель сокращает число сущностей: чек-лист становится плоским (`ChecklistItem`), жизненный цикл аудита сжимается до `draft/submitted`, а журналы и офлайн-синхронизация исключаются из ядра решения.【F:docs/architecture/v3.md†L11-L107】 Ниже отражены исходные таблицы и особенности, которые необходимо учесть при преобразовании.

## 2. Чек-листы и связанные справочники

### 2.1. Иерархия чек-листа

| Сущность | Назначение | Ключевые поля и ограничения |
| --- | --- | --- |
| `ChecklistCategory` | Верхний уровень группировки, управляется по уникальному `code` и `order` (используется для импорта и сортировки). | Уникальный `code`, поле `order` с индексом для сортировки.【F:backend/catalog/models.py†L272-L299】 |
| `ChecklistSection` | Логические блоки внутри категории. | FK на категорию, уникальность `order` в пределах категории для стабильной сортировки.【F:backend/catalog/models.py†L302-L340】 |
| `ChecklistQuestion` | Конечные элементы чек-листа. Поддерживают типы `score/boolean/text`, хранят `max_score`, подсказки и признак обязательного комментария. | Уникальность `order` в пределах секции, валидация диапазонов и обязательности комментария через метод `validate_answer()`.【F:backend/catalog/models.py†L343-L469】 |
| `ScoreOption` | Таблица вариантов баллов для вопросов типа `score`. | Уникальность комбинаций (`question`, `order`) и (`question`, `score`); проверка, что балл не превышает `max_score`.【F:backend/catalog/models.py†L472-L547】 |

В текущей реализации вопросы зависят от иерархии «категория → секция → вопрос → варианты баллов». При переходе на `ChecklistItem` потребуется объединить данные всех уровней и перенести шкалы оценок из `ScoreOption` напрямую в новую модель.

### 2.2. Информационная карточка объекта

Дополнительно используется справочник `ObjectInfoField` для настройки произвольных полей в карточке лифта (тип поля, обязательность, порядок и набор вариантов). Эти сведения копируются в JSON-поле `Audit.object_info` при создании аудита и должны быть проанализированы на предмет сохранения в новой схеме или архивации.【F:backend/catalog/models.py†L550-L603】【F:backend/audits/models.py†L252-L264】

### 2.3. Экспортированные данные чек-листа

Файл `data.csv` хранит актуальную версию вопросника, содержащую разделы «Оповещение, освобождение», «Комфорт», «Техническое состояние», «Эстетика и сервис» и «Безопасность». Каждая строка описывает вопрос, диапазон баллов и текстовые критерии, включая вопросы с максимальными баллами 30 и 163 балла для отдельных показателей безопасности.【F:data.csv†L1-L61】 Эти значения нужно перенести в новую шкалу, сохранив обязательность комментариев и критические пороги.

## 3. Аудиты и жизненный цикл

### 3.1. Модель `Audit`

* Статусы: `draft`, `in_progress`, `submitted`, `reviewed`; переходы разрешены только вперёд, что отражено в `_STATUS_TRANSITIONS`. Переходы автоматически заполняют `started_at`/`finished_at` и запрещают завершение раньше старта.【F:backend/audits/models.py†L227-L390】
* Связанные поля: FK на лифт, JSON со срезом `object_info`, плановая дата, отметки времени создания/обновления и агрегированный `total_score`. Эти поля нужно преобразовать в минималистичную схему с двумя статусами, сохранив возможность хранения временных меток выполнения.

### 3.2. Ответы, вложения и подписи

* `AuditResponse` хранит ответы аудитора, включает уникальность по (`audit`, `question`), признак `is_offline_cached` и пересчитывает общий балл при изменениях.【F:backend/audits/models.py†L596-L740】 Потребуется заменить ссылку на `ChecklistQuestion` ссылкой на `ChecklistItem` и сохранить логику пересчёта баллов.
* `AuditAttachment` использует отдельное защищённое хранилище, лимиты по количеству/размеру и офлайн-UUID для синхронизации. Текущие дефолтные ограничения: 8 МБ на файл, до 10 файлов на ответ и до 100 на аудит; они могут быть переопределены через `AttachmentLimitConfiguration`.【F:backend/audits/models.py†L22-L173】【F:backend/audits/models.py†L757-L905】 При переходе необходимо решить, сохраняем ли мы конфигурацию лимитов или переходим к статическим настройкам.
* `AuditSignature` позволяет прикреплять изображение подписи к аудиту и ведёт историю изменений через журнал. Нужно решить, будет ли подпись частью минимальной модели или перейдёт в архив.【F:backend/audits/models.py†L954-L1045】

## 4. Журналы действий и офлайн-синхронизация

* `AuditLogEntry` фиксирует широкий спектр событий (создание аудита, изменения статуса, CRUD ответов/вложений, действия с подписями, офлайн-пакеты). Таблица индексируется по типу сущности, действию и дате, что создаёт заметный объём при активной эксплуатации.【F:backend/audits/models.py†L1085-L1157】 Архитектура 3.0 предлагает избавиться от детализированного журнала, поэтому потребуется определить минимальный набор событий, который нужно сохранить либо выгрузить в архив.
* `OfflineSyncBatch` хранит пакеты офлайн-синхронизации с полями `payload`, `response_payload`, хэшами, статусами применения и состоянием уведомлений об ошибках. Модель тесно связана с журналом и логированием ошибок через `sync_logger`. Для отказа от офлайна необходимо очистить эту таблицу, сохранить историю ошибок (по необходимости) и удалить зависимости от сервис-воркера.【F:backend/audits/models.py†L1160-L1379】
* Дополнительные следы офлайна: флаг `is_offline_cached` в ответах и поле `offline_uuid` в вложениях, а также структура логов в настройках (`AUDIT_ATTACHMENT_LIMITS`, `DJANGO_SYNC_LOG_FILE`). Эти поля можно обнулить после миграции, когда офлайн-процессы будут отключены.【F:backend/audits/models.py†L629-L633】【F:backend/audits/models.py†L779-L785】【F:backend/config/settings/base.py†L167-L227】

## 5. Рекомендуемые метрики объёма для подготовки миграций

| Объект | Что посчитать | Как получить |
| --- | --- | --- |
| Чек-лист | Количество категорий, секций, вопросов и вариантов баллов; максимальные значения баллов. | `python manage.py shell -c "from catalog.models import ChecklistCategory, ChecklistSection, ChecklistQuestion, ScoreOption; print(ChecklistCategory.objects.count(), ...)"` — запуск на копии боевой базы. |
| Аудиты | Общее число аудитов по статусам, распределение по годам, доля заполненных `object_info`. | `python manage.py shell -c "from audits.models import Audit; print(Audit.objects.values('status').annotate(total=Count('id')))"`. |
| Ответы и вложения | Количество ответов на аудит, использование флага `is_offline_cached`, число вложений и долю с `offline_uuid`. | Аналогичные агрегаты для `AuditResponse` и `AuditAttachment`. |
| Журналы и офлайн-пакеты | Число записей `AuditLogEntry` по действиям, объём `OfflineSyncBatch` в статусе `pending/error`. | Агрегирующие запросы через ORM или SQL, дополнительно — объём лог-файла `offline-sync-errors.log`. |

Фактические значения следует зафиксировать при подключении к копии производственной базы (этап T5.2). Эти цифры понадобятся, чтобы оценить длительность миграций, потребность в архивации и потенциальное влияние на производительность.

## 6. Выводы для миграционного плана

1. **Плоский чек-лист**: необходимо объединить категории, секции и вопросы в `ChecklistItem`, сохранив порядок (`order`) и дополнительные инструкции. Варианты баллов переходят в структуру поля `options`, а максимальные значения — в шкалу `min/max/step` новой модели.【F:docs/architecture/v3.md†L45-L83】
2. **Жизненный цикл аудита**: текущие статусы `draft → in_progress → submitted → reviewed` нужно отобразить на двухцелевую схему (`draft/submitted`), предусмотрев хранение времени начала/завершения и механизма возврата в черновик вместо отдельного статуса `reviewed`.【F:docs/architecture/v3.md†L13-L55】【F:backend/audits/models.py†L227-L390】
3. **Удаление офлайна и журналов**: таблицы `OfflineSyncBatch` и `AuditLogEntry` содержат данные, которые после перехода станут избыточными. Требуется подготовить архив либо агрегированные выгрузки, чтобы сохранить историю инцидентов при необходимости, и убедиться, что бизнес-процессы не зависят от этих таблиц.【F:docs/architecture/v3.md†L75-L108】【F:backend/audits/models.py†L1085-L1379】
4. **Конфигурация вложений**: нужно решить, переносить ли `AttachmentLimitConfiguration` в новую архитектуру или заменить на статические лимиты. При сохранении функциональности потребуется миграция значений и чистка ссылок на офлайн-UUID.【F:backend/audits/models.py†L22-L173】【F:backend/audits/models.py†L757-L905】

Документ служит входом для задач T1.1–T1.3: по итогам инвентаризации можно уточнить правила преобразования чек-листа, статусов и архивирования устаревших сущностей.
