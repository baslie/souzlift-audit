# Архитектура 4.0 — «полевой» контур Союзлифт Аудит

## 1. Контекст и мотивация

Архитектура 3.0 сократила избыточность первых версий проекта: убрала офлайн-сервис, оставила две роли (администратор и аудитор),
сфокусировалась на онлайн-работе и плоском чек-листе. Однако фактический процесс эксплуатации остаётся более гибким, чем то,
что предлагает текущий продукт:

* аудиторы планируют обходы самостоятельно, без заранее назначенного расписания;
* адресный справочник неполон — часть объектов приходится заносить «на лету»;
* заполнение чек-листа происходит в местах с нестабильной связью, поэтому черновики должны сохраняться на клиенте до отправки;
* требуется массовое прикрепление фото (до 10 на вопрос) с автоматическим сжатием на сервере;
* администратору важно видеть итоговые аудиты, но он не управляет ежедневным планированием;
* команду не устраивает неявная логика расчёта баллов — правила должны быть описаны и повторяемы.

Архитектура 4.0 формализует «полевую» модель: аудитор быстро создаёт аудит по адресу, заполняет унифицированный чек-лист,
добавляет медиа и синхронизирует результаты, а администратор курирует справочники и анализирует статус выполненных работ.

## 2. Цели и критерии успеха

1. **Поддержка автономной работы аудитора.** Никаких обязательных назначений; аудитор может начать аудит из списка объектов или
ввести новый адрес вручную.
2. **Устойчивость к потере связи.** Все черновые данные и прикрепления хранятся в браузере до успешной синхронизации.
3. **Единый чек-лист и понятный расчёт оценки.** Баллы считаются по диапазонам и весам, описанным в шаблоне; отчёты показывают
процент заполнения по зонам.
4. **Управляемая медиабиблиотека.** Не более 10 фото на вопрос, размер каждого файла до 8 МБ, сервер автоматически создаёт
просмотрные копии.
5. **Прозрачность для администратора.** Дашборд с последними аудитами, прогрессом выполнения и датой последней правки.
6. **Отсутствие лишних ролей и интеграций.** Как и в 3.0, только администратор и аудитор; внешние API остаются опциональными.

Успех подтверждается завершением пилотного периода: аудиторы закрывают ≥90% плановых объектов в срок, ни один аудит не теряется
из‑за обрыва связи, а администратор формирует ежемесячный отчёт без ручных доработок в Excel.

## 3. Пользователи и ответственность

| Роль | Обязанности |
|------|-------------|
| **Аудитор** | Создаёт аудит по адресу (из подсказок или вручную), фиксирует параметры лифта (грузоподъёмность, комментарии),
заполняет чек-лист, прикладывает фото, отправляет отчёт. Может возвращаться к своим черновикам и видеть историю отправок. |
| **Администратор** | Ведёт каталог адресов и типовых параметров лифтов, обновляет единый чек-лист, анализирует отправленные аудиты,
при необходимости возвращает их в доработку. Держит в актуальном состоянии словари для автозаполнения. |

Технический суперпользователь Django остаётся только для сопровождения.

## 4. Основные пользовательские сценарии

### 4.1 Аудитор

1. **Старт аудита.** Выбирает адрес из подсказок (быстрый поиск по улицам/домам) или вводит новый. Сразу фиксирует подъезд,
грузоподъёмность (из справочника значений администратора) и время начала. Эти поля обязательны.
2. **Черновое сохранение.** Все введённые данные пишутся в браузерный кеш (IndexedDB) каждые 5 секунд и при переходе к следующему
вопросу. При восстановлении сессии черновик подхватывается автоматически.
3. **Заполнение чек-листа.** Вопросы группируются по зоне (например, «Холл», «МП», «Противовес»). На каждой карточке отображается
прогресс (ответов / всего и % от максимального веса зоны). Комментарии остаются необязательными.
4. **Работа с фото.** Для каждого вопроса можно прикрепить до 10 изображений. Файлы предварительно сохраняются в IndexedDB, на
сервер отправляются пачками; бекенд по завершении формирует сжатую копию (WebP/JPEG) и хранит оригинал.
5. **Отправка аудита.** При наличии связи все данные выгружаются, статусы меняются на `submitted`, черновой кеш очищается. При
ошибке синхронизации пользователю показывается журнал и предложение повторить отправку.
6. **История и корректировка.** В личном кабинете отображаются последние аудиты, дата/время последней правки, статус и оценка.
Черновики можно открыть повторно; отправленные аудиты доступны только для чтения до возврата администратором.

### 4.2 Администратор

1. **Поддержание справочников.** Управляет каталогом адресов (улица, дом, подъезд), типовых грузоподъёмностей и шаблонов лифтов.
Любое значение, добавленное аудиторами, проходит модерацию и после утверждения попадает в подсказки.
2. **Редактирование чек-листа.** Использует конструктор: загружает CSV (структура как в `data.csv`) либо редактирует вручную.
Каждому пункту задаёт диапазон оценок, шаг, вес и признак обязательного комментария.
3. **Мониторинг аудитов.** На дашборде видит список отправленных проверок с фильтрами по статусу, адресу, аудитору и диапазону
дат. Для каждого аудита отображаются итоговый балл, прогресс по зонам, дата последней правки, комментарии и вложения.
4. **Возврат на доработку.** Может вернуть аудит в `draft` с указанием причины; аудитор получает уведомление в интерфейсе и может
докорректировать ответы.
5. **Экспорт и аналитика.** Выгружает отчёты по адресам, зонам и аудиторам. Экспорт формирует как исходные баллы, так и
нормализованные проценты по зонам.

## 5. Доменная модель

| Сущность | Назначение | Основные поля и связи |
|----------|------------|-----------------------|
| `AddressEntry` | Поддерживаемый адрес (улица, дом, подъезд). Используется для подсказок, может быть добавлен аудитором и отправлен
на модерацию. | `street`, `house_number`, `entrance`, `status`, `created_by`, `approved_by`. |
| `ElevatorProfile` | Карточка лифта на адресе: описание, грузоподъёмность, заметки. Множественные лифты на одном адресе поддерживаются
через связь с `AddressEntry`. | `address`, `identifier` (необязательный), `capacity`, `notes`, `status`. |
| `CapacityPreset` | Набор доступных значений грузоподъёмности, управляемый администратором. Используется для выпадающих списков при
создании аудита. | `value`, `label`, `is_active`, `order`. |
| `ChecklistTemplate` | Версия чек-листа. Только один шаблон помечается активным и доступен аудиторам. | `name`, `description`, `is_active`,
`published_at`. |
| `ChecklistItem` | Пункт проверки: зона, категория, диапазон баллов, вес, опции, флаг обязательного комментария. | `template`, `order`, `area`,
`category`, `question`, `score_type`, `min_score`, `max_score`, `step`, `options`, `weight`. |
| `AreaScore` | Агрегация по зоне для отчётов и прогресса. Связывает набор `ChecklistItem` с максимальной суммой баллов из столбца
«Максимальный балл» CSV. | `template`, `area`, `max_score`, `item_ids`. |
| `Audit` | Сессия проверки конкретного лифта. Создаётся аудитором, хранит статус, прогресс, отметки времени. | `address`, `elevator` (опционально),
`template`, `started_at`, `submitted_at`, `status`, `auditor`, `progress_percent`, `score_total`, `last_saved_at`. |
| `AuditResponse` | Ответ на пункт чек-листа. | `audit`, `item`, `numeric_answer` или `selected_option`, `comment`, `synced_at`. |
| `AuditAttachment` | Файл, прикреплённый к ответу или аудиту. Ограничения 10 файлов на вопрос, 8 МБ каждый. | `audit`, `response`, `file`, `thumbnail`,
`content_type`, `size`, `uploaded_by`. |
| `DraftSnapshot` | Серверная копия черновика (по желанию аудитора). Позволяет переносить данные между устройствами и служит резервной точкой при
поддержке. | `audit`, `payload` (JSON), `created_at`, `created_from` (браузер, версия). |

Сущности `Building`/`Elevator` из версии 3.0 трансформируются в `AddressEntry` и `ElevatorProfile`, чтобы отделить адрес от
конкретного оборудования и позволить аудиторам начинать работу даже без заранее заведённого лифта.

## 6. Чек-лист и расчёт оценки

* Чек-лист хранится в актуальной версии `ChecklistTemplate`. Каждому пункту присваивается зона (`area`) и вес (`weight`).
* Таблица `data.csv` показывает структуру: зоны «Холл», «Комфорт», «МП», «Противовес» и др. Столбец «Максимальный балл» указывает
суммарный вес зоны (например, 4 балла для «Холла», 71 — для блока «Комфорт», 163 — для машинного помещения). Эти значения
переносим в `AreaScore`.
* При сохранении ответа система пересчитывает два показателя:
  * **Фактический балл** — взвешенное среднее, как и в 3.0 (`∑ вес × значение / ∑ вес`).
  * **Прогресс зоны** — доля отвеченных пунктов с числовой оценкой относительно максимума `AreaScore.max_score`.
* Комментарии необязательны; валидация проверяет только диапазоны и шаги баллов. Для вопросов с вариантами возможно хранение
числового значения в опции (чтобы включать их в расчёт).
* Экспорт формирует два слоя данных: исходные значения (0/1/2/30) и нормализованные проценты по зонам и целому аудиту.

## 7. Клиентские приложения и UX

* **Стек.** Django Templates + Bootstrap 5 остаются базой, но форма аудита получает лёгкий SPA-подход с использованием
Stimulus/HTMX или Alpine.js (только для локального состояния). Основные страницы по‑прежнему серверные.
* **Локальное хранение.** Для аудиторской формы используется IndexedDB через библиотеку (например, Dexie). Каждая запись
содержит метаданные аудита, ответы, очередь файлов и отметку времени. При успешной синхронизации объект удаляется.
* **Резервное сохранение.** По кнопке «Сохранить в облаке» браузер отправляет снимок черновика на сервер (`DraftSnapshot`). Это
позволяет продолжить работу на другом устройстве.
* **Индикатор прогресса.** Верхняя панель показывает проценты по всему аудиту и по текущей зоне. Для незаполненных обязательных
параметров подсвечиваются предупреждения.
* **Работа с фото.** Перед отправкой файлы конвертируются в WebP (качество 85%) средствами браузера, если поддерживается,
иначе грузятся оригиналы. Сервер выполняет дополнительную оптимизацию (см. §8.2).
* **История изменений.** В карточке аудита отображаются временные отметки: создан, последняя синхронизация, отправлен, возвращён.

## 8. Серверная реализация

### 8.1 Backend (Django)

* Расширяем приложения `catalog` → `addresses` (для `AddressEntry`) и `audits` (новые поля `started_at`, `last_saved_at`,
`progress_percent`, `synced_at`).
* Добавляем REST эндпоинты (`/api/addresses/suggest`, `/api/audits/drafts/`, `/api/audits/{id}/sync/`) на DRF или лёгких CBV для
поддержки автоподстановки и синхронизации черновиков.
* Валидация грузоподъёмностей: хранится в `CapacityPreset`, но аудитор может ввести произвольное значение — оно сохраняется и
помечается как «требует модерации».
* Для расчёта прогресса вводим служебный сервис `AuditProgressCalculator`, который на основе `AuditResponse` и `AreaScore`
возвращает общий % и разрез по зонам.
* Логи синхронизации (`AuditSyncLog`) фиксируют попытки выгрузки с результатом (успех/ошибка) и используются для поддержки.

### 8.2 Работа с медиа

* Настройки `AUDIT_ATTACHMENT_LIMITS` выставляются по умолчанию на 8 МБ и 10 файлов на ответ. Дополнительно задаётся
`max_per_audit=120`, учитывая большое количество вопросов.
* После загрузки изображение обрабатывается воркером (Celery либо Django-Q) или синхронной задачей, если размер небольшой:
  1. Генерируется миниатюра 1280px по длинной стороне, сохраняется в поле `thumbnail`.
  2. Оригинал хранится без потерь для возможности скачивания.
  3. Метаданные (`content_type`, `size`, `width`, `height`) сохраняются для аудита.
* При удалении ответа каскадно удаляются все вложения.

### 8.3 Безопасность и права доступа

* Роли проверяются через `django-guardian` или простые пермишены: аудитор видит только свои черновики и отправленные работы;
администратор имеет полный доступ.
* Все API черновиков работают по JWT/Session + CSRF; на стороне клиента данные в IndexedDB шифруются с использованием Web Crypto
(ключ хранится в sessionStorage).
* Вложения проходят антивирусную проверку (ClamAV) и проверку расширения.

## 9. Инфраструктура и DevOps

* Продолжает использоваться односерверная конфигурация (Django + PostgreSQL + Nginx). Для файлов — локальное хранилище; при
масштабировании возможно подключение S3.
* Резервное копирование: база + каталог `media/`. Для IndexedDB критичен только клиент, поэтому сервер регулярно запрашивает
черновики у пользователей (через напоминания) и предлагает загрузить «облачную» копию.
* CI/CD дополнительно запускает линтер фронтенд-кода и интеграционные тесты синхронизации.
* Мониторинг пополняется метриками: количество несинхронизированных черновиков, объём загруженных медиа, распределение оценок.

## 10. План перехода

1. **Анализ и миграции (T0).**
   * Трансформировать `Building` → `AddressEntry`, `Elevator` → `ElevatorProfile`. Сохранить существующие данные и историю.
   * Перенести активный чек-лист в новую структуру, построить `AreaScore` на основе текущих зон и максимальных баллов.
2. **Бэкэнд (T1).** Реализовать API автоподстановки и синхронизации черновиков, обновить модели аудита и расчёта прогресса.
3. **Фронтенд (T2).** Внедрить форму аудита с локальным хранением, прогресс-баром и очередью загрузки фото.
4. **Медиа-конвейер (T3).** Настроить обработку изображений и квоты. Обновить политику хранения (очистка старых черновиков).
5. **Дашборд администратора (T4).** Добавить отчёты по зонам, фильтры, возврат на доработку, выгрузки.
6. **Пилот и сопровождение (T5).** Прогнать сценарии на группе аудиторов, собрать обратную связь, скорректировать веса.

## 11. Риски и вопросы

* **Надёжность локального хранения.** Требуется обучение аудиторов и автоматическое напоминание о выгрузке черновиков.
* **Объём медиа.** Массовые фото увеличивают размер бэкапов; нужно внедрить политику очистки старых вложений и возможное
архивирование на S3.
* **Качество адресного справочника.** При отсутствии модерации список подсказок может захламляться. Решение — обязательное
подтверждение администратором и регулярная проверка дублей.
* **Настройка весов.** Значения из `data.csv` нужно уточнить с методологами: некоторые строки содержат пустые «Максимальные баллы».
В шаблоне следует хранить явные веса, а не полагаться на экспорт.
* **Сопротивление изменениям.** Переход от назначений к самопланированию требует регламента KPI и мониторинга выполнения.

Документ описывает целевой контур архитектуры 4.0 и служит основой для планирования бэклога и миграций из версии 3.0.
