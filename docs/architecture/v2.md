# Архитектура 2.0 — «Союзлифт Аудит»

## 1. Контекст и цели

Цель второй версии архитектуры — устранить путаницу между ролевой моделью бизнес-процесса и технической ролью суперпользователя Django Admin. В новой схеме:

* суперпользователь (оператор хостинга) использует `/admin` только для заведений учётных записей и аварийного обслуживания;
* прикладной **администратор** (роль `ADMIN`) управляет справочниками, чек-листом и аудитами из пользовательского интерфейса;
* **аудитор** (роль `AUDITOR`) проводит проверки, заполняет чек-листы и синхронизирует результаты.

Таким образом, административный функционал переезжает из Django Admin в «кабинет администратора», а суперпользователь остаётся скрытым системным оператором.

## 2. Роли и ответственность

| Роль | Кто создаёт | Основные задачи |
|------|-------------|-----------------|
| **Суперпользователь Django** | Технический оператор | Создание пользователей и профилей, присвоение ролей, доступ к аварийному редактированию данных через `/admin`. |
| **Администратор** (`UserProfile.role = ADMIN`) | Суперпользователь | Управление справочниками зданий и лифтов, модерация заявок, конструирование чек-листов, просмотр/корректировка аудитов, выполнение аудита вместо аудитора при необходимости. |
| **Аудитор** (`UserProfile.role = AUDITOR`) | Суперпользователь | Проведение аудитов, работа офлайн, добавление объектов на модерацию. |

Ролевые признаки хранятся в модели `UserProfile`, а вспомогательные свойства `is_admin` и `is_auditor` упрощают проверку прав.【F:backend/accounts/models.py†L9-L79】 Ограничения на уровне представлений реализованы через `RoleRequiredMixin` и функции `restrict_queryset_for_user`, которые позволяют отдавать одну и ту же страницу аудиторам и администраторам с разной областью видимости данных.【F:backend/accounts/permissions.py†L1-L132】

## 3. Компонентная структура

* **accounts** — аутентификация, профили, проверки ролей, страницы кабинета и смены пароля.
* **catalog** — справочники зданий, лифтов и конструктор чек-листа (категории, секции, вопросы, варианты баллов, дополнительные поля объекта). Модели содержат статусы модерации и связи с авторами/утверждающими.【F:backend/catalog/models.py†L10-L633】
* **audits** — домен аудитов: статусная модель, ответы по вопросам, вложения, журнал действий, офлайн-синхронизация и экспорт отчётов.【F:backend/audits/models.py†L20-L1088】
* **templates/static** — пользовательские интерфейсы для кабинета аудитора/администратора, офлайн-формы и отчёты.

## 4. Доменные модели

### 4.1. Справочники объектов

* `Building` и `Elevator` хранят автора, статус модерации и данные подтверждения. Метод `visible_for_user` позволяет аудиторам видеть только утверждённые записи и собственные черновики, тогда как администраторы видят всё.【F:backend/catalog/models.py†L18-L269】
* В пользовательском интерфейсе список объектов фильтруется и снабжён модерацией, доступной администраторам, а аудиторы могут редактировать только собственные необработанные записи.【F:backend/catalog/views.py†L24-L239】

### 4.2. Конструктор чек-листа

Модели `ChecklistCategory`, `ChecklistSection`, `ChecklistQuestion`, `ScoreOption` и `ObjectInfoField` задают структуру анкеты и информационной карточки объекта.【F:backend/catalog/models.py†L272-L633】 В текущей реализации они редактируются через Django Admin, но данные уже используются в пользовательских шаблонах и офлайн-снапшотах.【F:backend/audits/services.py†L1-L168】

### 4.3. Аудиты

`Audit` хранит жизненный цикл проверки (черновик → в работе → отправлен → просмотрен), ссылки на лифт и автора, отметки времени и суммарный балл. Переходы между статусами валидируются внутри модели, а история фиксируется в `AuditLogEntry`. Ответы (`AuditResponse`) обеспечивают валидацию по типу вопроса и контролируют обязательность комментариев при снижении балла. Вложения (`AuditAttachment`) ограничены по размеру и количеству, а офлайн-пакеты (`OfflineSyncBatch`) сохраняют каждую синхронизацию вместе с результатом обработки.【F:backend/audits/models.py†L66-L1088】

## 5. Пользовательские сценарии

### 5.1. Онбординг аккаунтов

1. Суперпользователь создаёт учётную запись через `/admin`, заводит профиль и присваивает роль `ADMIN` или `AUDITOR`.
2. При первом входе пользователь перенаправляется на смену пароля и попадает в личный кабинет, где видит свою роль и основные ссылки.【F:backend/templates/accounts/dashboard.html†L1-L58】

### 5.2. Управление справочниками

* Аудиторы могут добавлять здания/лифты и отправлять их на модерацию; после утверждения запись становится видна всем.【F:backend/catalog/views.py†L140-L239】
* Администратор модератор видит очередь «ожидают утверждения», может менять статус, редактировать записи других пользователей и возвращать их на доработку.【F:backend/catalog/models.py†L60-L169】【F:backend/catalog/views.py†L93-L239】

### 5.3. Конструирование чек-листа (новый функционал)

В архитектуре 2.0 администратор получает отдельный раздел кабинета для управления чек-листом без обращения к `/admin`. Планируется добавить:

* страничные CRUD-представления для категорий, секций и вопросов на основе уже существующих моделей и Tailwind-компонентов;
* интерактивное управление порядком элементов (drag-and-drop или кнопки сортировки) с сохранением `order`;
* валидацию вариантов баллов и обязательности комментариев, аналогичную текущим правилам моделей, но в удобной форме.

Интерфейс использует сериализатор `build_checklist_structure()` для предпросмотра того, как анкета выглядит для аудитора.【F:backend/audits/services.py†L88-L168】

### 5.4. Проведение и контроль аудитов

* Аудиторы и администраторы видят список доступных аудитов, фильтруют их по статусу и периоду и могут перейти к деталям или экспорту.【F:backend/audits/views.py†L38-L200】
* Администратор может открыть любой аудит (через тот же интерфейс), изменить ответы/комментарии, отметить проблемные пункты или даже заполнить анкету, если аудит выполняется из офиса.
* Оффлайн-режим остаётся ключевым: перед проверкой клиент загружает снимок справочников и структуры чек-листа, а затем отправляет результаты на сервер через REST-эндпоинт `/api/offline-sync/`, который обрабатывает как текстовые данные, так и вложения с проверкой дубликатов и валидацией payload.【F:backend/audits/api.py†L28-L240】【F:backend/audits/services.py†L62-L168】

### 5.5. Модерация и аудит журнала

Каждое действие (создание аудита, изменение статуса, загрузка вложения) фиксируется в `AuditLogEntry`, что позволяет администраторам отслеживать историю и расследовать инциденты. При ошибках синхронизации отправляется email-уведомление и записывается структурированный лог, пригодный для мониторинга.【F:backend/audits/models.py†L320-L1088】

## 6. Интерфейсы

### 6.1. Django Admin

Используется только для служебных задач: создание пользователей, аварийное исправление данных и импорта/экспорта на уровне базы. Все остальные сценарии выводятся в пользовательский интерфейс, чтобы не требовать от прикладных администраторов знания админки.

### 6.2. Кабинет администратора

Разделы кабинета администратора включают:

* «Справочники» — списки зданий и лифтов с модерацией, уже реализованные в `catalog.views` и шаблонах.
* «Чек-лист» — новый раздел с конструктором вопросов, предпросмотром и историями изменений.
* «Аудиты» — расширенный список с доступом к редактированию, отметками о просмотре и экспортом.
* «Настройки» (дополнительно) — управление полями информационной карточки (`ObjectInfoField`) и ограничениями вложений.

### 6.3. Кабинет аудитора

Сохраняет текущий функционал: список собственных аудитов, офлайн-формы и доступ к справочникам с ограничениями. Общий шаблон кабинета автоматически показывает нужные ссылки в зависимости от роли пользователя.【F:backend/templates/accounts/dashboard.html†L16-L57】

## 7. Авторизация и разграничение доступа

* Ролевые миксины проверяют наличие профиля и соответствие требуемой роли до выполнения запроса; при отсутствии доступа поднимается `PermissionDenied` (HTTP 403).【F:backend/accounts/permissions.py†L50-L132】
* Выборки данных фильтруются: аудиторы видят только свои записи (или утверждённые справочники), администраторы — весь массив данных. Это реализовано на уровне ORM-менеджеров (`visible_for_user`) и миксинов выборок (`RoleQuerysetMixin`).【F:backend/catalog/models.py†L18-L169】【F:backend/accounts/permissions.py†L87-L132】
* При загрузке вложений офлайн-эндпоинт проверяет, что отправитель является автором ответа, и предотвращает дублирование за счёт хэша payload и `offline_uuid` вложений.【F:backend/audits/api.py†L132-L220】【F:backend/audits/models.py†L537-L721】

## 8. Офлайн-режим и синхронизация

1. Клиент получает снапшот справочников и чек-листа через `build_catalog_snapshot_for_user()` и `build_checklist_structure()` и кэширует данные в IndexedDB.【F:backend/audits/services.py†L62-L168】
2. При отправке результатов создаётся запись `OfflineSyncBatch`; успешные ответы помечаются статусом `applied`, ошибки — `error` с подробностями и email-уведомлением.【F:backend/audits/models.py†L932-L1088】【F:backend/audits/api.py†L64-L220】
3. После успешной синхронизации сервер возвращает фактические идентификаторы созданных объектов, чтобы клиент мог сопоставить локальные черновики с реальными записями.

## 9. Эксплуатация и мониторинг

* Логи аудита действий позволяют восстанавливать историю изменений в случае конфликтов или претензий.【F:backend/audits/models.py†L862-L931】
* Журнал `OfflineSyncBatch` даёт возможность отслеживать частоту ошибок офлайна и автоматизировать оповещения.
* Ограничения на вложения (до 8 МБ, 10 файлов на вопрос, 100 — на аудит) защищают диск и позволяют администратору контролировать качество фотофиксации.【F:backend/audits/models.py†L20-L638】

## 10. План перехода

1. **Выделить раздел «Чек-лист» в кабинете администратора.** Создать представления и шаблоны для CRUD операций над категориями, секциями, вопросами, вариантами и полями объекта; предусмотреть массовое изменение порядка и копирование секций.
2. **Расширить интерфейс аудитов для администраторов.** Добавить кнопки редактирования и статусы просмотра, а также возможность заполнения анкет от имени аудитора.
3. **Упростить Django Admin.** Оставить только управление пользователями и базовые модели, скрыв от прикладных администраторов чек-лист и каталоги.
4. **Документация.** Обновить пользовательское руководство и чек-листы эксплуатации, чтобы различие ролей было очевидно.

Следование этому плану позволит развести полномочия технического суперпользователя и прикладных ролей, уменьшив зависимость от `/admin` и сделав систему прозрачной для сотрудников.
