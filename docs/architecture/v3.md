# Архитектура 3.0 — упрощённая версия «Союзлифт Аудит»

## 1. Контекст и цели

Платформа «Союзлифт Аудит» эволюционировала в многофункциональный комплекс с офлайн-синхронизацией, расширенной матрицей ролей, журналами действий, кастомными лимитами вложений и отдельным кабинетом администратора. Поддержка такого решения требует значительных усилий: необходимо обучать пользователей сложной навигации, поддерживать сервис-воркер и REST-интерфейсы для офлайна, актуализировать многочисленные статусы аудитов и справочников.

Архитектура 3.0 описывает целевую «упрощённую» версию продукта. Её задача — сократить операционную сложность без потери ключевых бизнес-функций: администратор управляет объектами и чек-листами, назначает проверки и анализирует результаты, а аудитор проводит проверки и сдаёт отчёт. Документ консолидирует выводы из анализа текущего решения и концепции упрощения, зафиксированной в [simplified-souzlift-architecture.md](../reports/simplified-souzlift-architecture.md), и задаёт базовый контур для перехода.

## 2. Ключевые допущения и ограничения

1. **Работа только онлайн.** Приложение используется в браузере на ноутбуках и планшетах; офлайн-режим, мобильные приложения и службы синхронизации исключаются из ядра.
2. **Две прикладные роли.** Система обслуживает администратора и аудитора; технический суперпользователь Django выполняет только операции сопровождения и не описывается в бизнес-процессах.
3. **Плоская структура чек-листа.** Вместо иерархии «категория → секция → вопрос → варианты баллов» используется одна сущность `ChecklistItem` с зонами, категориями и параметрами шкалы.
4. **Минимальный жизненный цикл аудита.** Только два состояния: `draft` и `submitted`. Администратор может вернуть аудит в черновик, но дополнительные статусы («reviewed», «changes_requested») не используются.
5. **Упрощённые вложения и уведомления.** Вложения сохраняются напрямую через `FileField`, лимиты задаются в настройках, уведомления по email остаются опциональными.
6. **Простая отчётность.** Достаточно просмотра в интерфейсе и экспорта CSV/XLS/XLSX; сложные дашборды, отчётные шаблоны и журналы действий исключаются.
7. **Эволюционное расширение.** Каждая новая функция добавляется только после согласования влияния на простую архитектуру.

## 3. Роли и ответственность

| Роль | Основные задачи |
|------|-----------------|
| **Администратор** | Ведёт справочники зданий и лифтов, формирует чек-листы, назначает аудиты, просматривает результаты и при необходимости возвращает их в черновик. |
| **Аудитор** | Получает назначенные проверки или берёт задания из общего пула, заполняет чек-лист, прикладывает материалы, сохраняет черновики и отправляет итоговый отчёт. |

Суперпользователь Django остаётся в контуре сопровождения (создание аккаунтов, аварийное вмешательство), но не влияет на прикладные процессы.

## 4. Целевые пользовательские сценарии

### 4.1. Администратор

1. **Импорт или создание справочников.** Заполнение `Building` и `Elevator` вручную либо через загрузку CSV/XLSX. Предусматривается предпросмотр и журнал ошибок импорта.
2. **Формирование чек-листа.** Загрузка файла с вопросами или ручное редактирование `ChecklistTemplate` и связанных `ChecklistItem`. Поддерживается настройка зон, категорий, шкал и обязательных комментариев.
3. **Назначение аудитов.** Создание `Audit` в статусе `draft` с выбранными лифтом, чек-листом, исполнителем и дедлайном. В случае пула свободных задач исполнитель может не указываться — аудит остаётся доступен для взятия аудиторами.
4. **Контроль выполнения.** Таблица аудитов с фильтрами по статусу, объекту и пользователю. Просмотр карточки аудита, итогового балла и комментариев. При необходимости — перевод обратно в `draft` с пояснением.
5. **Экспорт данных.** Встроенные действия по выгрузке выбранного аудита или отфильтрованного списка в CSV/XLS/XLSX.

### 4.2. Аудитор

1. **Получение заданий.** Просмотр списка назначенных аудитов и общего пула. Возможность принять свободное задание.
2. **Заполнение чек-листа.** Форма с упорядоченными `ChecklistItem`, сохранение промежуточного результата (`draft`) и валидация обязательных комментариев.
3. **Отправка аудита.** После завершения проверок аудит переводится в `submitted` и становится доступным только для чтения для аудитора.
4. **Обратная связь.** При возврате аудита в `draft` администратор оставляет комментарий; аудитор исправляет и повторно отправляет.

## 5. Доменная модель

| Сущность | Назначение | Ключевые поля и связи |
| --- | --- | --- |
| `Building` | Здание с адресом и ответственным лицом | Название, адрес, контакт; связь 1:M с `Elevator`, 1:M с `Audit`. |
| `Elevator` | Конкретный лифт | Ссылка на `Building`, идентификаторы оборудования, статус эксплуатации. |
| `ChecklistTemplate` | Версия чек-листа | Название, описание, дата публикации, связь 1:M с `ChecklistItem`. |
| `ChecklistItem` | Пункт проверки | Поля `area`, `category`, текст вопроса, числовая шкала (`min_score`, `max_score`, `step`) или перечисление `options`, флаг `requires_comment`, `weight`. |
| `Audit` | Проверка лифта | Ссылки на `Building`, `Elevator`, чек-лист и исполнителя, статус (`draft/submitted`), дедлайн, итоговый балл, комментарий администратора. |
| `AuditResponse` | Ответ на пункт | Ссылки на `Audit` и `ChecklistItem`, числовой балл или выбранная опция, комментарий, отметки времени. |
| `AuditAttachment` (опционально) | Дополнительные материалы | Привязка к `AuditResponse` или `Audit`, файл, подпись пользователя. |

Версионирование обеспечивается копированием `ChecklistTemplate` при существенных изменениях. Старые аудиты продолжают ссылаться на прежнюю версию, новые получают актуальную структуру.

## 6. Компонентная структура

* **accounts** — аутентификация, профили пользователей, фильтрация доступа по ролям, общий дашборд.
* **catalog** — справочники `Building` и `Elevator`, импорты из CSV/XLSX, базовые списки и формы редактирования.
* **checklists** — управление `ChecklistTemplate` и `ChecklistItem`, предпросмотр структуры и загрузка из файлов.
* **audits** — жизненный цикл `Audit`, ответы и вложения, расчёт итогового балла и экспорт в табличные форматы.

Приложения офлайн-синхронизации, журналов действий и расширенных настроек удаляются. Общие компоненты (шаблоны, стили) переезжают в единый UI-слой на Bootstrap.

## 7. Интерфейс и навигация

* **Главное меню** содержит четыре раздела: «Здания», «Лифты», «Чек-листы», «Аудиты». Разметка едина для обеих ролей; доступные кнопки и действия фильтруются сервером.
* **Карточки объектов** используют стандартные Django formset’ы, стилизованные Bootstrap-компонентами. Сложные взаимодействия (drag-and-drop, inline-редактирование) исключаются.
* **Карточка аудита** отображает метаданные, список вопросов, оценки и комментарии. Администратор видит кнопку возврата в `draft` и поле для заметок.
* **Модальные окна** не применяются; каждое действие — отдельная страница с явной навигацией «назад».

## 8. Техническая реализация

### 8.1. Backend

* Django остаётся основным фреймворком. Настройки разделяются на `dev` и `prod`, но профиль `offline` удаляется.
* Сокращаются модели и миграции: `ScoreOption`, `ChecklistSection`, `ObjectInfoField`, `OfflineSyncBatch`, `AuditLogEntry` и другие вспомогательные сущности архивируются или конвертируются в новые таблицы.
* Расчёт итогового балла инкапсулируется в методе `Audit.calculate_score()` и вызывается при сохранении `AuditResponse` или статуса `submitted`.
* Импорт/экспорт реализуется сервисами на `pandas`/`csv`/`openpyxl` без фоновых очередей. Асинхронные задачи добавляются только при подтверждённой нагрузке.
* Валидация обязательных комментариев и диапазонов баллов реализуется на уровне форм и модели `ChecklistItem`.

### 8.2. Frontend

* Tailwind и Alpine.js заменяются на Bootstrap 5 и SCSS-переменные для темизации. Компиляция CSS выполняется через `django-compressor` или простую пайплайн-команду.
* Формы рендерятся с помощью `django-crispy-forms` (bootstrap5 layout) либо кастомных тегов, минимизирующих дублирование HTML.
* Дополнительный JavaScript сводится к валидации форм и подсказкам; без HTMX и сложных SPA-паттернов.

### 8.3. Инфраструктура

* Упраздняются сервис-воркер, offline API и связанные cron-задачи.
* CI/CD проверяет миграции, `pytest` и `ruff`. Playwright-тесты кабинета администратора исключаются; остаются smoke-сценарии.
* Хранение файлов осуществляется на файловой системе (S3/MinIO подключаются опционально через `DEFAULT_FILE_STORAGE`).

## 9. Интеграции и API

На первом этапе внешние API отсутствуют. При необходимости предоставляется read-only эндпоинт `/api/audits/export` с токеном доступа для автоматических выгрузок. Вебхуки и сторонние интеграции описываются отдельно, чтобы не усложнять ядро.

## 10. План перехода

1. **Подтверждение требований.** Совместно с заказчиком зафиксировать, что двух ролей и статусов достаточно, офлайн-режим не требуется, а чек-лист можно упростить. Решения документируются протоколом, предотвращающим возврат к избыточной модели.
2. **Подготовка миграций.**
   * Конвертация иерархии чек-листа в `ChecklistItem` (объединение зон и категорий, перенос шкал и обязательности комментариев).
   * Перевод статусов аудитов в `draft`/`submitted` по правилам (например, `in_progress` → `draft`, `submitted/reviewed` → `submitted`).
   * Архивация журналов и офлайн-таблиц, перенос релевантных данных в `AuditAttachment`.
3. **Реализация нового UI.** Переписать шаблоны на Bootstrap, удалить кабинет администратора 2.0 и офлайн-формы. Подготовить wireframes до начала разработки.
4. **Обновление прав доступа.** Упростить миксины и middleware, удалить проверки принудительной смены пароля, связанные с офлайном.
5. **Запуск миграций и чистка кода.** Удалить неиспользуемые приложения, настройки и статические файлы, обновить документацию.
6. **Пилотный запуск.** Провести пилот на ограниченной группе объектов, собрать обратную связь, финализировать backlog улучшений.

## 11. Тестирование и эксплуатация

* **Автотесты.** Сфокусироваться на unit-тестах CRUD и жизненного цикла `Audit`. E2E-сценарии покрывают ключевые пользовательские пути (назначение аудита, заполнение, отправка, возврат).
* **Smoke-чек-листы.** После каждого релиза запускать ручной чек-лист: авторизация, создание здания, импорт чек-листа, заполнение аудита, экспорт.
* **Мониторинг.** Ограничиться базовыми метриками сервера (доступность, время отклика) и трекингом ошибок через Sentry. Журналы офлайна и действий не поддерживаются.
* **Резервное копирование.** Стандартные задачи базы и медиа; отдельный бэкап журналов не требуется.

## 12. План развития после запуска

1. **Расширенные отчёты.** Добавление сводных таблиц и визуализаций после оценки потребности.
2. **Лёгкий офлайн-режим.** Рассмотреть экспорт чек-листа в Excel для ручного заполнения в поездках и последующего импорта.
3. **Дополнительные роли.** При росте нагрузки предусмотреть разделение администратора на методолога (чек-листы) и оператора (назначение аудитов).
4. **Интеграции.** Постепенно раскрывать API для внешних систем, начиная с read-only выгрузок.

## 13. Риски и вопросы для согласования

* **Переходные данные.** Необходимо гарантировать корректное преобразование текущих статусов и структуры чек-листа; возможно, придётся хранить архив в прежней схеме.
* **Регуляторные требования.** Если нормативы требуют истории изменений, потребуется лёгкий журнал аудита или архив версий чек-листа.
* **Нагрузка на администратора.** Совмещение методологической и операционной функций может привести к перегрузке; при подтверждении риска следует заранее описать вариант разделения обязанностей.
* **Потребность в офлайн-работе.** Для аудиторов со слабым интернетом нужно альтернативное решение (бумажные формы или Excel) до внедрения офлайна.
* **Контроль качества данных.** Упрощение модели снимает некоторые ограничения; требуется регламент ручной валидации и регулярные проверки выгрузок.

Документ задаёт базовую рамку для команды разработки и заказчика. Детализация миграций, макетов и тестовых сценариев оформляется в отдельных артефактах после утверждения архитектуры 3.0.
