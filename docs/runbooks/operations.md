# Процессы релизов и поддержки

Документ описывает рутинные процедуры сопровождения веб-приложения «Союзлифт Аудит». Информация дополняет архитектурные разделы [§1](../architecture/v3.md#1-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%BA%D1%81%D1%82-%D0%B8-%D1%86%D0%B5%D0%BB%D0%B8), [§2](../architecture/v3.md#2-%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%B2%D1%8B%D0%B5-%D0%B4%D0%BE%D0%BF%D1%83%D1%89%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B8-%D0%BE%D0%B3%D1%80%D0%B0%D0%BD%D0%B8%D1%87%D0%B5%D0%BD%D0%B8%D1%8F), [§6](../architecture/v3.md#6-%D0%BA%D0%BE%D0%BC%D0%BF%D0%BE%D0%BD%D0%B5%D0%BD%D1%82%D0%BD%D0%B0%D1%8F-%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0) и [§8](../architecture/v3.md#8-%D1%82%D0%B5%D1%85%D0%BD%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B0%D1%8F-%D1%80%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F) и предназначена для инженеров эксплуатации.

## 0. Роли и зоны ответственности

- **Технический оператор (суперпользователь Django).** Обслуживает `/admin`, создаёт учётные записи, управляет секретами и инфраструктурой (см. [§6](../architecture/v3.md#6-%D0%BA%D0%BE%D0%BC%D0%BF%D0%BE%D0%BD%D0%B5%D0%BD%D1%82%D0%BD%D0%B0%D1%8F-%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0)).
- **Прикладной администратор (`role=ADMIN`).** Работает в пользовательском кабинете: модерация справочников, управление чек-листом, контроль аудитов (см. [§7](../architecture/v3.md#7-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81-%D0%B8-%D0%BD%D0%B0%D0%B2%D0%B8%D0%B3%D0%B0%D1%86%D0%B8%D1%8F)).
- **Аудитор (`role=AUDITOR`).** Заполняет назначенные аудиты в онлайне, прикладывает материалы и повторно отправляет их при возврате (см. [§4.2](../architecture/v3.md#4-%D1%86%D0%B5%D0%BB%D0%B5%D0%B2%D1%8B%D0%B5-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D1%81%D0%BA%D0%B8%D0%B5-%D1%81%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8)).

> При планировании релизов и расследовании инцидентов учитывайте разграничение кабинетов: прикладные администраторы не имеют доступа к `/admin`, а технический оператор не меняет бизнес-данные вручную.

## 1. Релизный цикл

### 1.1. Планирование

- Релизы проходят по мере готовности функциональных блоков, но не реже одного раза в квартал.
- Каждому релизу присваивается семантическая версия `MAJOR.MINOR.PATCH`; номер фиксируется в `CHANGELOG.md` (будет добавлен на этапе подготовки первой версии).
- Перед началом работ назначается ответственный инженер, который ведёт чек-лист релиза и собирает подтверждения от разработки и тестирования.

### 1.2. Подготовка к релизу

1. Убедиться, что все задачи релиза отмечены как завершённые в [AGENTS.md](../../AGENTS.md) и соответствуют архитектуре.
2. Выполнить полный набор автоматизированных проверок:
   - `pytest`
   - `ruff check backend/`
   - `python manage.py check`
3. Обновить документацию (README, пользовательские инструкции) при наличии изменений в UX.
4. Сформировать релизную ветку `release/vX.Y.Z` от `main`, если требуется длительная стабилизация. В противном случае релиз оформляется напрямую из `main`.
5. Согласовать окно обслуживания с заказчиком и уведомить пользователей не менее чем за 3 рабочих дня.

#### 1.2.1. Конфигурация окружения

- На боевых серверах явно устанавливайте `DJANGO_ENV=prod` перед запуском служб `gunicorn` и фоновых задач.
- Укажите переменные `DJANGO_SECRET_KEY`, `DJANGO_ALLOWED_HOSTS` (список доменов через запятую) и, при необходимости, `DJANGO_CSRF_TRUSTED_ORIGINS` с префиксом `https://`.
- Настройте почтовый шлюз через `DJANGO_EMAIL_HOST`, `DJANGO_EMAIL_PORT`, `DJANGO_EMAIL_HOST_USER`, `DJANGO_EMAIL_HOST_PASSWORD`, `DJANGO_EMAIL_USE_TLS`/`DJANGO_EMAIL_USE_SSL`, `DJANGO_DEFAULT_FROM_EMAIL` и включите уведомления флагом `DJANGO_EMAIL_NOTIFICATIONS_ENABLED=true` при необходимости.
- Для логирования задайте базовый каталог `DJANGO_LOG_DIR` (например, `/var/log/souzlift`), основной файл `DJANGO_LOG_FILE` с параметрами ротации `DJANGO_LOG_MAX_BYTES` и `DJANGO_LOG_BACKUP_COUNT`.
- Параметры HTTPS (HSTS, редиректы) можно скорректировать переменными `DJANGO_SECURE_SSL_REDIRECT`, `DJANGO_SECURE_HSTS_SECONDS`, `DJANGO_SECURE_HSTS_INCLUDE_SUBDOMAINS`, `DJANGO_SECURE_HSTS_PRELOAD`, `DJANGO_SECURE_REFERRER_POLICY` в зависимости от инфраструктуры заказчика.

#### 1.2.2. Контрольный список перед релизом

- [ ] Все задачи релиза закрыты и статусы в [AGENTS.md](../../AGENTS.md) актуальны.
- [ ] Проверены результаты автоматизированных тестов (см. п. 2) и приложены к отчёту о релизе.
- [ ] Обновлена пользовательская и техническая документация (README, инструкции, схемы), отражены изменения UX.
- [ ] Выполнен smoke-тест кабинета администратора: CRUD чек-листа, фильтры и отметка «просмотрено» в аудите, доступность справочников (см. [§7](../architecture/v3.md#7-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81-%D0%B8-%D0%BD%D0%B0%D0%B2%D0%B8%D0%B3%D0%B0%D1%86%D0%B8%D1%8F)).
- [ ] Подготовлен changelog и перечень ключевых изменений для заказчика.
- [ ] Проверена актуальность переменных окружения и секретов (см. §1.2.1) на целевых серверах.
- [ ] Убедитесь, что резервное копирование (раздел 2) отработало успешно за последние 24 часа и есть план отката.
- [ ] Подтверждены окно обслуживания и список ответственных за релиз и поддержку пользователей.
- [ ] Актуализированы инструкции по smoke-проверкам и проверены учётные записи для тестирования.

### 1.3. Развёртывание на продакшене

1. Зайти на сервер под учётной записью администратора приложения.
2. Перейти в каталог проекта и остановить службу приложения:
   ```bash
   sudo systemctl stop gunicorn
   ```
3. Зафиксировать резервные копии (см. раздел 2).
4. Обновить код и зависимости (выполняется от имени системного пользователя приложения, например `appuser`):
   ```bash
   sudo -u appuser git fetch --all
   sudo -u appuser git checkout main
   sudo -u appuser git pull --ff-only
   sudo -u appuser /opt/souzlift/.venv/bin/pip install -r requirements.txt
   sudo -u appuser DJANGO_ENV=prod /opt/souzlift/.venv/bin/python manage.py migrate --noinput
   sudo -u appuser DJANGO_ENV=prod /opt/souzlift/.venv/bin/python manage.py collectstatic --noinput
   ```
5. Прогнать smoke-проверки:
   ```bash
   python manage.py check
   python manage.py test --tag smoke
   ```
   > Набор smoke-тестов будет определён после внедрения автоматических тестов (этап T10.x). До того момента выполняйте выборочный запуск критичных тест-кейсов вручную.
6. Запустить службу приложения и убедиться, что процессы поднялись без ошибок:
   ```bash
   sudo systemctl start gunicorn
   sudo systemctl restart nginx
   sudo systemctl status gunicorn
   ```
7. Выполнить контрольный заход в админку и портал аудитора, убедиться в доступности статических файлов и медиа.
8. Закрыть релиз в трекере задач, приложив список изменений и результаты проверок.

#### 1.3.1. Контрольный список обновления

- [ ] Перед началом работ `git status --short` на сервере не содержит незакоммиченных изменений.
- [ ] Выполнены команды `git fetch --all` и `git pull --ff-only`, зафиксирован идентификатор релиза (`git rev-parse HEAD`).
- [ ] Обновлены зависимости через `/opt/souzlift/.venv/bin/pip install -r requirements.txt` и сохранён лог установки.
- [ ] Применены миграции `DJANGO_ENV=prod python manage.py migrate --noinput` без ошибок.
- [ ] Выполнена сборка статики `DJANGO_ENV=prod python manage.py collectstatic --noinput`, проверен размер каталога `staticfiles`.
- [ ] Службы `gunicorn` и `nginx` перезапущены и находятся в состоянии `active (running)` (`systemctl status`).
- [ ] Smoke-проверки из шага 5 завершились успешно, результаты задокументированы.
- [ ] Выполнен контрольный вход в кабинет администратора и аудитора: доступны списки справочников, чек-лист и отметка «просмотрено» (см. [§7](../architecture/v3.md#7-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81-%D0%B8-%D0%BD%D0%B0%D0%B2%D0%B8%D0%B3%D0%B0%D1%86%D0%B8%D1%8F) и [§4.2](../architecture/v3.md#4-%D1%86%D0%B5%D0%BB%D0%B5%D0%B2%D1%8B%D0%B5-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D1%81%D0%BA%D0%B8%D0%B5-%D1%81%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8)).
- [ ] На тестовом устройстве аудитора очищены кэши браузера/сервис-воркера при изменении фронтенда.

### 1.4. Пост-релизный мониторинг

- В течение 24 часов после релиза ответственный инженер отслеживает логи приложений (см. раздел 3) и собирает обратную связь от пользователей.
- При обнаружении критических дефектов выполняется hotfix с версией `X.Y.(Z+1)` и упрощённой процедурой развёртывания (те же шаги, но без долгосрочной подготовки).

## 2. Резервное копирование

### 2.1. Политика

- Храните не менее 7 ежедневных и 4 недельных копий базы данных и медиафайлов.
- Резервные копии выполняются перед каждым релизом и ежедневно в 02:00 по серверному времени.
- Бэкапы хранятся на отдельном диске/сетевом ресурсе с доступом только для администраторов.

### 2.2. Скрипт резервного копирования

В репозитории реализован скрипт `scripts/backup.sh`, автоматизирующий резервное копирование базы данных и каталога медиа. По умолчанию он:

- определяет каталог проекта относительно расположения скрипта;
- создаёт каталоги бэкапов вида `<BACKUP_ROOT>/<YYYYMMDD-HHMMSS>/` и символическую ссылку `latest` на свежий архив;
- выполняет согласованное копирование SQLite-файла (через `sqlite3 .backup`, а при его отсутствии — через стандартную библиотеку Python или `cp`);
- синхронизирует каталог медиа (`rsync -a --delete` с резервным вариантом на `tar`);
- записывает файл `manifest.json` с параметрами создания и размерами копий;
- удаляет каталоги старше `RETENTION_DAYS` (по умолчанию 30 суток).

Переменные окружения позволяют адаптировать сценарий под инфраструктуру заказчика:

| Переменная | Назначение | Значение по умолчанию |
|------------|------------|-----------------------|
| `PROJECT_ROOT` | Корневой каталог проекта | `<script_dir>/..` |
| `BACKUP_ROOT` | Папка хранения бэкапов | `$PROJECT_ROOT/backups` |
| `DB_PATH` | Путь к файлу SQLite | `$PROJECT_ROOT/backend/db/db.sqlite3` |
| `MEDIA_PATH` | Каталог с медиафайлами | `$PROJECT_ROOT/backend/media` |
| `RETENTION_DAYS` | Срок хранения копий в сутках | `30` |
| `SQLITE3_BIN` | Путь к бинарю `sqlite3` | `sqlite3` (из `$PATH`) |
| `PYTHON_BIN` | Интерпретатор Python для резервного варианта | `python3` |

Пример запуска на продакшене:

```bash
BACKUP_ROOT=/var/backups/souzlift \
PROJECT_ROOT=/opt/souzlift \
RETENTION_DAYS=60 \
/opt/souzlift/scripts/backup.sh
```

### 2.3. Настройка cron-задачи

Скрипт `scripts/install_backup_cron.sh` помогает установить ежедневный запуск резервного копирования. Он обновляет персональный `crontab`, устраняя дубликаты существующих записей и при необходимости создаёт каталог логов.

Доступные параметры:

| Переменная | Назначение | Значение по умолчанию |
|------------|------------|-----------------------|
| `BACKUP_SCRIPT` | Путь до исполняемого `backup.sh` | `<script_dir>/backup.sh` |
| `SCHEDULE` | Cron-расписание | `0 2 * * *` |
| `LOG_FILE` | Файл для логирования | `/var/log/souzlift/backup.log` |
| `CRONTAB_BIN` | Команда управления cron | `crontab` |
| `DRY_RUN` | Только вывести будущий crontab без применения | `false` |

Пример установки ежедневного бэкапа с логами:

```bash
PROJECT_ROOT=/opt/souzlift \
LOG_FILE=/var/log/souzlift/backup.log \
/opt/souzlift/scripts/install_backup_cron.sh
```

Для проверки получившегося расписания запустите `DRY_RUN=true ./scripts/install_backup_cron.sh`.

Не реже одного раза в месяц разворачивайте тестовую копию из свежего архива: остановите стенд, восстановите базу и медиа в изолированной среде и убедитесь, что аудиты и вложения доступны.

### 2.4. Восстановление из резервной копии

1. Остановить приложение (`sudo systemctl stop gunicorn`).
2. Скопировать файл базы и каталог медиа из нужного архива в рабочую директорию.
3. Проверить права на файлы (`chown -R appuser:appuser backend/db.sqlite3 backend/media`).
4. Запустить приложение и убедиться, что данные доступны.

## 3. Мониторинг и эксплуатационные проверки

### 3.1. Ошибки и журналирование

- Приложение пишет логи в каталог, заданный `DJANGO_LOG_DIR` (по умолчанию `/var/log/souzlift`). Настройте ротацию через `logrotate`, чтобы хранить не менее 14 дней истории.
- Для отслеживания исключений используйте встроенную интеграцию с Sentry. Укажите переменные `DJANGO_SENTRY_DSN`, `DJANGO_SENTRY_ENVIRONMENT`, а при необходимости — `DJANGO_SENTRY_TRACES_SAMPLE_RATE`, `DJANGO_SENTRY_PROFILES_SAMPLE_RATE` и `DJANGO_SENTRY_SEND_DEFAULT_PII`. Ошибки уровня `ERROR` и выше автоматически попадут в Sentry вместе со стек-трейсами.
- При отсутствии Sentry продолжайте просматривать журналы средствами `journalctl` и ротации файлов.

### 3.2. Контроль доступности

- Минимальный набор мониторинга включает проверку служб `gunicorn` и `nginx` (например, `systemctl is-active --quiet gunicorn`). При падении процессов настройте автоматический перезапуск systemd.
- Добавьте простую HTTP-проверку публичного URL (после реализации `/healthz/` в рамках T5.x либо главной страницы кабинета). Этого достаточно для SLA, принятого в архитектуре 3.0.

### 3.3. Контроль ресурсов и обслуживание

- Скрипт [`scripts/check_storage.sh`](../scripts/check_storage.sh) помогает отслеживать заполнение диска и объём каталога медиа. Его можно запускать вручную или по расписанию с периодичностью, согласованной с заказчиком (например, раз в сутки).
- Дополнительные утилиты (`scripts/run_clearsessions.sh`, `scripts/check_attachments.sh`) используйте по мере необходимости — офлайн-джобы и вспомогательные очереди отключены, поэтому обязательных фоновых задач, кроме резервного копирования, не требуется.
- При появлении новых требований к наблюдаемости расширяйте мониторинг точечно, оценивая влияние на упрощённую архитектуру (§2.7 [docs/architecture/v3.md](../architecture/v3.md#2-%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%B2%D1%8B%D0%B5-%D0%B4%D0%BE%D0%BF%D1%83%D1%89%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B8-%D0%BE%D0%B3%D1%80%D0%B0%D0%BD%D0%B8%D1%87%D0%B5%D0%BD%D0%B8%D1%8F)).

### 3.4. Поддержка пользователей

- Канал обратной связи: корпоративная почта `support@souzlift.local` и телефон горячей линии (будет предоставлен заказчиком).
- Время реакции на инциденты:
  - **Критические (простой системы, потеря данных):** 2 часа, круглосуточно.
  - **Высокий приоритет (недоступен отдельный модуль):** 4 часа в рабочее время.
  - **Средний/низкий приоритет:** ответ в течение 1 рабочего дня.
- Все обращения регистрируются в сервис-деске заказчика. Инженер поддержки отслеживает статус до полного закрытия.

### 3.5. Кабинет администратора — эксплуатационный чек-лист

- [ ] Разделы «Справочники», «Чек-лист» и «Аудиты» доступны и отображаются без ошибок загрузки (см. [§7](../architecture/v3.md#7-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81-%D0%B8-%D0%BD%D0%B0%D0%B2%D0%B8%D0%B3%D0%B0%D1%86%D0%B8%D1%8F)).
- [ ] Создание и редактирование элементов чек-листа завершается успешно, порядок вопросов отражается в предпросмотре.
- [ ] Фильтры списка аудитов работают по статусу и периоду, отметка «просмотрено» фиксируется для завершённых проверок (см. [§4.1](../architecture/v3.md#4-%D1%86%D0%B5%D0%BB%D0%B5%D0%B2%D1%8B%D0%B5-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D1%81%D0%BA%D0%B8%D0%B5-%D1%81%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8)).
- [ ] Экспорт отчётов доступен (печать, CSV/Excel), файлы формируются с ожидаемым содержимым.

- [ ] При включённых email-уведомлениях аудиторы получают письмо о просмотре; при выключенных уведомлениях фиксируется сообщение в интерфейсе.

## 4. Матрица ответственности

| Процесс | Ответственный | Резервный |
|---------|---------------|-----------|
| Планирование релиза | Технический руководитель | Ведущий разработчик |
| Развёртывание | Инженер эксплуатации | Технический руководитель |
| Резервное копирование | Инженер эксплуатации | Системный администратор заказчика |
| Мониторинг и алерты | Инженер эксплуатации | DevOps-консультант (по договорённости) |
| Поддержка пользователей | Служба поддержки заказчика | Инженер эксплуатации |

Документ обновляется при изменении процессов или состава команды. Следите за синхронизацией с архитектурными разделами и планом задач.
