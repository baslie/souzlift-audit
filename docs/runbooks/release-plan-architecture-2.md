# План релиза архитектуры 2.0

## 1. Область и цели

План описывает подготовку и выпуск обновления, переводящего систему на архитектуру 2.0.
Он охватывает перенос административного функционала в кабинет администратора, обновлённые процессы аудита и офлайн-синхронизацию.
Основой служат требования разделов [§1](../architecture/v2.md#1-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%BA%D1%81%D1%82-%D0%B8-%D1%86%D0%B5%D0%BB%D0%B8), [§9](../architecture/v2.md#9-%D1%8D%D0%BA%D1%81%D0%BF%D0%BB%D1%83%D0%B0%D1%82%D0%B0%D1%86%D0%B8%D1%8F-%D0%B8-%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3) и [§10](../architecture/v2.md#10-%D0%BF%D0%BB%D0%B0%D0%BD-%D0%BF%D0%B5%D1%80%D0%B5%D1%85%D0%BE%D0%B4%D0%B0) архитектуры 2.0.

## 2. Роли и коммуникации

| Обязанность | Ответственный | Канал связи |
|-------------|---------------|-------------|
| Координация релиза и принятие решений | Технический руководитель | Slack `#release` + телефон |
| Управление миграциями и проверка БД | Ведущий backend-инженер | Slack `#backend`, стендап |
| Обновление документации и материалов обучения | Технический писатель | Confluence/Docs чат |
| Информирование пользователей и сбор обратной связи | Руководитель службы эксплуатации | Email-рассылка, телефон горячей линии |

Перед релизом вся команда подтверждает доступность в окне релиза и наличие резервного контакта. За сутки до релиза размещается анонс для администраторов и аудиторов с указанием времени работ и ключевых изменений.

## 3. Подготовительный этап (T−7 ... T−1)

### 3.1. Проверка и подготовка миграций данных

1. За 7 дней до релиза зафиксировать список миграций Django и убедиться, что все они входят в ветку `main`.
2. На стенде предварительного тестирования выполнить:
   - `python manage.py migrate`
   - `python manage.py check`
   - `python manage.py test` (или `pytest` для полного набора)
3. Провести сухой прогон миграций на копии боевой базы данных (из резервной копии последнего дня) и задокументировать продолжительность каждой операции.
4. Проверить корректность данных чек-листа и справочников после миграций:
   - Открыть разделы «Справочники» и «Чек-лист» кабинета администратора, убедиться в сохранении порядка элементов.
   - Сформировать снапшот офлайн-данных через существующие сервисы (`build_catalog_snapshot_for_user`, `build_checklist_structure`) и подтвердить отсутствие ошибок в логах.
5. Подготовить SQL/ORM-скрипт для выравнивания статусов аудитов, созданных до релиза (например, проставить `review_status` для записей без значения).

### 3.2. Контроль качества и инфраструктуры

1. Закрыть все открытые дефекты, влияющие на сценарии [§5.3](../architecture/v2.md#53-%D0%BA%D0%BE%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D1%87%D0%B5%D0%BA-%D0%BB%D0%B8%D1%81%D1%82%D0%B0-%D0%BD%D0%BE%D0%B2%D1%8B%D0%B9-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB) и [§5.4](../architecture/v2.md#54-%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B8-%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D1%8C-%D0%B0%D1%83%D0%B4%D0%B8%D1%82%D0%BE%D0%B2).
2. Согласовать с DevOps обновление окружений: версия Python, пакеты зависимостей, параметры `AUDIT_ATTACHMENT_LIMITS`.
3. Проверить, что в CI настроен запуск полного пайплайна (pytest + линтеры) и что последний прогон завершился успешно.
4. Провести репетицию релиза в тестовой среде: сборка фронтенда (`npm run build` при необходимости), `collectstatic`, перезапуск сервисов.

### 3.3. Документация и обучение

1. Обновить пользовательскую документацию:
   - `docs/guides/user-guide.md` — новые разделы кабинета администратора и маршрут аудитора.
   - `docs/runbooks/operations.md` — ссылка на настоящий план и уточнение ролей.
   - Чек-листы тестирования (`docs/checklists/*.md`) — актуализировать сценарии под новый интерфейс.
2. Подготовить краткие обучающие материалы (PDF/видео) для администраторов, выделив новые разделы и порядок действий.
3. Согласовать дату тренинга с ключевыми администраторами и провести его не позднее чем за два дня до релиза.

### 3.4. План коммуникаций

1. За 5 дней: анонс в корпоративном портале о грядущем обновлении.
2. За 2 дня: персональная email-рассылка администраторам и аудиторам с описанием влияния на рабочие процессы.
3. За 1 день: напоминание с ссылкой на обучающие материалы и окно обслуживания.
4. Подготовить шаблон сообщения в случае отката (см. раздел 6) и согласовать его с PR-службой.

## 4. День релиза (T0)

1. **Заморозка изменений.** За 2 часа до начала закрыть доступ на запись в репозиторий (или ввести код-фриз).
2. **Резервное копирование.** Выполнить снапшоты БД и статики; проверить успешность резервного копирования.
3. **Оповещение пользователей.** Отправить уведомление о начале технических работ в чатах и на email.
4. **Выгрузка очереди офлайн-синхронизаций.** Убедиться, что нет необработанных пакетов `OfflineSyncBatch` со статусом `processing`; при необходимости дождаться завершения.
5. **Деплой:**
   1. `git fetch && git checkout <релизный тег>`
   2. `pip install -r requirements.txt`
   3. `python manage.py migrate`
   4. `python manage.py collectstatic --noinput`
   5. Запуск `pytest` (с укороченным конфигом, если длительно) и `python manage.py check`
   6. Перезапуск приложений (gunicorn/celery/worker) и веб-сервера.
6. **Проверки после деплоя:**
   - Войти под ролью администратора и аудитора, убедиться в корректности меню и доступности разделов.
   - Создать тестовый аудит, отправить и отметить «просмотрено».
   - Проверить, что офлайн-снапшот формируется без ошибок (через API или логи).
7. **Открытие доступа.** Сообщить пользователям о завершении работ и предоставить ссылки на документацию.

## 5. Пост-релизный контроль (T+1 ... T+7)

1. Мониторинг логов офлайн-синхронизации и почтовых уведомлений (см. [§9](../architecture/v2.md#9-%D1%8D%D0%BA%D1%81%D0%BF%D0%BB%D1%83%D0%B0%D1%82%D0%B0%D1%86%D0%B8%D1%8F-%D0%B8-%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3)).
2. Сбор обратной связи от администраторов и аудиторов через форму в корпоративном портале; консолидировать ответы к T+3.
3. Проверка метрик: количество ошибок синхронизации, время ответа кабинета, утилизация вложений.
4. Подготовка отчёта о релизе (изменения, найденные дефекты, подтверждение тестов) и публикация в репозитории.

## 6. Откатный сценарий

1. **Критерии отката:** массовые ошибки при сохранении аудитов, недоступность кабинета администратора, потеря данных чек-листа, нарушения офлайн-синхронизации более 30 минут.
2. **Шаги отката:**
   1. Немедленно оповестить пользователей о временной недоступности и предполагаемом откате.
   2. Остановить приложения и задокументировать состояние (идентификаторы миграций, ошибки логов).
   3. Выполнить `git checkout` предыдущего стабильного тега и `pip install` в соответствии с ним.
   4. Восстановить базу данных и статику из резервных копий, сделанных перед релизом.
   5. Запустить `python manage.py migrate` до версии, соответствующей предыдущему релизу (при необходимости использовать `migrate app <migration>`).
   6. Проверить доступность кабинета аудитора и администратора, провести smoke-тесты.
   7. Сообщить пользователям о завершении отката и дальнейших шагах.
3. **Анализ:** собрать рабочую группу, выявить корневую причину, обновить настоящий план во избежание повторения.

## 7. Артефакты релиза

К релизной заметке прикладываются:

- Журнал прогонов `pytest`/`manage.py test` и `ruff` (если применяется).
- Отчёты UI-регрессии и smoke-тестов.
- Копии уведомлений пользователям и шаблонов инструкций.
- Решения о миграциях данных и подтверждение успешного прогона на стенде.

Используйте этот план как базовый шаблон и актуализируйте его по мере развития архитектуры 2.0.
