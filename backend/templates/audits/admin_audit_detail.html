{% extends "base.html" %}
{% load static %}

{% block title %}Аудит №{{ audit.id }} · Союзлифт Аудит{% endblock %}

{% block header_links %}
  <a href="{% url 'audits:audit-list' %}" class="app-header__link">Аудиты</a>
  <a href="{% url 'catalog:building-list' %}" class="app-header__link">Здания</a>
  <a href="{% url 'catalog:elevator-list' %}" class="app-header__link">Лифты</a>
  <a href="{% url 'accounts:dashboard' %}" class="app-header__link">Личный кабинет</a>
  <a href="{% url 'accounts:logout' %}" class="app-header__link">Выйти</a>
{% endblock %}

{% block heading %}Аудит №{{ audit.id }}{% endblock %}

{% block subheading %}
  {{ audit.elevator.building.address }} · Лифт: {{ audit.elevator.identifier }}
{% endblock %}

{% block actions %}
  <div class="flex flex-wrap items-center justify-end gap-2">
    <a href="{{ back_url }}" class="btn btn--secondary">К списку</a>
    <a
      href="{% url 'audits:audit-export-print' audit.pk %}"
      class="btn btn--secondary"
      target="_blank"
      rel="noopener"
    >
      Печать
    </a>
    <a
      href="{% url 'audits:audit-export-csv' audit.pk %}"
      class="btn btn--secondary"
      target="_blank"
      rel="noopener"
    >
      CSV
    </a>
    <a
      href="{% url 'audits:audit-export-excel' audit.pk %}"
      class="btn btn--secondary"
      target="_blank"
      rel="noopener"
    >
      Excel
    </a>
    {% if can_mark_reviewed %}
      <form method="post" action="{% url 'audits:audit-mark-reviewed' audit.pk %}" class="inline-flex">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
        <button type="submit" class="btn btn--primary">Отметить просмотр</button>
      </form>
    {% endif %}
  </div>
{% endblock %}

{% block content %}
  <div class="space-y-10 text-sm text-ink-700">
    <section class="space-y-4">
      <h2 class="text-lg font-semibold text-ink-900">Ключевые показатели</h2>
      <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
        <div class="rounded-xl border border-border-subtle bg-surface-elevated p-4 shadow-soft">
          <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Статус</div>
          <div class="mt-3 flex flex-wrap items-center gap-2">
            <span class="inline-flex rounded-full border px-3 py-1 text-xs font-semibold {{ status_badge_class }}">
              {{ audit.get_status_display }}
            </span>
            <span class="text-xs text-ink-500">Обновлено {{ audit.updated_at|date:"d.m.Y H:i" }}</span>
          </div>
        </div>
        <div class="rounded-xl border border-border-subtle bg-surface-elevated p-4 shadow-soft">
          <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Итоговый балл</div>
          <div class="mt-3 text-2xl font-semibold text-ink-900">{{ audit.total_score }}</div>
          <div class="text-xs text-ink-500">Из {{ summary.total_questions }} вопросов</div>
        </div>
        <div class="rounded-xl border border-border-subtle bg-surface-elevated p-4 shadow-soft">
          <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Заполнено ответов</div>
          <div class="mt-3 text-2xl font-semibold text-ink-900">{{ summary.answered_questions }}</div>
          <div class="text-xs text-ink-500">Не заполнено: {{ summary.unanswered_questions }}</div>
        </div>
        <div class="rounded-xl border border-border-subtle bg-surface-elevated p-4 shadow-soft">
          <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Файлы и пометки</div>
          <div class="mt-3 text-2xl font-semibold text-ink-900">{{ summary.attachments_total }}</div>
          <div class="text-xs text-ink-500">Комментариев: {{ summary.comments_total }}, пометок: {{ summary.flagged_total }}</div>
        </div>
      </div>

      <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
        <div class="rounded-xl border border-border-subtle bg-surface-elevated p-4 shadow-soft">
          <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Автор</div>
          <div class="mt-2 text-base font-semibold text-ink-900">
            {{ audit.created_by.profile.full_name|default:audit.created_by.username }}
          </div>
        </div>
        <div class="rounded-xl border border-border-subtle bg-surface-elevated p-4 shadow-soft">
          <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Создан</div>
          <div class="mt-2 text-base font-semibold text-ink-900">{{ audit.created_at|date:"d.m.Y H:i" }}</div>
        </div>
        <div class="rounded-xl border border-border-subtle bg-surface-elevated p-4 shadow-soft">
          <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Плановая дата</div>
          <div class="mt-2 text-base font-semibold text-ink-900">{{ audit.planned_date|date:"d.m.Y"|default:"—" }}</div>
        </div>
        <div class="rounded-xl border border-border-subtle bg-surface-elevated p-4 shadow-soft">
          <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Начато</div>
          <div class="mt-2 text-base font-semibold text-ink-900">{{ audit.started_at|date:"d.m.Y H:i"|default:"—" }}</div>
        </div>
        <div class="rounded-xl border border-border-subtle bg-surface-elevated p-4 shadow-soft">
          <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Завершено</div>
          <div class="mt-2 text-base font-semibold text-ink-900">{{ audit.finished_at|date:"d.m.Y H:i"|default:"—" }}</div>
        </div>
      </div>
    </section>

    <section class="space-y-4">
      <h2 class="text-lg font-semibold text-ink-900">Информационная карта объекта</h2>
      {% if object_info_has_values %}
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-border-subtle text-sm">
            <thead class="bg-surface-subtle text-xs uppercase tracking-wide text-ink-500">
              <tr>
                <th scope="col" class="px-4 py-3 text-left font-semibold">Поле</th>
                <th scope="col" class="px-4 py-3 text-left font-semibold">Значение</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border-subtle bg-surface-elevated">
              {% for item in object_info %}
                <tr>
                  <td class="px-4 py-3 text-sm font-medium text-ink-700">
                    {{ item.label }}{% if item.is_extra %}<span class="ml-2 rounded bg-warning-100 px-2 py-0.5 text-xs text-warning-700">Доп. поле</span>{% endif %}
                  </td>
                  <td class="px-4 py-3 text-sm text-ink-600">
                    {% if item.value %}
                      {% if item.is_multiline %}
                        <span class="whitespace-pre-line">{{ item.value }}</span>
                      {% else %}
                        {{ item.value }}
                      {% endif %}
                    {% else %}
                      <span class="text-ink-400">—</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="rounded-lg border border-border-subtle bg-surface-subtle px-4 py-3 text-sm text-ink-500">
          Информационная карта для этого аудита не содержит заполненных значений.
        </p>
      {% endif %}
    </section>

    <section class="space-y-6">
      <h2 class="text-lg font-semibold text-ink-900">Ответы чек-листа</h2>
      {% if checklist %}
        {% for category in checklist %}
          <div class="space-y-4">
            <div>
              <h3 class="text-base font-semibold text-ink-900">{{ category.name }}</h3>
              {% if category.code %}
                <p class="text-xs uppercase tracking-wide text-ink-500">Код: {{ category.code }}</p>
              {% endif %}
            </div>
            {% for section in category.sections %}
              <div class="space-y-4">
                <h4 class="text-sm font-semibold uppercase tracking-wide text-ink-600">{{ section.title }}</h4>
                <div class="space-y-4">
                  {% for question in section.questions %}
                    <article class="rounded-xl border border-border-subtle bg-surface-elevated p-4 shadow-soft {% if question.is_flagged %}border-warning-300 bg-warning-50{% endif %}">
                      <div class="flex flex-wrap items-start justify-between gap-4">
                        <div class="space-y-2">
                          <p class="text-sm font-semibold text-ink-900">{{ question.text }}</p>
                          {% if question.guideline %}
                            <p class="text-xs text-ink-500">{{ question.guideline }}</p>
                          {% endif %}
                          <div class="flex flex-wrap gap-2 text-xs">
                            {% if question.is_flagged %}
                              <span class="inline-flex items-center rounded-full border border-warning-300 bg-warning-100 px-2 py-0.5 font-semibold text-warning-700">Пометка</span>
                            {% endif %}
                            {% if question.is_offline %}
                              <span class="inline-flex items-center rounded-full border border-brand-200 bg-brand-50 px-2 py-0.5 font-semibold text-brand-700">Офлайн</span>
                            {% endif %}
                            {% if question.requires_comment and not question.has_comment %}
                              <span class="inline-flex items-center rounded-full border border-danger-200 bg-danger-50 px-2 py-0.5 font-semibold text-danger-700">Комментарий обязателен</span>
                            {% endif %}
                          </div>
                        </div>
                        <div class="text-right text-sm font-semibold text-ink-700">
                          {{ question.value_display }}
                        </div>
                      </div>

                      {% if question.answer_display and question.type == "text" %}
                        <div class="mt-4 space-y-1">
                          <span class="text-xs font-semibold uppercase tracking-wide text-ink-500">Ответ</span>
                          <p class="whitespace-pre-line">{{ question.answer_display }}</p>
                        </div>
                      {% elif question.answer_display and question.type != "text" %}
                        <div class="mt-4 space-y-1">
                          <span class="text-xs font-semibold uppercase tracking-wide text-ink-500">Ответ</span>
                          <p>{{ question.answer_display }}</p>
                        </div>
                      {% elif not question.has_response %}
                        <p class="mt-4 text-xs text-warning-600">Ответ не заполнен.</p>
                      {% endif %}

                      {% if question.comment_display %}
                        <div class="mt-4 space-y-1">
                          <span class="text-xs font-semibold uppercase tracking-wide text-ink-500">Комментарий</span>
                          <p class="whitespace-pre-line">{{ question.comment_display }}</p>
                        </div>
                      {% endif %}

                      {% if question.attachments %}
                        <div class="mt-4 flex flex-wrap gap-3">
                          {% for attachment in question.attachments %}
                            {% with url=attachment.get_download_url %}
                              <figure class="w-32">
                                <a href="{{ url }}" target="_blank" rel="noopener" class="block overflow-hidden rounded-lg border border-border-subtle">
                                  <img src="{{ url }}" alt="{{ attachment.caption|default:'Вложение' }}" class="h-24 w-full object-cover" />
                                </a>
                                {% if attachment.caption %}
                                  <figcaption class="mt-1 text-xs text-ink-500">{{ attachment.caption }}</figcaption>
                                {% endif %}
                              </figure>
                            {% endwith %}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </article>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      {% else %}
        <p class="rounded-lg border border-border-subtle bg-surface-subtle px-4 py-3 text-sm text-ink-500">
          Для этого аудита не найдено вопросов чек-листа.
        </p>
      {% endif %}
    </section>
  </div>
{% endblock %}

