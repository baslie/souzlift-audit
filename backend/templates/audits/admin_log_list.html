{% extends "base.html" %}
{% load static tz %}

{% block title %}Журнал действий · Союзлифт Аудит{% endblock %}
{% block heading %}Журнал действий{% endblock %}
{% block subheading %}
  <p class="text-sm text-ink-500">
    Просматривайте историю операций по аудитам, вложениям и офлайн-пакетам. Используйте фильтры по периоду, типу объекта и
    идентификатору аудита, а при необходимости выгружайте данные в CSV для дальнейшего анализа.
  </p>
{% endblock %}
{% block actions %}
  <a
    href="?{% if querystring %}{{ querystring }}&{% endif %}export=csv"
    class="btn btn--secondary"
  >
    Экспорт CSV
  </a>
{% endblock %}

{% block content %}
  <div class="space-y-8">
    <form method="get" class="grid gap-4 md:grid-cols-5 md:items-end">
      <div>
        <label for="id-start" class="form-label text-xs uppercase tracking-wide text-ink-500">Дата с</label>
        <input
          type="date"
          id="id-start"
          name="{{ start_param|default:'start' }}"
          value="{{ start_value }}"
          class="app-input"
        />
      </div>
      <div>
        <label for="id-end" class="form-label text-xs uppercase tracking-wide text-ink-500">Дата по</label>
        <input
          type="date"
          id="id-end"
          name="{{ end_param|default:'end' }}"
          value="{{ end_value }}"
          class="app-input"
        />
      </div>
      <div>
        <label for="id-entity" class="form-label text-xs uppercase tracking-wide text-ink-500">Тип объекта</label>
        <select
          id="id-entity"
          name="{{ entity_type_param|default:'entity_type' }}"
          class="app-input app-input--select"
        >
          {% for value, label in entity_type_choices %}
            <option value="{{ value }}" {% if value == entity_type_value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="id-audit" class="form-label text-xs uppercase tracking-wide text-ink-500">Аудит</label>
        <input
          type="number"
          min="1"
          step="1"
          id="id-audit"
          name="{{ audit_param|default:'audit' }}"
          value="{{ audit_value }}"
          placeholder="ID аудита"
          class="app-input"
        />
      </div>
      <div class="flex gap-2">
        <button type="submit" class="btn btn--primary">Применить</button>
        <a href="{% url 'audits:audit-log-list' %}" class="btn btn--secondary">Сбросить</a>
      </div>
    </form>

    {% if log_entries %}
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-border-subtle text-sm">
          <thead class="bg-surface-subtle text-xs uppercase tracking-wide text-ink-500">
            <tr>
              <th scope="col" class="px-4 py-3 text-left font-semibold">Дата</th>
              <th scope="col" class="px-4 py-3 text-left font-semibold">Действие</th>
              <th scope="col" class="px-4 py-3 text-left font-semibold">Объект</th>
              <th scope="col" class="px-4 py-3 text-left font-semibold">Пользователь</th>
              <th scope="col" class="px-4 py-3 text-left font-semibold">Данные</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border-subtle bg-surface-elevated">
            {% for entry in log_entries %}
              <tr>
                <td class="whitespace-nowrap px-4 py-3 font-medium text-ink-700">
                  {{ entry.created_at|localtime|date:"d.m.Y H:i" }}
                </td>
                <td class="px-4 py-3 text-ink-700">
                  <div class="font-medium">{{ entry.get_action_display }}</div>
                  <div class="text-xs text-ink-500">{{ entry.entity_label }}</div>
                </td>
                <td class="px-4 py-3 text-ink-700">
                  <div class="font-medium">{{ entry.entity_type }} · #{{ entry.entity_id|default:"—" }}</div>
                  {% if entry.related_audit %}
                    <div class="text-xs text-ink-500">
                      Аудит №{{ entry.related_audit.pk }} · {{ entry.related_audit.elevator.identifier }} ·
                      {{ entry.related_audit.elevator.building.address }}
                    </div>
                  {% endif %}
                </td>
                <td class="px-4 py-3 text-ink-700">
                  {{ entry.user.get_username|default:"—" }}
                </td>
                <td class="px-4 py-3 text-ink-700">
                  <details class="group">
                    <summary class="cursor-pointer text-xs font-semibold text-brand-600">Показать</summary>
                    <pre class="mt-2 rounded-lg bg-surface-subtle p-3 text-xs text-ink-600">{{ entry.payload_pretty }}</pre>
                  </details>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if page_obj %}
        <div class="mt-4 flex flex-wrap items-center justify-between gap-3 text-xs text-ink-600">
          <span>Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
          <div class="flex items-center gap-2">
            {% if page_obj.has_previous %}
              <a
                href="?{% if querystring %}{{ querystring }}&amp;{% endif %}page={{ page_obj.previous_page_number }}"
                class="btn btn--secondary btn--sm"
              >
                Назад
              </a>
            {% endif %}
            {% if page_obj.has_next %}
              <a
                href="?{% if querystring %}{{ querystring }}&amp;{% endif %}page={{ page_obj.next_page_number }}"
                class="btn btn--secondary btn--sm"
              >
                Вперёд
              </a>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% else %}
      <p class="rounded-lg border border-dashed border-border bg-surface-subtle px-4 py-6 text-sm text-ink-500">
        Записей не найдено. Попробуйте изменить условия фильтрации.
      </p>
    {% endif %}
  </div>
{% endblock %}
