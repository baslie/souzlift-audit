{% extends "base.html" %}
{% block title %}Настройки кабинета администратора · Союзлифт Аудит{% endblock %}
{% block heading %}Настройки кабинета администратора{% endblock %}
{% block subheading %}
  <p class="text-sm text-ink-500">
    Управляйте полями информационной карточки объектов и лимитами вложений. Изменения применяются сразу и
    используются как в веб-интерфейсе, так и в офлайн-снапшотах.
  </p>
{% endblock %}
{% block actions %}
  <a href="{% url 'catalog:object-field-create' %}" class="btn btn--primary">Добавить поле</a>
{% endblock %}
{% block content %}
  <div class="space-y-10 text-sm text-ink-700">
    <section class="space-y-4">
      <div class="flex flex-col gap-2">
        <h2 class="text-lg font-semibold text-ink-900">Поля информационной карточки</h2>
        <p class="text-xs text-ink-500">
          Всего полей: {{ field_count }}. Поля отображаются аудиторам в указанном порядке и попадают в экспорт аудитов.
        </p>
      </div>
      {% if fields %}
        <div class="space-y-4">
          {% for field in fields %}
            <div class="rounded-2xl border border-border bg-surface-elevated shadow-soft">
              <div class="flex flex-col gap-4 border-b border-border-subtle px-5 py-4 md:flex-row md:items-center md:justify-between">
                <div class="space-y-1">
                  <h3 class="text-base font-semibold text-ink-900">{{ field.label }}</h3>
                  <div class="text-xs text-ink-500">Код: <code>{{ field.code }}</code> · Тип: {{ field.get_field_type_display }} · Порядок: {{ field.order }}</div>
                  <div class="text-xs text-ink-500">
                    {% if field.is_required %}Обязательное поле{% else %}Необязательное поле{% endif %}
                  </div>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                  <form method="post" action="{% url 'catalog:object-field-move' field.pk %}" class="inline-flex">
                    {% csrf_token %}
                    <input type="hidden" name="direction" value="up" />
                    <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                    <button type="submit" class="btn btn--ghost text-xs" aria-label="Переместить вверх">↑</button>
                  </form>
                  <form method="post" action="{% url 'catalog:object-field-move' field.pk %}" class="inline-flex">
                    {% csrf_token %}
                    <input type="hidden" name="direction" value="down" />
                    <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                    <button type="submit" class="btn btn--ghost text-xs" aria-label="Переместить вниз">↓</button>
                  </form>
                  <a href="{% url 'catalog:object-field-update' field.pk %}" class="btn btn--secondary text-xs px-3 py-1">Редактировать</a>
                  <a href="{% url 'catalog:object-field-delete' field.pk %}" class="btn btn--danger text-xs px-3 py-1">Удалить</a>
                </div>
              </div>
              <div class="space-y-3 px-5 py-4">
                {% if field.field_type == 'choice' %}
                  {% with choices=field.choices.splitlines %}
                    {% if choices %}
                      <div class="space-y-1 text-xs text-ink-600">
                        <div class="font-semibold text-ink-800">Доступные значения:</div>
                        <ul class="list-disc space-y-1 pl-5">
                          {% for value in choices %}
                            {% if value %}
                              <li>{{ value }}</li>
                            {% endif %}
                          {% endfor %}
                        </ul>
                      </div>
                    {% else %}
                      <div class="rounded border border-warning-200 bg-warning-50 p-3 text-xs text-warning-700">
                        Добавьте варианты, чтобы аудиторы могли выбрать значение.
                      </div>
                    {% endif %}
                  {% endwith %}
                {% else %}
                  <p class="text-xs text-ink-500">
                    Поле заполняется в свободной форме. Тип данных учитывается при валидации и экспорте.
                  </p>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="rounded border border-dashed border-border-subtle p-6 text-center text-sm text-ink-500">
          Пока нет ни одного дополнительного поля. Добавьте первое, чтобы аудиторы могли фиксировать контекст объекта.
        </div>
      {% endif %}
    </section>
    <section class="space-y-4">
      <div class="flex flex-col gap-2">
        <h2 class="text-lg font-semibold text-ink-900">Лимиты вложений</h2>
        <p class="text-xs text-ink-500">
          Текущие значения: до {{ attachment_limits.max_per_response }} файлов на вопрос, {{ attachment_limits.max_per_audit }} на аудит,
          размер одного файла — до {{ attachment_limits.max_size_label }} МБ. Эти ограничения отображаются аудиторам в интерфейсе и офлайн-форме.
        </p>
      </div>
      <form method="post" class="rounded-2xl border border-border bg-surface-elevated p-5 shadow-soft" novalidate>
        {% csrf_token %}
        <input type="hidden" name="form" value="attachments" />
        {% for hidden in attachment_form.hidden_fields %}
          {{ hidden }}
        {% endfor %}
        {{ attachment_form.non_field_errors }}
        <div class="grid gap-4 md:grid-cols-3">
          {% for field in attachment_form.visible_fields %}
            <div>
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.help_text %}
                {{ field.help_text|safe }}
              {% endif %}
              {% if field.errors %}
                <div class="form-error">{{ field.errors|striptags }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        {% if attachment_configuration %}
          <p class="mt-4 text-xs text-ink-500">Последнее обновление: {{ attachment_configuration.updated_at|date:"d.m.Y H:i" }}.</p>
        {% endif %}
        <div class="mt-5 flex flex-wrap gap-3">
          <button type="submit" class="btn btn--primary">Обновить лимиты</button>
          <a href="{{ request.get_full_path }}" class="btn btn--secondary">Отмена</a>
        </div>
      </form>
    </section>
  </div>
{% endblock %}
