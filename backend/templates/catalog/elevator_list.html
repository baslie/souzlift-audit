{% extends "base.html" %}
{% block title %}Справочник лифтов · Союзлифт Аудит{% endblock %}
{% block header_links %}
  <a href="{% url 'accounts:dashboard' %}" class="app-header__link">Личный кабинет</a>
  <a href="{% url 'catalog:building-list' %}" class="app-header__link">Здания</a>
  <a
    href="{% url 'catalog:elevator-list' %}"
    class="app-header__link aria-current:font-semibold aria-current:text-white"
    aria-current="page"
  >
    Лифты
  </a>
  <a href="{% url 'accounts:logout' %}" class="app-header__link">Выйти</a>
{% endblock %}
{% block heading %}Справочник лифтов{% endblock %}
{% block subheading %}
  <p class="text-sm text-ink-500">
    Добавляйте новые лифты и отслеживайте статус их модерации. Неподтверждённые записи видны только их авторам и администраторам.
  </p>
{% endblock %}
{% block actions %}
  <a href="{% url 'catalog:elevator-create' %}" class="btn btn--primary">
    Добавить лифт
  </a>
{% endblock %}
{% block content %}
  <form method="get" class="mb-6 grid gap-4 md:grid-cols-[minmax(0,2fr)_minmax(0,1fr)_auto] md:items-end">
    <div>
      <label for="id-search" class="form-label text-xs uppercase tracking-wide text-ink-500">Поиск</label>
      <input
        type="search"
        id="id-search"
        name="{{ search_param }}"
        value="{{ search_query }}"
        placeholder="Введите номер или часть описания"
        class="app-input"
      />
    </div>
    <div>
      <label for="id-status" class="form-label text-xs uppercase tracking-wide text-ink-500">Статус</label>
      <select
        id="id-status"
        name="{{ status_param }}"
        class="app-input app-input--select"
      >
        {% for value, label in status_choices %}
          <option value="{{ value }}" {% if value == selected_status %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="flex gap-2">
      <button type="submit" class="btn btn--primary">
        Применить
      </button>
      <a href="{% url 'catalog:elevator-list' %}" class="btn btn--secondary">
        Сбросить
      </a>
    </div>
  </form>

  {% if object_list %}
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-border-subtle text-sm">
        <thead class="bg-surface-subtle text-xs uppercase tracking-wide text-ink-500">
          <tr>
            <th scope="col" class="px-4 py-3 text-left font-semibold">Лифт</th>
            <th scope="col" class="px-4 py-3 text-left font-semibold">Статус</th>
            <th scope="col" class="px-4 py-3 text-left font-semibold">Здание</th>
            <th scope="col" class="px-4 py-3 text-left font-semibold">Автор</th>
            <th scope="col" class="px-4 py-3 text-left font-semibold">Подтвердил</th>
            <th scope="col" class="px-4 py-3 text-left font-semibold">Действия</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border-subtle bg-surface-elevated">
          {% for elevator in object_list %}
            <tr class="align-top">
              <td class="px-4 py-4">
                <div class="font-semibold text-ink-900">{{ elevator.identifier }}</div>
                <div class="text-xs text-ink-500">{{ elevator.get_status_display }}</div>
                {% if elevator.description %}
                  <div class="mt-2 rounded border border-border-subtle bg-surface-subtle p-2 text-xs text-ink-600">{{ elevator.description }}</div>
                {% endif %}
                <div class="mt-1 text-xs text-ink-400">Создано {{ elevator.created_at|date:"d.m.Y H:i" }}</div>
              </td>
              <td class="px-4 py-4">
                {% if elevator.review_status == ReviewStatus.APPROVED %}
                  {% with "border-success-200 bg-success-50 text-success-700" as status_classes %}
                    <span class="inline-flex rounded-full border px-3 py-1 text-xs font-semibold {{ status_classes }}">
                      {{ elevator.get_review_status_display }}
                    </span>
                  {% endwith %}
                {% elif elevator.review_status == ReviewStatus.REJECTED %}
                  {% with "border-danger-200 bg-danger-50 text-danger-700" as status_classes %}
                    <span class="inline-flex rounded-full border px-3 py-1 text-xs font-semibold {{ status_classes }}">
                      {{ elevator.get_review_status_display }}
                    </span>
                  {% endwith %}
                {% else %}
                  {% with "border-warning-200 bg-warning-50 text-warning-700" as status_classes %}
                    <span class="inline-flex rounded-full border px-3 py-1 text-xs font-semibold {{ status_classes }}">
                      {{ elevator.get_review_status_display }}
                    </span>
                  {% endwith %}
                {% endif %}
              </td>
              <td class="px-4 py-4">
                <div class="font-medium text-ink-800">{{ elevator.building.address }}</div>
                {% if elevator.building.entrance %}
                  <div class="text-xs text-ink-500">Подъезд: {{ elevator.building.entrance }}</div>
                {% endif %}
              </td>
              <td class="px-4 py-4">
                {% if elevator.created_by %}
                  <div class="font-medium text-ink-800">{{ elevator.created_by.profile.full_name|default:elevator.created_by.username }}</div>
                {% else %}
                  <div class="text-ink-400">—</div>
                {% endif %}
              </td>
              <td class="px-4 py-4">
                {% if elevator.verified_by %}
                  <div class="font-medium text-ink-800">{{ elevator.verified_by.profile.full_name|default:elevator.verified_by.username }}</div>
                  {% if elevator.verified_at %}
                    <div class="text-xs text-ink-500">{{ elevator.verified_at|date:"d.m.Y H:i" }}</div>
                  {% endif %}
                {% else %}
                  <div class="text-ink-400">—</div>
                {% endif %}
              </td>
              <td class="px-4 py-4">
                <div class="flex flex-col gap-2">
                  {% if can_moderate or elevator.created_by_id == request.user.id %}
                    {% if can_moderate or elevator.review_status != ReviewStatus.APPROVED %}
                      <a
                        href="{% url 'catalog:elevator-update' elevator.pk %}"
                        class="btn btn--secondary text-xs px-3 py-1"
                      >
                        Редактировать
                      </a>
                    {% endif %}
                  {% endif %}
                  {% if can_moderate %}
                    <form method="post" action="{% url 'catalog:elevator-moderate' elevator.pk %}" class="flex flex-wrap gap-2">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                      <button
                        type="submit"
                        name="action"
                        value="approve"
                        class="inline-flex flex-1 items-center justify-center rounded bg-success-600 px-3 py-1 text-xs font-semibold text-white shadow-soft hover:bg-success-500"
                      >
                        Утвердить
                      </button>
                      <button
                        type="submit"
                        name="action"
                        value="reject"
                        class="inline-flex flex-1 items-center justify-center rounded bg-danger-600 px-3 py-1 text-xs font-semibold text-white shadow-soft hover:bg-danger-500"
                      >
                        Отклонить
                      </button>
                      {% if elevator.review_status != ReviewStatus.PENDING %}
                        <button
                          type="submit"
                          name="action"
                          value="return"
                          class="inline-flex flex-1 items-center justify-center rounded bg-warning-500 px-3 py-1 text-xs font-semibold text-white shadow-soft hover:bg-warning-600"
                        >
                          На проверку
                        </button>
                      {% endif %}
                    </form>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
      <div class="mt-6 flex items-center justify-between text-xs text-ink-600">
        <span>Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
        <div class="flex items-center gap-2">
          {% if page_obj.has_previous %}
            <a
              href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}"
              class="btn btn--secondary text-xs px-3 py-1"
            >
              Назад
            </a>
          {% else %}
            <span class="rounded border border-border-subtle px-3 py-1 text-ink-300">Назад</span>
          {% endif %}
          {% if page_obj.has_next %}
            <a
              href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}"
              class="btn btn--secondary text-xs px-3 py-1"
            >
              Вперёд
            </a>
          {% else %}
            <span class="rounded border border-border-subtle px-3 py-1 text-ink-300">Вперёд</span>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% else %}
    <p class="text-sm text-ink-600">Подходящих записей не найдено. Попробуйте изменить фильтры или добавьте новый лифт.</p>
  {% endif %}
{% endblock %}

