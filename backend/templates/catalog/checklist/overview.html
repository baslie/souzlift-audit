{% extends "base.html" %}
{% block title %}Конструктор чек-листа · Союзлифт Аудит{% endblock %}
{% block heading %}Конструктор чек-листа{% endblock %}
{% block subheading %}
  <p class="text-sm text-ink-500">
    Управляйте категориями, секциями и вопросами. Всего категорий: {{ category_count }}, секций: {{ section_count }},
    вопросов: {{ question_count }}{% if score_option_count %}, вариантов оценок: {{ score_option_count }}{% endif %}.
  </p>
{% endblock %}
{% block actions %}
  <a href="{% url 'catalog:checklist-category-create' %}" class="btn btn--primary">Добавить категорию</a>
{% endblock %}
{% block content %}
  <div class="space-y-10 text-sm text-ink-700">
    <section class="space-y-6">
      {% if categories %}
        {% for category in categories %}
          <div class="rounded-2xl border border-border bg-surface-elevated shadow-soft">
            <div class="flex flex-col gap-4 border-b border-border-subtle px-5 py-4 md:flex-row md:items-center md:justify-between">
              <div>
                <h2 class="text-lg font-semibold text-ink-900">{{ category.name }}</h2>
                <div class="text-xs text-ink-500">Код: {{ category.code }} · Порядок: {{ category.order }}</div>
              </div>
              <div class="flex flex-wrap items-center gap-2">
                <form method="post" action="{% url 'catalog:checklist-category-move' category.pk %}" class="inline-flex">
                  {% csrf_token %}
                  <input type="hidden" name="direction" value="up" />
                  <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                  <button type="submit" class="btn btn--ghost text-xs" aria-label="Переместить вверх">↑</button>
                </form>
                <form method="post" action="{% url 'catalog:checklist-category-move' category.pk %}" class="inline-flex">
                  {% csrf_token %}
                  <input type="hidden" name="direction" value="down" />
                  <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                  <button type="submit" class="btn btn--ghost text-xs" aria-label="Переместить вниз">↓</button>
                </form>
                <a href="{% url 'catalog:checklist-category-update' category.pk %}" class="btn btn--secondary text-xs px-3 py-1">Редактировать</a>
                <a href="{% url 'catalog:checklist-category-delete' category.pk %}" class="btn btn--danger text-xs px-3 py-1">Удалить</a>
                <a href="{% url 'catalog:checklist-section-create' category.pk %}" class="btn btn--primary text-xs px-3 py-1">Добавить секцию</a>
              </div>
            </div>
            <div class="space-y-5 px-5 py-4">
              {% with sections=category.sections.all %}
                {% if sections %}
                  {% for section in sections %}
                  <div class="rounded-xl border border-border-subtle bg-surface-subtle p-4">
                    <div class="flex flex-col gap-3 border-b border-border-subtle pb-3 md:flex-row md:items-center md:justify-between">
                      <div>
                        <h3 class="text-base font-semibold text-ink-900">{{ section.title }}</h3>
                        {% if section.description %}
                          <p class="mt-1 text-xs text-ink-500">{{ section.description }}</p>
                        {% endif %}
                        <div class="mt-1 text-xs text-ink-400">Порядок: {{ section.order }}</div>
                      </div>
                      <div class="flex flex-wrap items-center gap-2">
                        <form method="post" action="{% url 'catalog:checklist-section-move' section.pk %}" class="inline-flex">
                          {% csrf_token %}
                          <input type="hidden" name="direction" value="up" />
                          <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                          <button type="submit" class="btn btn--ghost text-xs" aria-label="Переместить вверх">↑</button>
                        </form>
                        <form method="post" action="{% url 'catalog:checklist-section-move' section.pk %}" class="inline-flex">
                          {% csrf_token %}
                          <input type="hidden" name="direction" value="down" />
                          <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                          <button type="submit" class="btn btn--ghost text-xs" aria-label="Переместить вниз">↓</button>
                        </form>
                        <a href="{% url 'catalog:checklist-section-update' section.pk %}" class="btn btn--secondary text-xs px-3 py-1">Редактировать</a>
                        <a href="{% url 'catalog:checklist-section-delete' section.pk %}" class="btn btn--danger text-xs px-3 py-1">Удалить</a>
                        <a href="{% url 'catalog:checklist-question-create' section.pk %}" class="btn btn--primary text-xs px-3 py-1">Добавить вопрос</a>
                      </div>
                    </div>
                    <div class="mt-4 space-y-3">
                      {% with questions=section.questions.all %}
                        {% if questions %}
                          {% for question in questions %}
                          <div class="rounded-lg border border-border-subtle bg-white p-4">
                            <div class="flex flex-col gap-3 border-b border-border-subtle pb-3 md:flex-row md:items-start md:justify-between">
                              <div class="space-y-2">
                                <div class="text-sm font-semibold text-ink-900">{{ question.text }}</div>
                                <div class="text-xs text-ink-500">
                                  Тип: {{ question.get_type_display }}{% if question.type == 'score' %} · Максимальный балл: {{ question.max_score }}{% endif %}
                                  {% if question.requires_comment %} · Комментарий обязателен{% endif %}
                                </div>
                                {% if question.guideline %}
                                  <div class="rounded border border-border-subtle bg-surface-elevated p-2 text-xs text-ink-600">
                                    {{ question.guideline }}
                                  </div>
                                {% endif %}
                                <div class="text-xs text-ink-400">Порядок: {{ question.order }}</div>
                              </div>
                              <div class="flex flex-wrap items-center gap-2">
                                <form method="post" action="{% url 'catalog:checklist-question-move' question.pk %}" class="inline-flex">
                                  {% csrf_token %}
                                  <input type="hidden" name="direction" value="up" />
                                  <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                                  <button type="submit" class="btn btn--ghost text-xs" aria-label="Переместить вверх">↑</button>
                                </form>
                                <form method="post" action="{% url 'catalog:checklist-question-move' question.pk %}" class="inline-flex">
                                  {% csrf_token %}
                                  <input type="hidden" name="direction" value="down" />
                                  <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                                  <button type="submit" class="btn btn--ghost text-xs" aria-label="Переместить вниз">↓</button>
                                </form>
                                <a href="{% url 'catalog:checklist-question-update' question.pk %}" class="btn btn--secondary text-xs px-3 py-1">Редактировать</a>
                                <a href="{% url 'catalog:checklist-question-delete' question.pk %}" class="btn btn--danger text-xs px-3 py-1">Удалить</a>
                                {% if question.type == 'score' %}
                                  <a href="{% url 'catalog:checklist-option-create' question.pk %}" class="btn btn--primary text-xs px-3 py-1">Добавить вариант</a>
                                {% endif %}
                              </div>
                            </div>
                            {% if question.type == 'score' %}
                              <div class="mt-3 space-y-2">
                                {% with options=question.score_options.all %}
                                  {% if options %}
                                    {% for option in options %}
                                    <div class="flex flex-col gap-2 rounded-lg border border-border-subtle bg-surface-subtle p-3 md:flex-row md:items-center md:justify-between">
                                      <div>
                                        <span class="font-semibold text-ink-900">{{ option.score }} балл{% if option.score != 1 %}ов{% endif %}</span>
                                        <span class="ml-2 text-xs text-ink-600">{{ option.description }}</span>
                                        <span class="ml-2 text-xs text-ink-400">Порядок: {{ option.order }}</span>
                                      </div>
                                      <div class="flex flex-wrap items-center gap-2">
                                        <form method="post" action="{% url 'catalog:checklist-option-move' option.pk %}" class="inline-flex">
                                          {% csrf_token %}
                                          <input type="hidden" name="direction" value="up" />
                                          <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                                          <button type="submit" class="btn btn--ghost text-xs" aria-label="Переместить вверх">↑</button>
                                        </form>
                                        <form method="post" action="{% url 'catalog:checklist-option-move' option.pk %}" class="inline-flex">
                                          {% csrf_token %}
                                          <input type="hidden" name="direction" value="down" />
                                          <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                                          <button type="submit" class="btn btn--ghost text-xs" aria-label="Переместить вниз">↓</button>
                                        </form>
                                        <a href="{% url 'catalog:checklist-option-update' option.pk %}" class="btn btn--secondary text-xs px-3 py-1">Редактировать</a>
                                        <a href="{% url 'catalog:checklist-option-delete' option.pk %}" class="btn btn--danger text-xs px-3 py-1">Удалить</a>
                                      </div>
                                    </div>
                                    {% endfor %}
                                  {% else %}
                                  <div class="rounded border border-warning-200 bg-warning-50 p-3 text-xs text-warning-700">
                                    Добавьте варианты оценок, чтобы аудитор мог выбрать значение.
                                  </div>
                                  {% endif %}
                                {% endwith %}
                              </div>
                            {% endif %}
                          </div>
                          {% endfor %}
                        {% else %}
                        <div class="rounded border border-dashed border-border-subtle p-4 text-xs text-ink-500">
                          В секции пока нет вопросов. Добавьте их, чтобы аудиторы видели этот блок в анкете.
                        </div>
                        {% endif %}
                      {% endwith %}
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                <div class="rounded border border-dashed border-border-subtle p-4 text-xs text-ink-500">
                  В категории пока нет секций. Создайте первую секцию, чтобы наполнить чек-лист вопросами.
                </div>
                {% endif %}
              {% endwith %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="rounded border border-dashed border-border-subtle p-6 text-center text-sm text-ink-500">
          Структура чек-листа ещё не создана. Добавьте первую категорию, чтобы начать.
        </div>
      {% endif %}
    </section>
    <section class="space-y-4">
      <div class="flex flex-col gap-2">
        <h2 class="text-lg font-semibold text-ink-900">Предпросмотр структуры</h2>
        <p class="text-xs text-ink-500">
          Снимок структуры используется офлайн-клиентами. {% if preview_generated_at %}Актуален на {{ preview_generated_at|date:"d.m.Y H:i" }}.{% endif %}
        </p>
      </div>
      {% if checklist_preview.categories %}
        <div class="space-y-4 rounded-2xl border border-border-subtle bg-surface-subtle p-5">
          {% for category in checklist_preview.categories %}
            <div class="space-y-2">
              <div class="font-semibold text-ink-900">{{ category.name }} ({{ category.code }})</div>
              {% if category.sections %}
                <ul class="space-y-2 pl-4">
                  {% for section in category.sections %}
                    <li>
                      <div class="font-medium text-ink-800">{{ section.title }}</div>
                      {% if section.questions %}
                        <ul class="mt-1 space-y-1 pl-4 text-xs text-ink-600">
                          {% for question in section.questions %}
                            <li>
                              {{ question.text }}
                              <span class="text-ink-400">({{ question.type }}{% if question.type == 'score' %}, max {{ question.max_score }}{% endif %})</span>
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <p class="text-xs text-ink-500">Нет вопросов.</p>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-xs text-ink-500">Нет секций.</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="rounded border border-dashed border-border-subtle p-4 text-xs text-ink-500">
          Предпросмотр недоступен, потому что структура ещё не создана.
        </div>
      {% endif %}
    </section>
  </div>
{% endblock %}
