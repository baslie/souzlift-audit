{% extends "base.html" %}
{% block title %}Справочник зданий · Союзлифт Аудит{% endblock %}
{% block header_links %}
  <a href="{% url 'accounts:dashboard' %}" class="text-slate-200 hover:text-white">Личный кабинет</a>
  <a href="{% url 'catalog:building-list' %}" class="font-semibold text-white">Здания</a>
  <a href="{% url 'catalog:elevator-list' %}" class="text-slate-200 hover:text-white">Лифты</a>
  <a href="{% url 'accounts:logout' %}" class="text-slate-200 hover:text-white">Выйти</a>
{% endblock %}
{% block heading %}Справочник зданий{% endblock %}
{% block subheading %}
  <p class="text-sm text-slate-500">
    Управляйте карточками зданий, добавляйте новые адреса и отслеживайте их статус модерации.
  </p>
{% endblock %}
{% block actions %}
  <a
    href="{% url 'catalog:building-create' %}"
    class="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-700"
  >
    Добавить здание
  </a>
{% endblock %}
{% block content %}
  <form method="get" class="mb-6 grid gap-4 md:grid-cols-[minmax(0,2fr)_minmax(0,1fr)_auto] md:items-end">
    <div>
      <label for="id-search" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Поиск</label>
      <input
        type="search"
        id="id-search"
        name="{{ search_param }}"
        value="{{ search_query }}"
        placeholder="Введите часть адреса или примечания"
        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200"
      />
    </div>
    <div>
      <label for="id-status" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Статус</label>
      <select
        id="id-status"
        name="{{ status_param }}"
        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200"
      >
        {% for value, label in status_choices %}
          <option value="{{ value }}" {% if value == selected_status %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="flex gap-2">
      <button
        type="submit"
        class="inline-flex items-center rounded-lg bg-slate-800 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-900"
      >
        Применить
      </button>
      <a
        href="{% url 'catalog:building-list' %}"
        class="inline-flex items-center rounded-lg border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50"
      >
        Сбросить
      </a>
    </div>
  </form>

  {% if object_list %}
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-500">
          <tr>
            <th scope="col" class="px-4 py-3 text-left font-semibold">Адрес</th>
            <th scope="col" class="px-4 py-3 text-left font-semibold">Статус</th>
            <th scope="col" class="px-4 py-3 text-left font-semibold">Автор</th>
            <th scope="col" class="px-4 py-3 text-left font-semibold">Подтвердил</th>
            <th scope="col" class="px-4 py-3 text-left font-semibold">Действия</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200 bg-white">
          {% for building in object_list %}
            <tr class="align-top">
              <td class="px-4 py-4">
                <div class="font-semibold text-slate-900">{{ building.address }}</div>
                {% if building.entrance %}
                  <div class="text-xs text-slate-500">Подъезд: {{ building.entrance }}</div>
                {% endif %}
                <div class="mt-1 text-xs text-slate-400">Создано {{ building.created_at|date:"d.m.Y H:i" }}</div>
                {% if building.notes %}
                  <div class="mt-2 rounded border border-slate-200 bg-slate-50 p-2 text-xs text-slate-600">
                    {{ building.notes }}
                  </div>
                {% endif %}
              </td>
              <td class="px-4 py-4">
                {% if building.review_status == ReviewStatus.APPROVED %}
                  {% with "border-emerald-200 bg-emerald-50 text-emerald-800" as status_classes %}
                    <span class="inline-flex rounded-full border px-3 py-1 text-xs font-semibold {{ status_classes }}">
                      {{ building.get_review_status_display }}
                    </span>
                  {% endwith %}
                {% elif building.review_status == ReviewStatus.REJECTED %}
                  {% with "border-red-200 bg-red-50 text-red-800" as status_classes %}
                    <span class="inline-flex rounded-full border px-3 py-1 text-xs font-semibold {{ status_classes }}">
                      {{ building.get_review_status_display }}
                    </span>
                  {% endwith %}
                {% else %}
                  {% with "border-amber-200 bg-amber-50 text-amber-800" as status_classes %}
                    <span class="inline-flex rounded-full border px-3 py-1 text-xs font-semibold {{ status_classes }}">
                      {{ building.get_review_status_display }}
                    </span>
                  {% endwith %}
                {% endif %}
              </td>
              <td class="px-4 py-4">
                {% if building.created_by %}
                  <div class="font-medium text-slate-800">{{ building.created_by.profile.full_name|default:building.created_by.username }}</div>
                {% else %}
                  <div class="text-slate-400">—</div>
                {% endif %}
              </td>
              <td class="px-4 py-4">
                {% if building.verified_by %}
                  <div class="font-medium text-slate-800">{{ building.verified_by.profile.full_name|default:building.verified_by.username }}</div>
                  {% if building.verified_at %}
                    <div class="text-xs text-slate-500">{{ building.verified_at|date:"d.m.Y H:i" }}</div>
                  {% endif %}
                {% else %}
                  <div class="text-slate-400">—</div>
                {% endif %}
              </td>
              <td class="px-4 py-4">
                <div class="flex flex-col gap-2">
                  {% if can_moderate or building.created_by_id == request.user.id %}
                    {% if can_moderate or building.review_status != ReviewStatus.APPROVED %}
                      <a
                        href="{% url 'catalog:building-update' building.pk %}"
                        class="inline-flex items-center justify-center rounded border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50"
                      >
                        Редактировать
                      </a>
                    {% endif %}
                  {% endif %}
                  {% if can_moderate %}
                    <form method="post" action="{% url 'catalog:building-moderate' building.pk %}" class="flex flex-wrap gap-2">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                      <button
                        type="submit"
                        name="action"
                        value="approve"
                        class="inline-flex flex-1 items-center justify-center rounded bg-emerald-600 px-3 py-1 text-xs font-semibold text-white shadow-sm hover:bg-emerald-700"
                      >
                        Утвердить
                      </button>
                      <button
                        type="submit"
                        name="action"
                        value="reject"
                        class="inline-flex flex-1 items-center justify-center rounded bg-red-600 px-3 py-1 text-xs font-semibold text-white shadow-sm hover:bg-red-700"
                      >
                        Отклонить
                      </button>
                      {% if building.review_status != ReviewStatus.PENDING %}
                        <button
                          type="submit"
                          name="action"
                          value="return"
                          class="inline-flex flex-1 items-center justify-center rounded bg-amber-500 px-3 py-1 text-xs font-semibold text-white shadow-sm hover:bg-amber-600"
                        >
                          На проверку
                        </button>
                      {% endif %}
                    </form>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
      <div class="mt-6 flex items-center justify-between text-xs text-slate-600">
        <span>Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
        <div class="flex items-center gap-2">
          {% if page_obj.has_previous %}
            <a
              href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}"
              class="rounded border border-slate-300 px-3 py-1 font-semibold hover:bg-slate-50"
            >
              Назад
            </a>
          {% else %}
            <span class="rounded border border-slate-200 px-3 py-1 text-slate-300">Назад</span>
          {% endif %}
          {% if page_obj.has_next %}
            <a
              href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}"
              class="rounded border border-slate-300 px-3 py-1 font-semibold hover:bg-slate-50"
            >
              Вперёд
            </a>
          {% else %}
            <span class="rounded border border-slate-200 px-3 py-1 text-slate-300">Вперёд</span>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% else %}
    <p class="text-sm text-slate-600">Подходящих записей не найдено. Попробуйте изменить фильтры или добавьте новое здание.</p>
  {% endif %}
{% endblock %}

