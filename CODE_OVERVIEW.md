# Функциональный обзор системы «Союзлифт Аудит» (по исходному коду)

## Роли и разграничение доступа
* В системе определены две прикладные роли: **администратор** и **аудитор**. Роль хранится в профиле пользователя, вместе с контактами и отметкой о смене пароля, а свойства `is_admin`/`is_auditor` используются в проверках доступа.【F:backend/accounts/models.py†L9-L79】
* Базовые миксины `RoleRequiredMixin` и производные от него классы обеспечивают проверку роли при открытии представлений и ограничивают выборки объектов. Есть вспомогательная функция `restrict_queryset_for_user`, которая разрешает администраторам видеть все записи, а аудиторам — только собственные.【F:backend/accounts/permissions.py†L24-L138】
* Навигационное меню формируется контекст-процессором в зависимости от роли: администраторы видят разделы «Аудиты», «Мониторинг», «Справочники», «Чек-лист» и «Настройки», аудиторы — только «Мои аудиты», «Здания» и «Лифты».【F:backend/accounts/context_processors.py†L11-L126】

## Аутентификация и политика паролей
* Стандартные представления входа и выхода дополнены логикой, которая сразу перенаправляет пользователя на дашборд и требует сменить пароль, если профиль ещё не подтвердил его обновление.【F:backend/accounts/views.py†L23-L107】
* Промежуточный слой `ForcePasswordChangeMiddleware` перехватывает любые запросы авторизованных пользователей без отметки о смене пароля и принудительно отправляет их на соответствующую страницу, исключая статические файлы и служебные маршруты входа/выхода.【F:backend/accounts/middleware.py†L14-L60】

## Кабинет пользователя и навигация
* Шаблон дашборда показывает разные описания, быстрые ссылки и предупреждения в зависимости от роли: администратору предлагаются инструменты модерации, конструктора чек-листа и настройки вложений; аудитору — упор на офлайн-черновики и работу со справочниками без доступа к Django Admin.【F:backend/templates/accounts/dashboard.html†L1-L157】

## Справочники зданий и лифтов
* Модели `Building` и `Elevator` используют общую систему модерации со статусами «ожидает», «подтверждён», «отклонён», а менеджер `visible_for_user` скрывает неподтверждённые записи от сторонних пользователей.【F:backend/catalog/models.py†L10-L201】
* Списки зданий и лифтов поддерживают фильтрацию по статусу (включая «Созданные мной») и поиску, причём администраторам доступна модерация, а аудиторам — только собственные черновики.【F:backend/catalog/views.py†L47-L161】
* При редактировании пользователь без прав администратора может менять только собственные записи и автоматически возвращает их в очередь на проверку; утверждённые записи защищены от правок. Отдельные обработчики POST-запросов дают администраторам кнопки «утвердить», «отклонить» и «вернуть на проверку».【F:backend/catalog/views.py†L200-L323】

## Конструктор чек-листа
* Категории, секции, вопросы и варианты оценок хранятся в моделях с полем `order`, валидацией баллов и поддержкой флагов обязательного комментария или подсказок для аудита.【F:backend/catalog/models.py†L202-L366】
* Представления конструктора доступны только администраторам, обеспечивают сохранение порядка элементов, заголовки для форм, предпросмотр итоговой структуры и операции перемещения вверх/вниз. При создании автоматически назначается место в конце списка, а при удалении порядок пересортировывается.【F:backend/catalog/views.py†L384-L842】
* Обзор чек-листа показывает количество категорий/секций/вопросов и построенный по сервису `build_checklist_structure` предпросмотр с отметкой времени генерации.【F:backend/catalog/views.py†L493-L515】

## Настройки информационной карточки и лимитов вложений
* Раздел «Настройки» агрегирует список настраиваемых полей объекта (код, тип, обязательность, варианты выбора) и форму управления лимитами вложений. Администратор может обновить максимальный размер файла и количество вложений на ответ/аудит; изменения сохраняются в модели `AttachmentLimitConfiguration` и сбрасывают кэш значений.【F:backend/catalog/views.py†L844-L925】【F:backend/audits/models.py†L22-L173】

## Аудиторский процесс
* Модель `Audit` описывает жизненный цикл аудита (черновик → в работе → отправлен → просмотрен), автоматически фиксирует время начала/завершения, не допускает нелегальные переходы и ведёт журнал событий при создании и смене статуса.【F:backend/audits/models.py†L227-L585】
* Методы `start`, `submit`, `mark_reviewed` и `request_changes` обновляют статус, записывают акторов и публикуют события в `AuditLogEntry`. Запрос правок возможен только для отправленных аудитов и сопровождается почтовым уведомлением аудитору.【F:backend/audits/models.py†L477-L569】【F:backend/audits/emails.py†L35-L139】
* Ответы на вопросы (`AuditResponse`) и вложения (`AuditAttachment`) хранят баллы, комментарии, пометки, offline UUID, а при сохранении проверяют ограничения по размеру и количеству файлов, обновляют суммарный балл и журнал аудита.【F:backend/audits/models.py†L596-L912】

## Пользовательский портал аудитов
* `AuditListView` разрешает аудиторам и администраторам просматривать доступные им аудиты, фильтровать по статусу, периоду, поиску и (для админов) по состоянию проверки. Контекст формирует сводные карточки и сохраняет выбранные фильтры в querystring.【F:backend/audits/views.py†L65-L239】
* Шаблон списка предоставляет аудиторам офлайн-панель: создание черновиков, отображение локального статуса синхронизации и запуск отправки. Администраторы видят пояснения про проверку и работу без перехода в Django Admin.【F:backend/templates/audits/audit_list.html†L1-L200】
* Отдельные offline-страницы для карточки объекта и чек-листа работают в автономном режиме, выводят ограничения по вложениям, позволяют обновлять локальные справочники и сохранять данные в браузере.【F:backend/templates/audits/offline_object_info.html†L1-L147】【F:backend/templates/audits/offline_checklist.html†L1-L200】

## Просмотр, экспорт и вложения
* Базовый класс экспорта собирает аудит вместе с ответами и вложениями, проверяет доступ по роли и строит отчёт через `build_audit_report`. Административное представление отображает сводные показатели, объектную информацию, форму запроса правок и кнопки экспорта (печать, CSV, Excel).【F:backend/audits/views.py†L361-L757】【F:backend/templates/audits/admin_audit_detail.html†L1-L200】
* Экспорт в CSV и XLSX включает метаданные аудита, значения по каждому вопросу, комментарии, пометки и ссылки на вложения. Форматирование значений и преобразование отметок реализованы в наследуемых методах.【F:backend/audits/views.py†L699-L795】
* Вложения хранят защищённые ссылки: `AuditAttachment.get_download_url` формирует подписанный токен, а `AttachmentDownloadView` проверяет право доступа (администратор или автор аудита) и отдает файл с корректным типом содержимого.【F:backend/audits/models.py†L749-L918】【F:backend/audits/views.py†L240-L330】【F:backend/audits/tokens.py†L1-L25】

## Офлайн-синхронизация
* REST-эндпойнт `/api/offline-sync/` принимает JSON-пакеты с аудиторскими данными и multipart-запросы с вложениями. Он проверяет роль, предотвращает повторную обработку по хэшу, применяет данные в транзакции, обрабатывает ошибки валидации и возвращает обновлённый снимок каталога и чек-листа для клиента.【F:backend/audits/api.py†L28-L200】
* Каждая синхронизация фиксируется в `OfflineSyncBatch` со статусом (в обработке, применён, ошибка), хэшом payload, HTTP-кодом ответа, деталями ошибки и отметкой об отправке уведомления администраторам.【F:backend/audits/models.py†L1160-L1260】
* Страница мониторинга офлайн-пакетов предоставляет фильтры по дате, статусу и устройству, экспорт в CSV и выводит подробности ошибок и уведомлений. Для администраторов доступен также журнал действий с фильтрацией по дате, типу сущности и идентификатору аудита.【F:backend/audits/views.py†L800-L1010】【F:backend/templates/audits/offline_batch_list.html†L1-L120】
* Сервис-воркер кэширует ключевые страницы (аудиты, offline-формы, дашборд) и статические ресурсы, обслуживает запросы из кэша при отсутствии сети и использует offline fallback. Он отдаётся отдельным представлением `ServiceWorkerView` из статики проекта.【F:backend/static/js/service-worker.js†L1-L113】【F:backend/config/views.py†L10-L29】

## Журналы и мониторинг
* `AuditLogEntry` фиксирует события (создание и изменения аудитов, ответов, вложений, подписей, offline-пакетов), а пользовательский просмотрщик журналов умеет фильтровать по датам, сущности и конкретному аудиту, формировать CSV и обогащать выдачу ссылками на связанные записи через подзапросы.【F:backend/audits/models.py†L959-L1157】【F:backend/audits/views.py†L800-L940】

## Почтовые уведомления и административные инструменты
* При отправке аудита аудиторам автоматически уходят письма администраторам, а при просмотре или запросе правок — уведомления автору. Ошибки офлайн-синхронизации также транслируются администраторам по email.【F:backend/audits/emails.py†L35-L139】
* Вспомогательные функции аккаунтов позволяют получить список email-адресов активных администраторов и уведомить пользователя о создании учётной записи с временным паролем.【F:backend/accounts/emails.py†L1-L99】
